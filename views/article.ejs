<%- include('partials/article-head') %>
    <%- include('partials/admin-bar') %>

        <% if (typeof isPreview !=='undefined' && isPreview && !article.publicado) { %>
            <div
                style="background: linear-gradient(135deg, #FF6B00 0%, #FF8533 100%); color: white; padding: 15px 20px; text-align: center; font-weight: 600; box-shadow: 0 2px 8px rgba(255, 107, 0, 0.3); position: sticky; top: 0; z-index: 9998;">
                <i class="fas fa-eye"></i> MODO PREVIEW - Este post está em rascunho e não está visível publicamente
            </div>
            <% } %>

                <main class="main-content article-page">
                    <div class="container">
                        <nav class="breadcrumb">
                            <a href="/" class="breadcrumb-item">
                                <i class="fas fa-home"></i> Início
                            </a>
                            <span class="breadcrumb-separator">/</span>
                            <span class="breadcrumb-item active">
                                <%= article.titulo %>
                            </span>
                        </nav>

                        <div class="article-container">
                            <article class="article-full">
                                <div class="article-header">
                                    <span class="article-category <%= article.categoria %>">
                                        <%= categoryNames[article.categoria] || article.categoria %>
                                    </span>
                                    <h1 class="article-title">
                                        <%= article.titulo %>
                                    </h1>
                                    <p class="article-lead">
                                        <%= article.descricao %>
                                    </p>

                                    <div class="article-meta">
                                        <span class="article-author">
                                            <i class="fas fa-user"></i>
                                            <a href="/autor/<%= article.autor.toLowerCase().replace(/[^a-z0-9]+/g, '-') %>"
                                                style="color: inherit; text-decoration: none;">
                                                <%= article.autor %>
                                            </a>
                                        </span>
                                        <span class="article-date">
                                            <i class="fas fa-clock"></i>
                                            <%= new Date(article.dataPublicacao).toLocaleDateString('pt-BR', {
                                                day: '2-digit' , month: 'long' , year: 'numeric' , hour: '2-digit' ,
                                                minute: '2-digit' }) %>
                                        </span>
                                    </div>

                                    <div class="article-share">
                                        <a href="#" class="share-btn facebook" title="Facebook">
                                            <i class="fab fa-facebook-f"></i>
                                        </a>
                                        <a href="#" class="share-btn twitter" title="Twitter">
                                            <i class="fab fa-twitter"></i>
                                        </a>
                                        <a href="#" class="share-btn whatsapp" title="WhatsApp">
                                            <i class="fab fa-whatsapp"></i>
                                        </a>
                                        <a href="#" class="share-btn linkedin" title="LinkedIn">
                                            <i class="fab fa-linkedin-in"></i>
                                        </a>
                                    </div>
                                </div>

                                <div class="article-image-main">
                                    <img src="<%= article.imagem %>" alt="<%= article.titulo %>" fetchpriority="high"
                                        width="1200" height="630" style="width: 100%; height: auto;">
                                </div>

                                <%- article.conteudo %>

                                    <!-- Verificação de Fatos -->
                                    <div class="fact-check-section" id="factCheckSection">
                                        <div class="fact-check-header" onclick="toggleFactCheck()">
                                            <div class="fact-check-badge">
                                                <i class="fas fa-check"></i>
                                                <span>Notícia Verificada</span>
                                            </div>
                                            <div class="fact-check-status" id="factCheckStatus">
                                                <span class="status-text">Ver detalhes da verificação</span>
                                                <i class="fas fa-chevron-down" id="factCheckArrow"></i>
                                            </div>
                                        </div>
                                        <div class="fact-check-content" id="factCheckContent" style="display: none;">
                                            <div class="fact-check-loading" id="factCheckLoading">
                                                <div class="loading-spinner"></div>
                                                <p class="loading-status" id="loadingStatus">Iniciando verificação...
                                                </p>
                                                <div class="loading-steps">
                                                    <div class="loading-step" id="step1"><i class="fas fa-circle"></i>
                                                        Pesquisando em sites confiáveis</div>
                                                    <div class="loading-step" id="step2"><i class="fas fa-circle"></i>
                                                        Verificando em redes sociais</div>
                                                    <div class="loading-step" id="step3"><i class="fas fa-circle"></i>
                                                        Analisando fontes oficiais</div>
                                                    <div class="loading-step" id="step4"><i class="fas fa-circle"></i>
                                                        Processando com IA</div>
                                                </div>
                                            </div>
                                            <div class="fact-check-result" id="factCheckResult" style="display: none;">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="article-footer-share">
                                        <div class="share-box">
                                            <div class="share-box-header">
                                                <i class="fas fa-share-alt"></i>
                                                <h3>Gostou da notícia? Compartilhe!</h3>
                                            </div>
                                            <div class="article-share">
                                                <a href="#" class="share-btn facebook" title="Compartilhar no Facebook"
                                                    aria-label="Facebook">
                                                    <i class="fab fa-facebook-f"></i>
                                                </a>
                                                <a href="#" class="share-btn twitter" title="Compartilhar no Twitter"
                                                    aria-label="Twitter">
                                                    <i class="fab fa-twitter"></i>
                                                </a>
                                                <a href="#" class="share-btn whatsapp" title="Compartilhar no WhatsApp"
                                                    aria-label="WhatsApp">
                                                    <i class="fab fa-whatsapp"></i>
                                                </a>
                                                <a href="#" class="share-btn linkedin" title="Compartilhar no LinkedIn"
                                                    aria-label="LinkedIn">
                                                    <i class="fab fa-linkedin-in"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>

                        </div>

                        <script>
                            // Forçar Instagram a processar embeds após carregamento da página
                            if (window.instgrm) {
                                window.instgrm.Embeds.process();
                            } else {
                                // Se o script ainda não carregou, aguardar e processar
                                window.addEventListener('load', function () {
                                    setTimeout(function () {
                                        if (window.instgrm) {
                                            window.instgrm.Embeds.process();
                                        }
                                    }, 1000);
                                });
                            }
                        </script>

                        <% if (article.tags && article.tags.length> 0) { %>
                            <div class="article-tags">
                                <strong>Tags:</strong>
                                <% article.tags.forEach(tag=> { %>
                                    <span class="tag">#<%= tag %></span>
                                    <% }); %>
                            </div>
                            <% } %>
                                </article>

                                <!-- Seção de Comentários -->
                                <section class="comments-section">
                                    <h2 class="comments-title">
                                        <i class="fas fa-comments"></i> Comentários (<span id="commentCount">0</span>)
                                    </h2>

                                    <!-- Botão para expandir formulário -->
                                    <button class="btn-toggle-comment-form" id="btnToggleCommentForm"
                                        onclick="toggleCommentForm()">
                                        <i class="fas fa-plus-circle"></i> Deixe seu comentário
                                    </button>

                                    <!-- Comentários do Sistema -->
                                    <div id="sistema-comments" class="comment-tab-content active">
                                        <!-- Formulário de Novo Comentário (inicialmente oculto) -->
                                        <div class="comment-form-container" id="commentFormContainer"
                                            style="display: none;">
                                            <h3>
                                                <i class="fas fa-comment-dots"></i> Escreva seu comentário
                                            </h3>
                                            <form id="commentForm" onsubmit="submitComment(event)">
                                                <div class="form-row">
                                                    <div class="form-group">
                                                        <label for="commentNome">
                                                            <i class="fas fa-user"></i> Nome *
                                                        </label>
                                                        <input type="text" id="commentNome" name="nome" required
                                                            minlength="2" placeholder="Seu nome completo"
                                                            class="form-input">
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="commentEmail">
                                                            <i class="fas fa-envelope"></i> Email *
                                                        </label>
                                                        <input type="email" id="commentEmail" name="email" required
                                                            placeholder="seu@email.com" class="form-input">
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label for="commentTexto">
                                                        <i class="fas fa-comment"></i> Comentário *
                                                    </label>
                                                    <textarea id="commentTexto" name="comentario" required
                                                        minlength="10" rows="4"
                                                        placeholder="Escreva seu comentário aqui..."
                                                        class="form-textarea"></textarea>
                                                </div>
                                                <div class="form-row">
                                                    <div class="form-group">
                                                        <label for="commentCaptcha">
                                                            <i class="fas fa-shield-alt"></i> Digite "obuxixo" para
                                                            confirmar *
                                                        </label>
                                                        <input type="text" id="commentCaptcha" name="captcha" required
                                                            placeholder="obuxixo" class="form-input">
                                                    </div>
                                                </div>
                                                <button type="submit" class="btn-submit-comment" id="btnSubmitComment">
                                                    <i class="fas fa-paper-plane"></i> Enviar Comentário
                                                </button>
                                                <p class="form-note">
                                                    <i class="fas fa-info-circle"></i>
                                                    Seu comentário será analisado antes de ser publicado.
                                                </p>
                                            </form>
                                        </div>

                                        <!-- Lista de Comentários -->
                                        <div class="comments-list" id="commentsList">
                                            <div class="loading-comments">
                                                <i class="fas fa-spinner fa-spin"></i> Carregando comentários...
                                            </div>
                                        </div>
                                    </div>
                                </section>

                                <!-- Notícias Relacionadas -->
                                <% if (related && related.length> 0) { %>
                                    <section class="related-articles">
                                        <h2>Notícias Relacionadas</h2>
                                        <div class="related-grid">
                                            <% related.forEach(rel=> { %>
                                                <article class="news-card">
                                                    <a href="/<%= rel.categoria %>/<%= rel.urlAmigavel %>">
                                                        <div class="news-image">
                                                            <img src="<%= rel.imagem %>" alt="<%= rel.titulo %>"
                                                                loading="lazy" width="400" height="250">
                                                            <span class="news-category <%= rel.categoria %>">
                                                                <%= rel.categoria.toUpperCase() %>
                                                            </span>
                                                        </div>
                                                        <div class="news-content">
                                                            <h3 class="news-title">
                                                                <%= rel.titulo %>
                                                            </h3>
                                                            <p class="news-description">
                                                                <%= rel.descricao %>
                                                            </p>
                                                        </div>
                                                    </a>
                                                </article>
                                                <% }); %>
                                        </div>
                                    </section>
                                    <% } %>
                    </div>
                    </div>
                </main>

                <script>
                    const articleId = <%= article.id %>;

                    // Toggle do formulário de comentários
                    function toggleCommentForm() {
                        const container = document.getElementById('commentFormContainer');
                        const btn = document.getElementById('btnToggleCommentForm');

                        if (container.style.display === 'none') {
                            container.style.display = 'block';
                            btn.innerHTML = '<i class="fas fa-minus-circle"></i> Fechar formulário';
                            btn.classList.add('active');
                            // Scroll suave até o formulário
                            container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        } else {
                            container.style.display = 'none';
                            btn.innerHTML = '<i class="fas fa-plus-circle"></i> Deixe seu comentário';
                            btn.classList.remove('active');
                        }
                    }

                    // Carregar comentários do sistema
                    async function loadComments() {
                        try {
                            const response = await fetch(`/api/comments/${articleId}`);
                            const data = await response.json();

                            if (data.success) {
                                displayComments(data.comments);
                                document.getElementById('commentCount').textContent = data.comments.length;
                            }
                        } catch (error) {
                            console.error('Erro ao carregar comentários:', error);
                            document.getElementById('commentsList').innerHTML =
                                '<p class="error-message"><i class="fas fa-exclamation-circle"></i> Erro ao carregar comentários</p>';
                        }
                    }

                    // Exibir comentários
                    function displayComments(comments) {
                        const container = document.getElementById('commentsList');

                        if (comments.length === 0) {
                            container.innerHTML = '<p class="no-comments"><i class="fas fa-info-circle"></i> Nenhum comentário ainda. Seja o primeiro a comentar!</p>';
                            return;
                        }

                        container.innerHTML = comments.map(comment => `
            <div class="comment-item">
                <div class="comment-header">
                    <div class="comment-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="comment-info">
                        <strong class="comment-author">${escapeHtml(comment.nome)}</strong>
                        <span class="comment-date">
                            <i class="fas fa-clock"></i> 
                            ${formatDate(comment.created_at)}
                        </span>
                    </div>
                </div>
                <div class="comment-body">
                    ${escapeHtml(comment.comentario)}
                </div>
            </div>
        `).join('');
                    }

                    // Enviar comentário
                    async function submitComment(event) {
                        event.preventDefault();

                        const form = event.target;
                        const btn = document.getElementById('btnSubmitComment');
                        const originalText = btn.innerHTML;

                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

                        try {
                            const formData = {
                                nome: form.nome.value,
                                email: form.email.value,
                                comentario: form.comentario.value,
                                captcha: form.captcha.value
                            };

                            const response = await fetch(`/api/comments/${articleId}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(formData)
                            });

                            const data = await response.json();

                            if (data.success) {
                                alert('✅ ' + data.message);
                                form.reset();
                                await loadComments();
                            } else {
                                alert('❌ ' + data.error);
                            }
                        } catch (error) {
                            console.error('Erro ao enviar comentário:', error);
                            alert('❌ Erro ao enviar comentário. Tente novamente.');
                        } finally {
                            btn.disabled = false;
                            btn.innerHTML = originalText;
                        }
                    }

                    // Utilitários
                    function escapeHtml(text) {
                        const div = document.createElement('div');
                        div.textContent = text;
                        return div.innerHTML;
                    }

                    function formatDate(dateString) {
                        const date = new Date(dateString);
                        const now = new Date();
                        const diff = Math.floor((now - date) / 1000); // diferença em segundos

                        if (diff < 60) return 'Agora mesmo';
                        if (diff < 3600) return Math.floor(diff / 60) + ' minutos atrás';
                        if (diff < 86400) return Math.floor(diff / 3600) + ' horas atrás';
                        if (diff < 604800) return Math.floor(diff / 86400) + ' dias atrás';

                        return date.toLocaleDateString('pt-BR', {
                            day: '2-digit',
                            month: 'short',
                            year: 'numeric'
                        });
                    }

                    // Carregar comentários ao iniciar
                    document.addEventListener('DOMContentLoaded', function () {
                        loadComments();
                    });

                    // ===== VERIFICAÇÃO DE FATOS =====
                    let factCheckLoaded = false;
                    let factCheckExpanded = false;

                    function toggleFactCheck() {
                        const content = document.getElementById('factCheckContent');
                        const arrow = document.getElementById('factCheckArrow');

                        factCheckExpanded = !factCheckExpanded;

                        if (factCheckExpanded) {
                            content.style.display = 'block';
                            arrow.classList.add('rotated');

                            if (!factCheckLoaded) {
                                loadFactCheck();
                            }
                        } else {
                            content.style.display = 'none';
                            arrow.classList.remove('rotated');
                        }
                    }

                    async function loadFactCheck() {
                        const loading = document.getElementById('factCheckLoading');
                        const result = document.getElementById('factCheckResult');
                        const status = document.getElementById('factCheckStatus');

                        // Animação de progresso
                        const steps = ['step1', 'step2', 'step3', 'step4'];
                        const messages = [
                            'Pesquisando em sites confiáveis...',
                            'Verificando em redes sociais...',
                            'Analisando fontes oficiais...',
                            'Processando com Inteligência Artificial...'
                        ];

                        let currentStep = 0;
                        const progressInterval = setInterval(() => {
                            if (currentStep < steps.length) {
                                // Marcar step atual como ativo
                                document.getElementById(steps[currentStep]).classList.add('active');
                                document.getElementById('loadingStatus').textContent = messages[currentStep];
                                currentStep++;
                            }
                        }, 1500);

                        try {
                            const response = await fetch(`/api/factcheck/${articleId}`);
                            const data = await response.json();

                            clearInterval(progressInterval);
                            // Marcar todos os steps como completos
                            steps.forEach(s => {
                                document.getElementById(s).classList.add('completed');
                            });

                            setTimeout(() => {
                                loading.style.display = 'none';
                                result.style.display = 'block';
                                factCheckLoaded = true;

                                if (data.success) {
                                    renderFactCheckResult(data.data);
                                    updateFactCheckStatus(data.data);
                                } else {
                                    result.innerHTML = `
                                        <div class="fact-check-error">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <p>Não foi possível verificar os fatos desta notícia no momento.</p>
                                        </div>
                                    `;
                                }
                            }, 500);
                        } catch (error) {
                            clearInterval(progressInterval);
                            console.error('Erro na verificação:', error);
                            loading.style.display = 'none';
                            result.style.display = 'block';
                            result.innerHTML = `
                                <div class="fact-check-error">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <p>Erro ao conectar com o serviço de verificação.</p>
                                </div>
                            `;
                        }
                    }

                    function updateFactCheckStatus(data) {
                        const status = document.getElementById('factCheckStatus');
                        const statusClass = data.confianca >= 70 ? 'verified' : data.confianca >= 40 ? 'partial' : 'unverified';
                        const statusIcon = data.confianca >= 70 ? 'check-circle' : data.confianca >= 40 ? 'exclamation-circle' : 'times-circle';
                        const statusText = data.confianca >= 70 ? 'Verificado' : data.confianca >= 40 ? 'Parcialmente verificado' : 'Não verificado';

                        status.innerHTML = `
                            <span class="status-badge ${statusClass}">
                                <i class="fas fa-${statusIcon}"></i> ${statusText}
                            </span>
                            <i class="fas fa-chevron-down rotated" id="factCheckArrow"></i>
                        `;
                    }

                    function renderFactCheckResult(data) {
                        const result = document.getElementById('factCheckResult');

                        const confiancaClass = data.confianca >= 70 ? 'high' : data.confianca >= 40 ? 'medium' : 'low';

                        let factsHtml = '';
                        if (data.fatos && data.fatos.length > 0) {
                            factsHtml = data.fatos.map(fato => {
                                const statusIcon = fato.status === 'confirmado' ? 'check' : fato.status === 'parcial' ? 'minus' : 'question';
                                const statusClass = fato.status === 'confirmado' ? 'confirmed' : fato.status === 'parcial' ? 'partial' : 'unconfirmed';
                                return `
                                    <div class="fact-item ${statusClass}">
                                        <div class="fact-icon">
                                            <i class="fas fa-${statusIcon}"></i>
                                        </div>
                                        <div class="fact-content">
                                            <p class="fact-claim">${escapeHtml(fato.afirmacao)}</p>
                                            <p class="fact-explanation">${escapeHtml(fato.explicacao)}</p>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        }

                        // Gerar HTML das fontes
                        let fontesHtml = '';
                        if (data.fontes && data.fontes.length > 0) {
                            fontesHtml = data.fontes.map(fonte => `
                                <div class="source-item">
                                    <i class="fas fa-external-link-alt"></i>
                                    <a href="${fonte.url}" target="_blank" rel="noopener noreferrer">${escapeHtml(fonte.titulo)}</a>
                                </div>
                            `).join('');
                        }

                        result.innerHTML = `
                            <div class="fact-check-summary">
                                <div class="confidence-meter">
                                    <div class="confidence-label">
                                        <span>Índice de Confiabilidade</span>
                                        <strong class="${confiancaClass}">${data.confianca}%</strong>
                                    </div>
                                    <div class="confidence-bar">
                                        <div class="confidence-fill ${confiancaClass}" style="width: ${data.confianca}%"></div>
                                    </div>
                                </div>
                                <p class="fact-check-resumo">${escapeHtml(data.resumo)}</p>
                            </div>
                            
                            ${factsHtml ? `<div class="facts-list"><h4><i class="fas fa-check-double"></i> Fatos Confirmados</h4>${factsHtml}</div>` : ''}
                            
                            ${data.observacoes ? `
                            <div class="fact-check-observations">
                                <h4><i class="fas fa-info-circle"></i> Observações</h4>
                                <p>${escapeHtml(data.observacoes)}</p>
                            </div>
                            ` : ''}
                            
                            <div class="fact-check-conclusion">
                                <h4><i class="fas fa-check-circle"></i> Conclusão</h4>
                                <p>${escapeHtml(data.conclusao)}</p>
                            </div>
                            
                            ${fontesHtml ? `
                            <div class="fact-check-sources">
                                <h4><i class="fas fa-link"></i> Fontes Consultadas</h4>
                                <div class="sources-list">
                                    ${fontesHtml}
                                </div>
                            </div>
                            ` : ''}
                            
                            <div class="fact-check-footer">
                                <small>
                                    <i class="fas fa-search"></i> ${data.fontesConsultadas} fontes analisadas |
                                    <i class="fas fa-clock"></i> Verificado em ${new Date(data.dataVerificacao).toLocaleDateString('pt-BR')}
                                </small>
                            </div>
                        `;
                    }
                </script>

                <!-- Script para animar sublinhado dos links internos -->
                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        // Selecionar todos os links internos
                        const internalLinks = document.querySelectorAll('.internal-link');

                        if (internalLinks.length > 0 && 'IntersectionObserver' in window) {
                            // Usar Intersection Observer para animar quando o link aparecer na tela
                            const observer = new IntersectionObserver((entries) => {
                                entries.forEach(entry => {
                                    if (entry.isIntersecting) {
                                        // Adicionar classe de animação com pequeno delay
                                        setTimeout(() => {
                                            entry.target.classList.add('animate-underline');
                                        }, 100);
                                        // Parar de observar após animar
                                        observer.unobserve(entry.target);
                                    }
                                });
                            }, {
                                threshold: 0.5,
                                rootMargin: '0px 0px -50px 0px'
                            });

                            // Observar cada link
                            internalLinks.forEach(link => {
                                // Remover sublinhado inicial para animar depois
                                link.style.backgroundSize = '0% 2px';
                                observer.observe(link);
                            });
                        } else {
                            // Fallback: mostrar todos sublinhados
                            internalLinks.forEach(link => {
                                link.classList.add('animate-underline');
                            });
                        }
                    });
                </script>

                <%- include('partials/footer') %>