<%- include('../partials/header', { title: isEdit ? 'Editar Post' : 'Novo Post' , user: user }) %>

    <!-- Quill Editor CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/quill@1.3.6/dist/quill.snow.css" rel="stylesheet">

    <div class="dashboard-content">
        <div class="content-header">
            <div>
                <h1>
                    <%= isEdit ? 'Editar Post' : 'Novo Post' %>
                </h1>
                <p>
                    <%= isEdit ? 'Atualize as informa√ß√µes do post' : 'Crie um novo artigo para o portal' %>
                </p>
            </div>
            <div class="header-actions">
                <a href="/dashboard/posts" class="btn btn-secondary">
                    ‚Üê Voltar
                </a>
            </div>
        </div>

        <form action="<%= isEdit ? `/dashboard/posts/editar/${article.id}` : '/dashboard/posts/criar' %>" method="POST"
            class="post-form" onsubmit="return prepareSubmit()">
            <div class="form-grid">
                <!-- Coluna Principal -->
                <div class="form-main">
                    <div class="card">
                        <div class="card-body">
                            <div class="form-group">
                                <label for="titulo">T√≠tulo *</label>
                                <div class="input-with-ai">
                                    <input type="text" id="titulo" name="titulo" class="form-control"
                                        value="<%= isEdit ? article.titulo : '' %>"
                                        placeholder="Digite o t√≠tulo do post..." required>
                                    <div class="ai-dropdown-wrapper">
                                        <button type="button" class="btn-ai-small"
                                            onclick="toggleAIDropdownField('titulo')" title="Op√ß√µes de IA">
                                            ‚ú®
                                        </button>
                                        <div class="ai-dropdown-menu" id="aiDropdownTitulo">
                                            <button type="button" class="ai-dropdown-item"
                                                onclick="aplicarIACampo('titulo', 'corrigir')">
                                                <i class="fas fa-check-circle"></i> Corrigir Portugu√™s
                                            </button>
                                            <button type="button" class="ai-dropdown-item"
                                                onclick="aplicarIACampo('titulo', 'polemico')">
                                                <i class="fas fa-fire"></i> Deixar mais pol√™mico
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="descricao">Descri√ß√£o *</label>
                                <div class="input-with-ai">
                                    <textarea id="descricao" name="descricao" class="form-control" rows="3"
                                        placeholder="Resumo que aparece nas listagens..."
                                        required><%= isEdit ? article.descricao : '' %></textarea>
                                    <div class="ai-dropdown-wrapper">
                                        <button type="button" class="btn-ai-small"
                                            onclick="toggleAIDropdownField('descricao')" title="Op√ß√µes de IA">
                                            ‚ú®
                                        </button>
                                        <div class="ai-dropdown-menu" id="aiDropdownDescricao">
                                            <button type="button" class="ai-dropdown-item"
                                                onclick="aplicarIACampo('descricao', 'corrigir')">
                                                <i class="fas fa-check-circle"></i> Corrigir Portugu√™s
                                            </button>
                                            <button type="button" class="ai-dropdown-item"
                                                onclick="aplicarIACampo('descricao', 'polemico')">
                                                <i class="fas fa-fire"></i> Deixar mais pol√™mico
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Conte√∫do *</label>
                                <div class="editor-toolbar-custom">
                                    <div class="editor-toolbar-left">
                                        <button type="button" class="btn-insert-media"
                                            onclick="openMediaLibrary('content')">
                                            <i class="fas fa-images"></i> Inserir M√≠dia
                                        </button>
                                        <div class="btn-ai-dropdown">
                                            <button type="button" class="btn-ai-correct"
                                                onclick="toggleAIDropdown(event)">
                                                ‚ú® Corrigir com IA <i class="fas fa-caret-down"></i>
                                            </button>
                                            <div class="ai-dropdown-menu" id="aiDropdownMenu">
                                                <button type="button" class="ai-dropdown-item"
                                                    onclick="corrigirConteudo('corrigir')">
                                                    <i class="fas fa-spell-check"></i> Corrigir Erros de Portugu√™s
                                                </button>
                                                <button type="button" class="ai-dropdown-item"
                                                    onclick="corrigirConteudo('reescrever')">
                                                    <i class="fas fa-sync-alt"></i> Reescrever Mat√©ria (Estilo G1)
                                                </button>
                                            </div>
                                        </div>
                                        <button type="button" class="btn-ai-enhance"
                                            onclick="abrirModalAcrescentarInfo()">
                                            <i class="fas fa-plus-circle"></i> Acrescentar Informa√ß√£o
                                        </button>
                                        <button type="button" class="btn-ai-assistant" onclick="abrirAssistenteIA()">
                                            <i class="fas fa-robot"></i> Assistente IA
                                        </button>
                                    </div>
                                    <div class="editor-mode-toggle">
                                        <button type="button" class="mode-btn active" data-mode="visual"
                                            onclick="toggleEditorMode('visual')">
                                            <i class="fas fa-eye"></i> Visual
                                        </button>
                                        <button type="button" class="mode-btn" data-mode="code"
                                            onclick="toggleEditorMode('code')">
                                            <i class="fas fa-code"></i> C√≥digo
                                        </button>
                                    </div>
                                </div>
                                <div id="editor" style="height: 400px; background: white;"></div>
                                <textarea id="conteudo" name="conteudo" class="form-control code-editor"
                                    style="display: none; height: 400px; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;"><%= isEdit ? article.conteudo : '' %></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="form-sidebar">
                    <!-- Bot√£o Criar com IA -->
                    <button type="button" class="btn btn-ai-sidebar" onclick="openAIModal()">
                        ü§ñ Criar com IA
                    </button>

                    <!-- Publica√ß√£o -->
                    <div class="card">
                        <div class="card-header">
                            <h3>Publica√ß√£o</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-check">
                                <label>
                                    <input type="checkbox" id="publicadoCheckbox" name="publicado" value="true"
                                        <%=isEdit && article.publicado ? 'checked' : '' %>
                                    >
                                    <span>Publicar imediatamente</span>
                                </label>
                            </div>

                            <div class="form-check">
                                <label>
                                    <input type="checkbox" name="destaque" value="true" <%=isEdit && article.destaque
                                        ? 'checked' : '' %>
                                    >
                                    <span>Marcar como destaque</span>
                                </label>
                            </div>

                            <div class="form-group" style="margin-top: 16px;">
                                <label for="dataPublicacao">
                                    <i class="fas fa-calendar-alt"></i> Data e Hora de Publica√ß√£o (Hor√°rio de Bras√≠lia)
                                </label>
                                <input type="datetime-local" id="dataPublicacao" name="dataPublicacao"
                                    class="form-control" value="<%= 
                                    (() => {
                                        const data = isEdit && article.dataPublicacao ? new Date(article.dataPublicacao) : new Date();
                                        // Ajustar para hor√°rio de Bras√≠lia (UTC-3)
                                        // Subtrair 3 horas do UTC para obter hor√°rio de Bras√≠lia
                                        const offsetBrasilia = -3 * 60 * 60 * 1000; // -3 horas em milissegundos
                                        const dataBrasilia = new Date(data.getTime() + offsetBrasilia);
                                        // Formatar para datetime-local (YYYY-MM-DDTHH:mm)
                                        const year = dataBrasilia.getUTCFullYear();
                                        const month = String(dataBrasilia.getUTCMonth() + 1).padStart(2, '0');
                                        const day = String(dataBrasilia.getUTCDate()).padStart(2, '0');
                                        const hours = String(dataBrasilia.getUTCHours()).padStart(2, '0');
                                        const minutes = String(dataBrasilia.getUTCMinutes()).padStart(2, '0');
                                        return `${year}-${month}-${day}T${hours}:${minutes}`;
                                    })()
                                %>">
                                <div id="agendamentoStatus"
                                    style="margin-top: 8px; padding: 8px 12px; border-radius: 6px; font-size: 12px; display: none;">
                                    <i class="fas fa-clock"></i> <span id="agendamentoTexto"></span>
                                </div>
                                <small style="color: #666; font-size: 12px; margin-top: 4px; display: block;">
                                    <i class="fas fa-info-circle"></i> <strong>Agendamento:</strong> Escolha uma
                                    data/hora futura para agendar a publica√ß√£o autom√°tica
                                </small>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 16px;">
                                <button type="button" class="btn btn-secondary btn-sm" onclick="salvarRascunho()">
                                    <i class="fas fa-file"></i> Rascunho
                                </button>
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i class="fas fa-paper-plane"></i>
                                    <%= isEdit ? 'Atualizar' : 'Publicar' %>
                                </button>
                            </div>

                            <!-- Botao Verificar Fatos -->
                            <button type="button" class="btn btn-factcheck" onclick="verificarFatosMateria()">
                                <i class="fas fa-search"></i> Verificar Fatos
                            </button>

                            <% if (isEdit && article.categoria && article.urlAmigavel) { %>
                                <a href="/<%= article.categoria %>/<%= article.urlAmigavel %>?preview=true"
                                    target="_blank" class="btn btn-secondary btn-block btn-sm" style="margin-top: 8px;">
                                    <i class="fas fa-eye"></i> Visualizar
                                </a>
                                <% } %>
                        </div>
                    </div>

                    <!-- Categoria -->
                    <div class="card">
                        <div class="card-header">
                            <h3>Categoria</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label for="categoria">Categoria *</label>
                                <select id="categoria" name="categoria" class="form-control" required>
                                    <option value="">Selecione uma categoria...</option>
                                    <% if (typeof categories !=='undefined' && categories.length> 0) { %>
                                        <% categories.forEach(cat=> { %>
                                            <option value="<%= cat.slug %>" <%=isEdit && article.categoria===cat.slug
                                                ? 'selected' : '' %>>
                                                <%= cat.nome %>
                                            </option>
                                            <% }); %>
                                                <% } %>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="subcategoria">Subcategoria</label>
                                <input type="text" id="subcategoria" name="subcategoria" class="form-control"
                                    value="<%= isEdit && article.subcategoria ? article.subcategoria : '' %>"
                                    placeholder="Ex: Lan√ßamentos, Eventos...">
                            </div>
                        </div>
                    </div>

                    <!-- Imagem Destaque -->
                    <div class="card">
                        <div class="card-header">
                            <h3>Imagem Destaque</h3>
                        </div>
                        <div class="card-body">
                            <button type="button" class="btn btn-primary btn-block" onclick="openMediaLibrary()">
                                <i class="fas fa-images"></i> Selecionar da Biblioteca
                            </button>

                            <!-- Campo Hidden -->
                            <input type="hidden" id="imagem" name="imagem" value="<%= isEdit ? article.imagem : '' %>"
                                required>

                            <!-- Preview -->
                            <div class="image-preview" id="imagePreview"
                                style="<%= isEdit && article.imagem ? '' : 'display: none;' %>">
                                <img src="<%= isEdit ? article.imagem : '' %>" alt="Preview" id="previewImg">
                                <button type="button" class="btn-remove" onclick="removeImage()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Autor -->
                    <div class="card">
                        <div class="card-header">
                            <h3>Autor</h3>
                            <div class="card-body">
                                <div class="form-check" style="margin-bottom: 12px;">
                                    <label>
                                        <input type="checkbox" id="isFactCheck" name="isFactCheck" value="true"
                                            onchange="toggleFactCheckFields()" <%=isEdit && article.factCheck &&
                                            article.factCheck.claim ? 'checked' : '' %>>
                                        <span>Este artigo √© uma verifica√ß√£o de fatos</span>
                                    </label>
                                </div>

                                <div id="factCheckFields"
                                    style="display: <%= isEdit && article.factCheck && article.factCheck.claim ? 'block' : 'none' %>;">
                                    <div class="form-group">
                                        <label for="factCheckClaim">Afirma√ß√£o verificada *</label>
                                        <textarea id="factCheckClaim" name="factCheckClaim" class="form-control"
                                            rows="2"
                                            placeholder="Ex: Pastor X afirmou que vai chover dinheiro..."><%= isEdit && article.factCheck ? (article.factCheck.claim || '') : '' %></textarea>
                                        <small style="color: #666;">A afirma√ß√£o/boato que est√° sendo verificado</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="factCheckAuthor">Quem fez a afirma√ß√£o</label>
                                        <input type="text" id="factCheckAuthor" name="factCheckAuthor"
                                            class="form-control" placeholder="Ex: Pastor X, Site Y, WhatsApp..."
                                            value="<%= isEdit && article.factCheck ? (article.factCheck.claimAuthor || '') : '' %>">
                                    </div>

                                    <div class="form-group">
                                        <label for="factCheckAuthorType">Tipo do autor</label>
                                        <select id="factCheckAuthorType" name="factCheckAuthorType"
                                            class="form-control">
                                            <option value="Person" <%=isEdit && article.factCheck &&
                                                article.factCheck.claimAuthorType==='Person' ? 'selected' : '' %>>Pessoa
                                            </option>
                                            <option value="Organization" <%=isEdit && article.factCheck &&
                                                article.factCheck.claimAuthorType==='Organization' ? 'selected' : '' %>
                                                >Organiza√ß√£o/Site</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label for="factCheckRating">Veredito *</label>
                                        <select id="factCheckRating" name="factCheckRating" class="form-control">
                                            <option value="1" <%=isEdit && article.factCheck &&
                                                article.factCheck.rating==1 ? 'selected' : '' %>>‚ùå Falso</option>
                                            <option value="2" <%=isEdit && article.factCheck &&
                                                article.factCheck.rating==2 ? 'selected' : '' %>>‚ö†Ô∏è Majoritariamente
                                                Falso</option>
                                            <option value="3" <%=isEdit && article.factCheck &&
                                                article.factCheck.rating==3 ? 'selected' : '' %>>üî∂ Parcialmente
                                                Verdadeiro</option>
                                            <option value="4" <%=isEdit && article.factCheck &&
                                                article.factCheck.rating==4 ? 'selected' : '' %>>‚úÖ Majoritariamente
                                                Verdadeiro</option>
                                            <option value="5" <%=isEdit && article.factCheck &&
                                                article.factCheck.rating==5 ? 'selected' : '' %>>‚úÖ Verdadeiro</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        </form>
    </div>

    <!-- Modal Criar com IA -->
    <div id="aiModal" class="modal">
        <div class="modal-content modal-ai">
            <div class="modal-header">
                <h2>ü§ñ Criar Mat√©ria com IA</h2>
                <button type="button" class="modal-close" onclick="closeAIModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Tabs -->
            <div class="ai-tabs">
                <button type="button" class="ai-tab-btn active" onclick="switchAITab('tema')">
                    <i class="fas fa-lightbulb"></i> Por Tema
                </button>
                <button type="button" class="ai-tab-btn" onclick="switchAITab('conteudo')">
                    <i class="fas fa-file-alt"></i> Por Conte√∫do
                </button>
                <button type="button" class="ai-tab-btn" onclick="switchAITab('link')">
                    <i class="fas fa-link"></i> Por Link
                </button>
            </div>

            <div class="modal-body">
                <!-- Tab Por Tema -->
                <div class="ai-form ai-tab-content active" id="ai-tab-tema">
                    <div class="form-group">
                        <label for="aiTema">Tema da Mat√©ria *</label>
                        <input type="text" id="aiTema" class="form-control" placeholder="Ex: Silas Malafaia critica PT">
                        <small class="form-text">Descreva o tema principal da mat√©ria</small>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="aiModoAutomatico" checked>
                            üöÄ Modo Autom√°tico (Recomendado)
                        </label>
                        <small class="form-text">A IA faz tudo: pesquisa informa√ß√µes, busca e seleciona imagem
                            automaticamente</small>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="aiPesquisarInternet" checked style="width: 18px; height: 18px;">
                            <span>üåê Pesquisar Informa√ß√µes na Internet (Recomendado)</span>
                        </label>
                        <small class="form-text" style="color: #059669; font-weight: 500;">
                            <i class="fas fa-check-circle"></i> A IA buscar√° not√≠cias atuais no Google News e
                            informa√ß√µes no DuckDuckGo para criar uma mat√©ria baseada em FATOS REAIS
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="aiLinks">Links de Refer√™ncia (opcional)</label>
                        <textarea id="aiLinks" class="form-control" rows="3"
                            placeholder="Cole links de not√≠cias, artigos ou Instagram (um por linha)&#10;Ex: https://www.instagram.com/p/ABC123/"></textarea>
                        <small class="form-text">‚ú® Suporta Instagram! A IA extrair√° texto da postagem + coment√°rios para
                            criar a mat√©ria</small>
                    </div>

                    <div class="form-group">
                        <label for="aiCategoria">Categoria</label>
                        <select id="aiCategoria" class="form-control">
                            <option value="Not√≠cias">Not√≠cias</option>
                            <option value="M√∫sica">M√∫sica</option>
                            <option value="Eventos">Eventos</option>
                            <option value="Minist√©rios">Minist√©rios</option>
                            <option value="Estudos">Estudos</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="aiPalavrasChave">Palavras-chave (opcional)</label>
                        <input type="text" id="aiPalavrasChave" class="form-control"
                            placeholder="Ex: louvor, adora√ß√£o, gospel">
                        <small class="form-text">Palavras-chave separadas por v√≠rgula</small>
                    </div>

                    <div class="form-group">
                        <label for="aiImagemDestaque">Imagem em Destaque (opcional)</label>
                        <div class="ai-image-selector">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="openMediaLibraryForAI()">
                                <i class="fas fa-image"></i> Selecionar da Biblioteca
                            </button>

                            <!-- Sugest√µes de imagens (aparece ap√≥s gerar mat√©ria) -->
                            <div id="aiImageSuggestions" style="display: none; margin-top: 15px;">
                                <p style="font-weight: bold; color: #4CAF50;">
                                    <i class="fas fa-lightbulb"></i> Sugest√µes de Imagens:
                                </p>
                                <div id="aiImageSuggestionsGrid"
                                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
                                    <!-- Imagens ser√£o inseridas aqui via JavaScript -->
                                </div>
                            </div>

                            <div id="aiImagePreview" style="display: none; margin-top: 10px;">
                                <img id="aiImagePreviewImg" src="" alt="Preview"
                                    style="max-width: 200px; border-radius: 8px;">
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeAIImage()"
                                    style="margin-left: 10px;">
                                    <i class="fas fa-times"></i> Remover
                                </button>
                            </div>
                            <input type="hidden" id="aiImagemDestaque">
                        </div>
                        <small class="form-text">Escolha uma imagem da biblioteca para usar como destaque</small>
                    </div>

                    <div class="ai-info">
                        <i class="fas fa-info-circle"></i>
                        <p>A IA criar√° uma mat√©ria completa com t√≠tulo, descri√ß√£o e conte√∫do. Voc√™ poder√° revisar e
                            editar antes de publicar.</p>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeAIModal()">
                            Cancelar
                        </button>
                        <button type="button" class="btn btn-primary" onclick="criarComIA()">
                            <i class="fas fa-magic"></i> Gerar Mat√©ria
                        </button>
                    </div>
                </div>

                <!-- Tab Por Conte√∫do -->
                <div class="ai-form ai-tab-content" id="ai-tab-conteudo">
                    <div class="form-group">
                        <label for="aiConteudoTitulo">T√≠tulo Sugerido (opcional)</label>
                        <input type="text" id="aiConteudoTitulo" class="form-control"
                            placeholder="Ex: Pastor anuncia novo projeto social">
                        <small class="form-text">Deixe em branco para a IA criar um t√≠tulo automaticamente</small>
                    </div>

                    <div class="form-group">
                        <label for="aiConteudoInformacoes">Informa√ß√µes e Conte√∫do *</label>
                        <div class="input-with-ai" style="display: block;">
                            <textarea id="aiConteudoInformacoes" class="form-control" rows="8"
                                placeholder="Cole ou digite todas as informa√ß√µes que voc√™ tem sobre a mat√©ria:&#10;&#10;- Fatos principais&#10;- Declara√ß√µes importantes&#10;- Contexto do evento&#10;- Dados relevantes&#10;- Cita√ß√µes&#10;&#10;Quanto mais informa√ß√µes voc√™ fornecer, melhor ser√° a mat√©ria criada pela IA."
                                required></textarea>
                            <button type="button" class="btn-ai-expand" onclick="expandirConteudoComIA()"
                                title="Reorganizar com IA - A IA ir√° reorganizar e melhorar a estrutura do texto sem inventar novos fatos">
                                ‚ú® Reorganizar com IA
                            </button>
                        </div>
                        <small class="form-text">üìù Forne√ßa as informa√ß√µes e clique em "Reorganizar com IA" para
                            melhorar a estrutura do texto (sem inventar fatos), ou forne√ßa tudo e gere a mat√©ria
                            direto</small>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="aiConteudoModoAutomatico" checked>
                            üöÄ Modo Autom√°tico (Recomendado)
                        </label>
                        <small class="form-text">A IA busca e seleciona imagem automaticamente</small>
                    </div>

                    <div class="form-group">
                        <label for="aiConteudoCategoria">Categoria</label>
                        <select id="aiConteudoCategoria" class="form-control">
                            <option value="Not√≠cias">Not√≠cias</option>
                            <option value="M√∫sica">M√∫sica</option>
                            <option value="Eventos">Eventos</option>
                            <option value="Minist√©rios">Minist√©rios</option>
                            <option value="Estudos">Estudos</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="aiConteudoPalavrasChave">Palavras-chave (opcional)</label>
                        <input type="text" id="aiConteudoPalavrasChave" class="form-control"
                            placeholder="Ex: igreja, comunidade, projeto social">
                        <small class="form-text">Palavras-chave separadas por v√≠rgula</small>
                    </div>

                    <div class="form-group">
                        <label for="aiConteudoImagemDestaque">Imagem em Destaque (opcional)</label>
                        <div class="ai-image-selector">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="openMediaLibraryForAI()">
                                <i class="fas fa-image"></i> Selecionar da Biblioteca
                            </button>

                            <div id="aiConteudoImagePreview" style="display: none; margin-top: 10px;">
                                <img id="aiConteudoImagePreviewImg" src="" alt="Preview"
                                    style="max-width: 200px; border-radius: 8px;">
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeAIImage()"
                                    style="margin-left: 10px;">
                                    <i class="fas fa-times"></i> Remover
                                </button>
                            </div>
                            <input type="hidden" id="aiConteudoImagemDestaque">
                        </div>
                        <small class="form-text">Escolha uma imagem ou deixe a IA selecionar automaticamente</small>
                    </div>

                    <div class="ai-info">
                        <i class="fas fa-info-circle"></i>
                        <p>‚ú® A IA criar√° uma mat√©ria humanizada, sem pl√°gio, com linguagem natural e profissional
                            baseada nas informa√ß√µes fornecidas. O conte√∫do ser√° reescrito de forma √∫nica e original.</p>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeAIModal()">
                            Cancelar
                        </button>
                        <button type="button" class="btn btn-primary" onclick="criarPorConteudo()">
                            <i class="fas fa-magic"></i> Gerar Mat√©ria
                        </button>
                    </div>
                </div>

                <!-- Tab Por Link -->
                <div class="ai-form ai-tab-content" id="ai-tab-link">
                    <div class="form-group">
                        <label for="aiLinkUrl">Link da Postagem ou Mat√©ria *</label>
                        <input type="url" id="aiLinkUrl" class="form-control"
                            placeholder="Ex: https://www.instagram.com/p/ABC123/ ou https://facebook.com/watch?v=123">
                        <small class="form-text">‚ú® Suporta: <strong>Instagram</strong> (posts, reels, v√≠deos),
                            <strong>Facebook</strong> (posts, v√≠deos, watch), <strong>YouTube</strong>, ou qualquer site
                            de not√≠cias</small>
                    </div>

                    <div class="form-group">
                        <label for="aiLinkTexto">OU Cole o Texto Manualmente (opcional)</label>
                        <textarea id="aiLinkTexto" class="form-control" rows="6"
                            placeholder="Se o sistema n√£o conseguir extrair automaticamente, cole o texto aqui..."></textarea>
                        <small class="form-text">üì± Opcional: Cole o texto apenas se a extra√ß√£o autom√°tica
                            falhar</small>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="aiLinkModoAutomatico" checked>
                            üöÄ Modo Autom√°tico (Recomendado)
                        </label>
                        <small class="form-text">A IA cria a mat√©ria e seleciona imagem automaticamente</small>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="aiLinkTranscreverVideo" checked
                                style="width: 18px; height: 18px;">
                            <span>üé• Transcrever V√≠deos Automaticamente</span>
                        </label>
                        <small class="form-text" style="color: #059669;">Se o link for um v√≠deo (Instagram Reel,
                            Facebook Watch, etc), o √°udio ser√° transcrito automaticamente para criar a mat√©ria</small>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="aiLinkPesquisarInternet" checked
                                style="width: 18px; height: 18px;">
                            <span>üåê Pesquisar na Internet para Complementar</span>
                        </label>
                        <small class="form-text" style="color: #059669;">A IA buscar√° not√≠cias e informa√ß√µes adicionais
                            na internet para enriquecer a mat√©ria com contexto e fatos atualizados</small>
                    </div>

                    <div class="form-group">
                        <label for="aiLinkCategoria">Categoria</label>
                        <select id="aiLinkCategoria" class="form-control">
                            <option value="Not√≠cias">Not√≠cias</option>
                            <option value="M√∫sica">M√∫sica</option>
                            <option value="Eventos">Eventos</option>
                            <option value="Minist√©rios">Minist√©rios</option>
                            <option value="Estudos">Estudos</option>
                        </select>
                    </div>

                    <div class="ai-info" style="background: #ecfdf5; border-color: #10b981;">
                        <i class="fas fa-info-circle" style="color: #10b981;"></i>
                        <p style="color: #065f46;">üì± <strong>Instagram/Facebook com v√≠deo:</strong> Extrai legenda +
                            transcreve o √°udio do v√≠deo<br>
                            üåê <strong>Pesquisa na internet:</strong> Busca not√≠cias relacionadas para enriquecer a
                            mat√©ria<br>
                            üñºÔ∏è <strong>Imagem:</strong> Baixa automaticamente a imagem/thumbnail do post</p>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeAIModal()">
                            Cancelar
                        </button>
                        <button type="button" class="btn btn-primary" onclick="criarPorLink()">
                            <i class="fas fa-magic"></i> Gerar Mat√©ria do Link
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Acrescentar Informa√ß√£o -->
    <div id="modalAcrescentarInfo" class="modal">
        <div class="modal-content modal-ai">
            <div class="modal-header">
                <h2><i class="fas fa-plus-circle"></i> Acrescentar Informa√ß√£o com IA</h2>
                <button type="button" class="modal-close" onclick="fecharModalAcrescentarInfo()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">
                <div class="form-group">
                    <label for="instrucaoAcrescentar">O que voc√™ quer acrescentar ou modificar? *</label>
                    <textarea id="instrucaoAcrescentar" class="form-control" rows="4"
                        placeholder="Ex: Adicione informa√ß√µes sobre a biografia do cantor&#10;Ex: Mude o t√≠tulo para ficar mais chamativo&#10;Ex: Acrescente detalhes sobre o evento&#10;Ex: Reescreva o segundo par√°grafo de forma mais clara"></textarea>
                    <small class="form-text">üí° Seja espec√≠fico sobre o que deseja modificar no t√≠tulo ou
                        conte√∫do</small>
                </div>

                <div class="ai-info" style="margin-top: 16px;">
                    <i class="fas fa-info-circle"></i>
                    <p><strong>Como funciona:</strong> A IA vai analisar seu conte√∫do atual e fazer as modifica√ß√µes que
                        voc√™ pediu, mantendo o estilo e estrutura da mat√©ria.</p>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="fecharModalAcrescentarInfo()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="gerarAcrescentarInfo()"
                        id="btnGerarAcrescentar">
                        <i class="fas fa-magic"></i> Gerar com IA
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Assistente IA -->
    <div id="modalAssistenteIA" class="modal">
        <div class="modal-content modal-ai modal-assistente">
            <div class="modal-header">
                <h2><i class="fas fa-robot"></i> Assistente IA</h2>
                <button type="button" class="modal-close" onclick="fecharAssistenteIA()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="assistente-chat">
                    <div class="assistente-mensagens" id="assistenteMensagens">
                        <div class="mensagem-ia">
                            <div class="mensagem-avatar"><i class="fas fa-robot"></i></div>
                            <div class="mensagem-conteudo">
                                <p>Ol√°! Sou seu assistente de IA. Posso ajudar voc√™ a:</p>
                                <ul>
                                    <li><strong>Alterar s√≥ o t√≠tulo</strong> - "altere o t√≠tulo para ficar mais
                                        pol√™mico"</li>
                                    <li><strong>Alterar s√≥ a descri√ß√£o</strong> - "melhore a descri√ß√£o"</li>
                                    <li><strong>Alterar s√≥ o conte√∫do</strong> - "acrescente no conte√∫do informa√ß√µes
                                        sobre..."</li>
                                    <li><strong>Criar mat√©ria completa</strong> - "crie uma mat√©ria sobre div√≥rcio entre
                                        evang√©licos"</li>
                                </ul>
                                <p
                                    style="margin-top: 10px; padding: 8px; background: #FEF3C7; border-radius: 6px; font-size: 12px;">
                                    <i class="fas fa-lightbulb" style="color: #D97706;"></i>
                                    <strong>Dica:</strong> Seja espec√≠fico! Se quiser alterar s√≥ o t√≠tulo, diga "altere
                                    o t√≠tulo".
                                    Se quiser uma mat√©ria completa, diga "crie uma mat√©ria sobre..."
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="assistente-opcoes"
                        style="margin-bottom: 12px; padding: 12px; background: #F0FDF4; border-radius: 8px; border: 1px solid #BBF7D0;">
                        <label
                            style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer; color: #166534;">
                            <input type="checkbox" id="assistentePesquisarInternet" style="width: 18px; height: 18px;">
                            <i class="fas fa-globe" style="color: #22C55E;"></i>
                            <span><strong>Pesquisar na internet</strong> para enriquecer a mat√©ria com dados
                                atualizados</span>
                        </label>
                    </div>
                    <div class="assistente-input-area">
                        <textarea id="assistenteInput" class="form-control" rows="2"
                            placeholder="Digite o que voc√™ quer... Ex: 'crie uma mat√©ria sobre div√≥rcio entre evang√©licos'"
                            onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); enviarMensagemAssistente(); }"></textarea>
                        <button type="button" class="btn-enviar-assistente" onclick="enviarMensagemAssistente()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <div class="assistente-sugestoes" id="assistenteSugestoes" style="display: none;">
                    <h4><i class="fas fa-lightbulb"></i> Sugest√µes da IA</h4>
                    <div class="sugestoes-lista" id="sugestoesLista"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Biblioteca de M√≠dia -->
    <div id="mediaLibraryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-images"></i> Biblioteca de M√≠dia</h2>
                <button type="button" class="modal-close" onclick="closeMediaLibrary()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-tabs">
                <button type="button" class="modal-tab-btn active" onclick="switchModalTab('biblioteca', event)">
                    <i class="fas fa-folder-open"></i> Biblioteca
                </button>
                <button type="button" class="modal-tab-btn" onclick="switchModalTab('upload', event)">
                    <i class="fas fa-upload"></i> Fazer Upload
                </button>
                <button type="button" class="modal-tab-btn" onclick="switchModalTab('buscar-bing', event)">
                    <i class="fas fa-search"></i> Buscar no Bing
                </button>
                <button type="button" class="modal-tab-btn" onclick="switchModalTab('buscar-google', event)">
                    <i class="fab fa-google"></i> Buscar no Google
                </button>
            </div>

            <div class="modal-body">
                <!-- Tab Biblioteca -->
                <div class="modal-tab-content active" id="modal-biblioteca">
                    <div class="media-filters">
                        <input type="text" id="mediaSearch" class="form-control" placeholder="Buscar na biblioteca..."
                            onkeyup="filterMedia()">
                        <select id="mediaTypeFilter" class="form-control" onchange="loadMediaLibrary()">
                            <option value="">Todos os tipos</option>
                            <option value="imagem">Imagens</option>
                            <option value="video">Videos</option>
                            <option value="audio">Audios</option>
                        </select>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="toggleSelectMode()"
                            id="btnSelectMode">
                            <i class="fas fa-check-square"></i> Selecionar
                        </button>
                    </div>

                    <!-- Barra de selecao multipla -->
                    <div class="media-selection-bar" id="mediaSelectionBar">
                        <div class="selection-info">
                            <i class="fas fa-check-circle"></i>
                            <span><strong id="selectedCountText">0</strong> itens selecionados</span>
                        </div>
                        <div class="selection-actions">
                            <button type="button" class="btn-selection btn-use" onclick="useSelectedMedia()">
                                <i class="fas fa-check"></i> Usar Selecionados
                            </button>
                            <button type="button" class="btn-selection btn-delete" onclick="deleteSelectedMedia()">
                                <i class="fas fa-trash"></i> Excluir
                            </button>
                            <button type="button" class="btn-selection btn-cancel" onclick="cancelSelection()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    </div>

                    <div id="mediaGrid" class="media-grid">
                        <div class="loading">Carregando...</div>
                    </div>
                </div>

                <!-- Tab Upload -->
                <div class="modal-tab-content" id="modal-upload">
                    <div class="upload-area-modal" id="uploadAreaModal">
                        <input type="file" id="fileInputModal" accept="image/*,video/*,audio/*" style="display: none;"
                            onchange="handleModalUpload(event)">
                        <div class="upload-placeholder" onclick="document.getElementById('fileInputModal').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Clique para selecionar arquivo</p>
                            <small>Imagens, V√≠deos, √Åudios at√© 10MB</small>
                        </div>
                    </div>
                    <div id="uploadProgress" class="upload-progress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <p id="progressText">Enviando...</p>
                    </div>
                </div>

                <!-- Tab Buscar no Bing -->
                <div class="modal-tab-content" id="modal-buscar-bing">
                    <div class="bing-search-container">
                        <div class="bing-search-box">
                            <input type="text" id="bingSearchInput" class="form-control"
                                placeholder="Digite o que voc√™ quer encontrar... (ex: igreja, louvor, pastor)"
                                onkeypress="if(event.key === 'Enter') buscarImagensBing()">
                            <button type="button" class="btn btn-primary" onclick="buscarImagensBing()">
                                <i class="fas fa-search"></i> Buscar Imagens
                            </button>
                        </div>
                        <div id="bingSearchResults" class="bing-results-grid">
                            <div class="bing-placeholder">
                                <i class="fas fa-search" style="font-size: 48px; color: #ccc; margin-bottom: 16px;"></i>
                                <p style="color: #666;">Digite uma palavra-chave e clique em "Buscar Imagens"</p>
                            </div>
                        </div>
                        <div id="bingSearchLoading" class="loading" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Buscando imagens...
                        </div>
                    </div>
                </div>

                <!-- Tab Buscar no Google -->
                <div class="modal-tab-content" id="modal-buscar-google">
                    <div class="bing-search-container">
                        <div class="bing-search-box">
                            <input type="text" id="googleSearchInput" class="form-control"
                                placeholder="Digite o que voc√™ quer encontrar... (ex: igreja, louvor, pastor)"
                                onkeypress="if(event.key === 'Enter') buscarImagensGoogle()">
                            <button type="button" class="btn btn-primary" onclick="buscarImagensGoogle()">
                                <i class="fab fa-google"></i> Buscar Imagens
                            </button>
                        </div>
                        <div id="googleSearchResults" class="bing-results-grid">
                            <div class="bing-placeholder">
                                <i class="fab fa-google"
                                    style="font-size: 48px; color: #4285F4; margin-bottom: 16px;"></i>
                                <p style="color: #666;">Digite uma palavra-chave e clique em "Buscar Imagens"</p>
                            </div>
                        </div>
                        <div id="googleSearchLoading" class="loading" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Buscando imagens no Google...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editor de Imagem -->
    <div id="imageEditorModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2><i class="fas fa-crop"></i> Editor de Imagem</h2>
                <button type="button" class="modal-close" onclick="closeImageEditor()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">
                <div class="image-editor-container">
                    <div class="editor-toolbar">
                        <div class="toolbar-group">
                            <button type="button" class="btn-editor-tool" onclick="rotateImage(-90)"
                                title="Girar para esquerda">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button type="button" class="btn-editor-tool" onclick="rotateImage(90)"
                                title="Girar para direita">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                        <div class="toolbar-group">
                            <button type="button" class="btn-editor-tool" onclick="flipImage('horizontal')"
                                title="Espelhar horizontal">
                                <i class="fas fa-arrows-alt-h"></i>
                            </button>
                            <button type="button" class="btn-editor-tool" onclick="flipImage('vertical')"
                                title="Espelhar vertical">
                                <i class="fas fa-arrows-alt-v"></i>
                            </button>
                        </div>
                        <div class="toolbar-group">
                            <button type="button" id="eraserBtn" class="btn-editor-tool" onclick="toggleEraserMode()"
                                title="Remover Objeto (Borracha M√°gica)">
                                <i class="fas fa-eraser"></i>
                            </button>
                        </div>
                        <div class="toolbar-group">
                            <button type="button" class="btn-editor-tool" onclick="zoomImage(0.1)" title="Zoom In (+)">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button type="button" class="btn-editor-tool" onclick="zoomImage(-0.1)"
                                title="Zoom Out (-)">
                                <i class="fas fa-search-minus"></i>
                            </button>
                        </div>
                        <div class="toolbar-group">
                            <button type="button" class="btn-editor-tool" onclick="resetCrop()" title="Resetar">
                                <i class="fas fa-sync"></i>
                            </button>
                        </div>
                        <div class="toolbar-group">
                            <label class="aspect-ratio-label">Propor√ß√£o:</label>
                            <select id="aspectRatio" class="form-control" onchange="changeAspectRatio()"
                                style="width: auto; display: inline-block;">
                                <option value="NaN">Livre</option>
                                <option value="1">1:1 (Quadrado)</option>
                                <option value="1.7777777777777777">16:9 (Paisagem)</option>
                                <option value="0.5625">9:16 (Retrato)</option>
                                <option value="1.3333333333333333">4:3</option>
                                <option value="0.75">3:4</option>
                            </select>
                        </div>
                    </div>

                    <div class="editor-canvas-container">
                        <img id="imageEditorCanvas" src="" alt="Imagem para editar">
                    </div>

                    <div class="editor-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeImageEditor()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="button" class="btn btn-primary" onclick="saveEditedImage()">
                            <i class="fas fa-save"></i> Salvar Imagem Editada
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Verificar Fatos -->
    <div id="modalVerificarFatos" class="modal">
        <div class="modal-content modal-factcheck">
            <div class="modal-header" style="background: linear-gradient(135deg, #059669 0%, #10B981 100%);">
                <h2 style="color: white;"><i class="fas fa-search"></i> Verificacao de Fatos</h2>
                <button type="button" class="modal-close" onclick="fecharModalVerificarFatos()" style="color: white;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="factcheckLoading" class="factcheck-loading">
                    <div class="factcheck-spinner"></div>
                    <p>Verificando fatos da materia...</p>
                    <small>Pesquisando fontes e analisando informacoes</small>
                </div>
                <div id="factcheckResultado" class="factcheck-resultado" style="display: none;"></div>
            </div>
        </div>
    </div>

    <style>
        /* Header da p√°gina */
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            padding: 24px;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border-radius: 16px;
            border: 1px solid #E2E8F0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .content-header h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 0 0 6px 0;
            color: #1A202C;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .content-header h1::before {
            content: '';
            width: 4px;
            height: 28px;
            background: linear-gradient(135deg, #0669de 0%, #3d8bfd 100%);
            border-radius: 2px;
        }

        .content-header p {
            font-size: 14px;
            color: #718096;
            margin: 0;
            font-weight: 400;
            padding-left: 16px;
        }

        .post-form {
            margin-top: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .form-main,
        .form-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
            border: 1px solid #E8E8E8;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid #F0F0F0;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        }

        .card-header h3 {
            font-size: 13px;
            font-weight: 700;
            margin: 0;
            color: #2D3748;
            letter-spacing: 0.4px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-header h3::before {
            content: '';
            width: 3px;
            height: 16px;
            background: linear-gradient(135deg, #0669de 0%, #3d8bfd 100%);
            border-radius: 2px;
        }

        .card-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 7px;
            font-weight: 500;
            font-size: 11px;
            color: #4A5568;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        .form-control {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #E2E8F0;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
            background: white;
            color: #2D3748;
        }

        .form-control:focus {
            outline: none;
            border-color: #0669de;
            box-shadow: 0 0 0 4px rgba(6, 105, 222, 0.1);
            background: #f8faff;
        }

        .form-control:hover {
            border-color: #CBD5E0;
        }

        .form-control::placeholder {
            color: #a0aec0;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 75px;
            line-height: 1.5;
        }

        .form-check {
            margin-bottom: 12px;
            padding: 10px 12px;
            background: #F7FAFC;
            border-radius: 8px;
            transition: all 0.15s;
            border: 1px solid #E2E8F0;
        }

        .form-check:hover {
            background: #EDF2F7;
            border-color: #CBD5E0;
        }

        .form-check label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 400;
            font-size: 13px;
            margin: 0;
            color: #2D3748;
        }

        .form-check input[type="checkbox"] {
            width: 17px;
            height: 17px;
            cursor: pointer;
            accent-color: #0669de;
        }

        .btn {
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            letter-spacing: 0.3px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0669de 0%, #3d8bfd 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(6, 105, 222, 0.25);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(6, 105, 222, 0.35);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(100, 116, 139, 0.2);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(100, 116, 139, 0.3);
        }

        .btn-block {
            width: 100%;
            justify-content: center;
            margin-top: 16px;
        }

        .btn-sm {
            padding: 8px 14px;
            font-size: 12px;
        }

        /* Upload Tabs */
        .upload-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 14px;
            border-bottom: 1px solid #E2E8F0;
        }

        .tab-btn {
            padding: 8px 14px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
            color: #718096;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .tab-btn:hover {
            color: #0669de;
            background: #FFF5ED;
        }

        .tab-btn.active {
            color: #0669de;
            border-bottom-color: #0669de;
            background: #FFF5ED;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed #CBD5E0;
            border-radius: 10px;
            padding: 32px 18px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #F7FAFC;
        }

        .upload-area:hover {
            border-color: #0669de;
            background: #FFF5ED;
        }

        .upload-placeholder i {
            font-size: 38px;
            color: #0669de;
            margin-bottom: 10px;
        }

        .upload-placeholder p {
            font-size: 13px;
            font-weight: 500;
            color: #2D3748;
            margin-bottom: 3px;
        }

        .upload-placeholder small {
            color: #718096;
            font-size: 11px;
        }

        /* Preview */
        .image-preview {
            margin-top: 14px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #E2E8F0;
            position: relative;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .btn-remove {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.95);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            font-size: 13px;
        }

        .btn-remove:hover {
            background: #DC2626;
            transform: scale(1.08);
        }

        /* Editor Toolbar Custom */
        .editor-toolbar-custom {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .editor-toolbar-left {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-insert-media {
            padding: 9px 16px;
            background: linear-gradient(135deg, #0669de 0%, #3d8bfd 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 7px;
            transition: all 0.15s;
            font-size: 12px;
            box-shadow: 0 2px 6px rgba(255, 107, 0, 0.2);
            letter-spacing: 0.2px;
        }

        .btn-insert-media:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(255, 107, 0, 0.3);
        }

        .btn-insert-media:active {
            transform: translateY(0);
        }

        /* Toggle de Modo Visual/C√≥digo */
        .editor-mode-toggle {
            display: flex;
            gap: 0;
            background: #F7FAFC;
            border-radius: 8px;
            padding: 3px;
            border: 1px solid #E2E8F0;
        }

        .mode-btn {
            padding: 6px 12px;
            background: transparent;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            color: #718096;
            cursor: pointer;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .mode-btn:hover {
            color: #2D3748;
            background: #EDF2F7;
        }

        .mode-btn.active {
            background: white;
            color: #0669de;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .mode-btn i {
            font-size: 12px;
        }

        /* Editor de C√≥digo */
        .code-editor {
            resize: vertical;
            background: #1E293B;
            color: #E2E8F0;
            border: 1px solid #334155;
            border-radius: 0 0 8px 8px;
            padding: 14px;
            tab-size: 2;
        }

        .code-editor:focus {
            outline: none;
            border-color: #0669de;
            box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.1);
        }

        /* Quill */
        .ql-toolbar {
            background: #F7FAFC;
            border-radius: 8px 8px 0 0;
            border: 1px solid #E2E8F0;
            border-bottom: none;
        }

        .ql-container {
            font-size: 14px;
            font-family: Inter, -apple-system, sans-serif;
            border-radius: 0 0 8px 8px;
            border: 1px solid #E2E8F0;
        }

        .ql-editor {
            min-height: 280px;
            padding: 14px;
        }

        /* Instagram Embed - Corrigir z-index e posicionamento */
        .ql-editor iframe.instagram-media,
        .ql-editor iframe.instagram-media-rendered,
        iframe.instagram-media,
        iframe.instagram-media-rendered {
            position: static !important;
            z-index: auto !important;
            margin: 20px auto !important;
            display: block !important;
            max-width: 540px !important;
        }

        .ql-editor blockquote.instagram-media {
            position: static !important;
            z-index: auto !important;
            margin: 20px auto !important;
            max-width: 540px !important;
        }

        /* Blockquote - Estilo de cita√ß√£o para posts */
        .ql-editor blockquote:not(.instagram-media) {
            border-left: 4px solid #0669de;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            margin: 20px 0;
            padding: 20px 24px;
            border-radius: 0 12px 12px 0;
            font-style: italic;
            color: #374151;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .ql-editor blockquote:not(.instagram-media)::before {
            content: '"';
            font-size: 60px;
            font-family: Georgia, serif;
            color: #0669de;
            opacity: 0.3;
            position: absolute;
            top: -10px;
            left: 10px;
            line-height: 1;
        }

        .ql-editor blockquote:not(.instagram-media) p {
            margin: 0;
            font-size: 16px;
            line-height: 1.7;
        }

        /* Blockquote alternativo - estilo destaque */
        .ql-editor blockquote.destaque {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .ql-editor blockquote.destaque::before {
            color: #f59e0b;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #E2E8F0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #FAFBFC;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #2D3748;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #EDF2F7;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            font-size: 16px;
            color: #718096;
        }

        .modal-close:hover {
            background: #0669de;
            color: white;
            transform: scale(1.05);
        }

        .modal-tabs {
            display: flex;
            gap: 4px;
            padding: 12px 20px;
            border-bottom: 1px solid #E2E8F0;
            background: #F7FAFC;
        }

        .modal-tab-btn {
            padding: 8px 16px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
            color: #718096;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 6px;
            border-radius: 6px 6px 0 0;
        }

        .modal-tab-btn:hover {
            color: #0669de;
            background: white;
        }

        .modal-tab-btn.active {
            color: #0669de;
            border-bottom-color: #0669de;
            background: white;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-tab-content {
            display: none;
        }

        .modal-tab-content.active {
            display: block;
        }

        .media-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .media-filters .form-control {
            flex: 1;
            font-size: 12px;
        }

        .media-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px;
            background: #F5F7FA;
            border-radius: 8px;
        }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            max-height: 450px;
            overflow-y: auto;
            padding: 8px;
        }

        .media-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            background: #F5F7FA;
        }

        .media-item:hover {
            border-color: #3d8bfd;
            transform: scale(1.03);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .media-item.selected {
            border-color: #0669de;
            box-shadow: 0 0 0 3px rgba(6, 105, 222, 0.3);
        }

        .media-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-item-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.85));
            padding: 8px;
            color: white;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .media-item:hover .media-item-info {
            opacity: 1;
        }

        .media-item-checkbox {
            position: absolute;
            top: 6px;
            left: 6px;
            width: 26px;
            height: 26px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
            border: 2px solid #E5E7EB;
            transition: all 0.15s;
        }

        .media-item:hover .media-item-checkbox {
            border-color: #0669de;
        }

        .media-item-checkbox i {
            color: #0669de;
            font-size: 12px;
            display: none;
        }

        .media-item.selected .media-item-checkbox {
            background: #0669de;
            border-color: #0669de;
        }

        .media-item.selected .media-item-checkbox i {
            display: block;
            color: white;
        }

        /* Barra de selecao multipla */
        .media-selection-bar {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: linear-gradient(135deg, #0669de 0%, #3d8bfd 100%);
            border-radius: 10px;
            margin-bottom: 12px;
            color: white;
        }

        .media-selection-bar.active {
            display: flex;
        }

        .media-selection-bar .selection-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .media-selection-bar .selection-actions {
            display: flex;
            gap: 8px;
        }

        .media-selection-bar .btn-selection {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
        }

        .media-selection-bar .btn-use {
            background: white;
            color: #0669de;
        }

        .media-selection-bar .btn-use:hover {
            background: #f0f7ff;
        }

        .media-selection-bar .btn-delete {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .media-selection-bar .btn-delete:hover {
            background: #DC2626;
        }

        .media-selection-bar .btn-cancel {
            background: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .media-selection-bar .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .upload-area-modal {
            border: 3px dashed #E0E0E0;
            border-radius: 12px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #F9FAFB;
        }

        .upload-area-modal:hover {
            border-color: #0669de;
            background: #FFF5ED;
        }

        .upload-progress {
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #E0E0E0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #0669de;
            transition: width 0.3s;
        }

        .upload-progress p {
            text-align: center;
            margin-top: 10px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* Estilos para busca do Bing */
        .bing-search-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .bing-search-box {
            display: flex;
            gap: 12px;
            align-items: stretch;
        }

        .bing-search-box .form-control {
            flex: 1;
            font-size: 15px;
            padding: 10px 14px;
            border: 2px solid #E0E0E0;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .bing-search-box .form-control:focus {
            border-color: #0669de;
            outline: none;
            box-shadow: 0 0 0 3px rgba(6, 105, 222, 0.1);
        }

        .bing-search-box .btn {
            padding: 10px 20px;
            white-space: nowrap;
            border-radius: 8px;
            font-weight: 600;
        }

        .bing-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
            min-height: 300px;
        }

        .bing-placeholder {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
        }

        .bing-image-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
            background: #F5F7FA;
        }

        .bing-image-item:hover {
            border-color: #0669de;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 107, 0, 0.2);
        }

        .bing-image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .bing-image-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            padding: 12px 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .bing-image-info {
            color: white;
            font-size: 10px;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .bing-image-select {
            background: #0669de;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bing-image-select:hover {
            background: #3d8bfd;
            transform: scale(1.05);
        }

        @media (max-width: 1024px) {
            .form-grid {
                grid-template-columns: 1fr;
                display: flex;
                flex-direction: column;
            }

            /* Reordenar: sidebar primeiro, depois main */
            .form-sidebar {
                order: -1;
                margin-bottom: 20px;
            }

            .form-main {
                order: 1;
            }

            .modal-content {
                width: 95%;
            }

            .media-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .bing-results-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }

            /* Bot√£o IA na sidebar em tablets */
            .btn-ai-sidebar {
                font-size: 15px;
                padding: 14px 20px;
            }
        }

        /* Melhorias para celular */
        @media (max-width: 768px) {

            /* Bot√£o IA mais destacado no mobile */
            .btn-ai-sidebar {
                font-size: 16px;
                padding: 16px 20px;
                margin-bottom: 16px;
                box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
            }

            /* Sidebar no topo em mobile */
            .form-sidebar {
                margin-bottom: 16px;
            }

            .bing-search-box {
                flex-direction: column;
                gap: 10px;
            }

            .bing-search-box .form-control {
                width: 100%;
                font-size: 16px;
                /* Evita zoom autom√°tico no iOS */
                padding: 12px 16px;
                min-height: 48px;
                /* Melhor √°rea de toque */
            }

            .bing-search-box .btn {
                width: 100%;
                padding: 12px;
                font-size: 16px;
                min-height: 48px;
            }

            .bing-results-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .bing-image-overlay {
                padding: 8px 6px;
            }

            .bing-image-info {
                font-size: 9px;
            }

            .bing-image-select {
                padding: 4px 8px;
                font-size: 10px;
            }

            .modal-content {
                width: 100%;
                max-height: 90vh;
                margin: 5vh auto;
            }

            .modal-body {
                max-height: calc(90vh - 120px);
                overflow-y: auto;
            }
        }

        /* Melhorias para telas muito pequenas */
        @media (max-width: 480px) {
            .bing-results-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .bing-search-box .form-control {
                font-size: 16px;
                padding: 14px 16px;
            }

            .bing-placeholder {
                padding: 40px 15px;
            }

            .bing-placeholder i {
                font-size: 36px !important;
            }

            .bing-placeholder p {
                font-size: 14px;
            }
        }

        .content-header {
            flex-direction: column;
            gap: 16px;
        }

        .content-header h1 {
            font-size: 20px;
        }

        .header-actions {
            width: 100%;
            justify-content: flex-start;
        }

        .editor-toolbar-custom {
            flex-direction: column;
            align-items: stretch;
        }

        .editor-toolbar-left {
            width: 100%;
        }

        .editor-mode-toggle {
            width: 100%;
            justify-content: center;
        }
        }

        @media (max-width: 768px) {
            .content-header h1 {
                font-size: 18px;
            }

            .content-header p {
                font-size: 13px;
            }

            .header-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .card-body {
                padding: 16px;
            }

            .form-group label {
                font-size: 12px;
            }

            .form-control {
                font-size: 14px;
                padding: 10px;
            }

            .btn-ai-small {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .editor-toolbar-left {
                flex-wrap: wrap;
                gap: 8px;
            }

            .btn-insert-media,
            .btn-ai-correct {
                font-size: 11px;
                padding: 8px 12px;
            }

            .mode-btn {
                font-size: 11px;
                padding: 6px 10px;
            }

            #editor {
                height: 300px !important;
            }

            .code-editor {
                height: 300px !important;
            }

            .modal-content {
                width: 100%;
                max-height: 90vh;
                margin: 5vh auto;
            }

            .modal-header h2 {
                font-size: 16px;
            }

            .media-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 8px;
            }

            .bing-results-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 8px;
            }
        }

        @media (max-width: 480px) {
            .content-header h1 {
                font-size: 16px;
            }

            .card-body {
                padding: 12px;
            }

            .form-control {
                font-size: 16px;
            }

            /* Prevent zoom on iOS */
            .btn-ai-small {
                width: 30px;
                height: 30px;
                font-size: 12px;
            }

            .editor-toolbar-left {
                flex-direction: column;
            }

            .btn-insert-media,
            .btn-ai-correct {
                width: 100%;
            }

            #editor {
                height: 250px !important;
            }

            .code-editor {
                height: 250px !important;
            }

            .form-actions {
                flex-direction: column;
                gap: 10px;
            }

            .form-actions .btn {
                width: 100%;
            }

            .media-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }

            .bing-results-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }

        /* ============================================
       ESTILOS DA IA
       ============================================ */

        .header-actions {
            display: flex;
            gap: 2px;
            align-items: center;
        }

        .btn-ai {
            background: linear-gradient(135deg, #8B5CF6 0%, #A78BFA 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.2);
        }

        .btn-ai:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3);
        }

        /* Bot√£o Criar com IA na Sidebar - Maior e destacado */
        .btn-ai-sidebar {
            background: linear-gradient(135deg, #8B5CF6 0%, #A78BFA 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 11px;
            font-weight: 600;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
            width: 100%;
            margin-bottom: 20px;
        }

        .btn-ai-sidebar:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
            background: linear-gradient(135deg, #7C3AED 0%, #9333EA 100%);
        }

        .btn-ai-sidebar:active {
            transform: translateY(0);
        }

        .input-with-ai {
            position: relative;
            display: flex;
            gap: 6px;
            align-items: flex-start;
        }

        .input-with-ai .form-control {
            flex: 1;
        }

        .btn-ai-small {
            background: linear-gradient(135deg, #8B5CF6 0%, #A78BFA 100%);
            color: white;
            border: none;
            border-radius: 7px;
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 15px;
            flex-shrink: 0;
            margin-top: 0;
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.2);
        }

        .btn-ai-small:hover {
            transform: scale(1.08);
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3);
        }

        .btn-ai-small:active {
            transform: scale(0.96);
        }

        .btn-ai-correct {
            background: linear-gradient(135deg, #8B5CF6 0%, #A78BFA 100%);
            color: white;
            padding: 8px 14px;
            border-radius: 7px;
            font-weight: 500;
            font-size: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.2);
        }

        .btn-ai-correct:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3);
        }

        .btn-ai-enhance {
            background: linear-gradient(135deg, #3B82F6 0%, #60A5FA 100%);
            color: white;
            padding: 8px 14px;
            border-radius: 7px;
            font-weight: 500;
            font-size: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2);
            margin-left: 8px;
        }

        .btn-ai-enhance:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }

        .btn-ai-enhance:active {
            transform: scale(0.98);
        }

        .btn-ai-assistant {
            background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);
            color: white;
            padding: 8px 14px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 13px;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 6px rgba(245, 158, 11, 0.2);
            margin-left: 8px;
        }

        .btn-ai-assistant:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3);
        }

        .btn-ai-assistant:active {
            transform: scale(0.98);
        }

        .btn-ai-expand {
            background: linear-gradient(135deg, #10B981 0%, #34D399 100%);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 13px;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.2);
        }

        .btn-ai-expand:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
        }

        .btn-ai-expand:active {
            transform: scale(0.98);
        }

        .btn-ai-expand:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Dropdown IA */
        .btn-ai-dropdown {
            position: relative;
            display: inline-block;
        }

        .ai-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: 1px solid #E2E8F0;
            min-width: 250px;
            z-index: 1000;
            overflow: hidden;
        }

        .ai-dropdown-menu.active {
            display: block;
            animation: dropdownFadeIn 0.2s ease;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-dropdown-item {
            width: 100%;
            padding: 12px 16px;
            background: white;
            border: none;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #2D3748;
            transition: all 0.15s;
            border-bottom: 1px solid #F7FAFC;
        }

        .ai-dropdown-item:last-child {
            border-bottom: none;
        }

        .ai-dropdown-item:hover {
            background: #F7FAFC;
            color: #8B5CF6;
        }

        .ai-dropdown-item i {
            font-size: 14px;
            width: 18px;
            text-align: center;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        #mediaLibraryModal {
            z-index: 10001 !important;
        }

        #imageEditorModal {
            z-index: 10002 !important;
        }

        .modal-ai {
            max-width: 850px;
            margin: 20px;
        }

        .modal-ai .modal-body {
            padding: 16px 20px;
        }

        .modal-ai .form-group {
            margin-bottom: 16px;
        }

        .modal-ai .form-group label {
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .modal-ai .form-control {
            font-size: 13px;
            padding: 8px 11px;
        }

        .modal-ai .form-text {
            font-size: 11px;
            color: #718096;
            margin-top: 4px;
            display: block;
        }

        .ai-image-selector {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-select-image {
            padding: 8px 14px;
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            color: white;
            border: none;
            border-radius: 7px;
            font-weight: 500;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2);
        }

        .btn-select-image:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }

        .btn-sm {
            padding: 7px 12px;
            font-size: 12px;
        }

        .ai-image-preview {
            position: relative;
            width: 100%;
            max-width: 260px;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            overflow: hidden;
        }

        .ai-image-preview img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            display: block;
        }

        .btn-remove-image {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 28px;
            height: 28px;
            background: rgba(239, 68, 68, 0.95);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            font-size: 12px;
        }

        .btn-remove-image:hover {
            background: #DC2626;
            transform: scale(1.08);
        }

        .ai-form {
            padding: 0;
        }

        .ai-info {
            background: #EFF6FF;
            border: 1px solid #BFDBFE;
            border-radius: 8px;
            padding: 12px 14px;
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .ai-info i {
            color: #3B82F6;
            font-size: 16px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .ai-info p {
            margin: 0;
            font-size: 12px;
            color: #1E40AF;
            line-height: 1.5;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #E2E8F0;
        }

        /* AI Tabs */
        .ai-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid #E2E8F0;
            background: #F7FAFC;
            margin: 0;
            padding: 0;
        }

        .ai-tab-btn {
            flex: 1;
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
            color: #718096;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .ai-tab-btn:hover {
            color: #0669de;
            background: #FFF5ED;
        }

        .ai-tab-btn.active {
            color: #0669de;
            border-bottom-color: #0669de;
            background: white;
        }

        .ai-tab-btn i {
            font-size: 14px;
        }

        .ai-tab-content {
            display: none !important;
        }

        .ai-tab-content.active {
            display: block !important;
        }

        /* Checkboxes no modal AI */
        .modal-ai .form-group label input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-right: 8px;
        }

        .modal-ai .form-group>label {
            display: flex;
            align-items: center;
            font-size: 12px;
            font-weight: 500;
            color: #2D3748;
            cursor: pointer;
            padding: 0;
            text-transform: none;
            letter-spacing: normal;
        }

        /* Editor de Imagem */
        .image-editor-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .editor-toolbar {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: #F7FAFC;
            border-radius: 8px;
            border: 1px solid #E2E8F0;
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar-group {
            display: flex;
            gap: 6px;
            align-items: center;
            padding: 0 8px;
            border-right: 1px solid #E2E8F0;
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .btn-editor-tool {
            width: 36px;
            height: 36px;
            border: 1px solid #CBD5E0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            color: #4A5568;
            font-size: 14px;
        }

        .btn-editor-tool:hover {
            background: #0669de;
            color: white;
            border-color: #0669de;
            transform: translateY(-1px);
        }

        .btn-editor-tool:active {
            transform: translateY(0);
        }

        .btn-editor-tool.active {
            background: #0669de;
            border-color: #0669de;
            color: white;
        }

        .editor-canvas-container.eraser-mode {
            cursor: crosshair !important;
        }

        .editor-canvas-container.eraser-mode .cropper-crop-box,
        .editor-canvas-container.eraser-mode .cropper-view-box {
            cursor: crosshair !important;
        }

        .aspect-ratio-label {
            font-size: 12px;
            font-weight: 500;
            color: #4A5568;
            margin: 0;
            white-space: nowrap;
        }

        .editor-canvas-container {
            width: 100%;
            height: 600px;
            overflow: hidden;
            background: #F7FAFC;
            border-radius: 8px;
            border: 1px solid #E2E8F0;
            display: block;
            position: relative;
        }

        .editor-canvas-container img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        /* Ajustar tamanho do Cropper */
        .cropper-container {
            width: 100% !important;
            height: 600px !important;
        }

        .cropper-canvas {
            max-width: 100% !important;
            max-height: 600px !important;
        }

        .cropper-view-box {
            outline: 2px solid #0669de;
            outline-offset: -1px;
        }

        .editor-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 12px;
            border-top: 1px solid #E2E8F0;
        }

        .media-item {
            position: relative;
        }

        .media-item-edit-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            background: rgba(255, 107, 0, 0.95);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            font-size: 14px;
            z-index: 10;
        }

        .media-item:hover .media-item-edit-btn {
            display: flex;
        }

        .media-item-edit-btn:hover {
            background: #3d8bfd;
            transform: scale(1.08);
        }

        /* Estilos do Modal Assistente IA */
        .modal-assistente {
            max-width: 600px;
        }

        .assistente-chat {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .assistente-mensagens {
            max-height: 300px;
            overflow-y: auto;
            padding: 16px;
            background: #F8FAFC;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .mensagem-ia,
        .mensagem-usuario {
            display: flex;
            gap: 12px;
        }

        .mensagem-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 16px;
        }

        .mensagem-ia .mensagem-avatar {
            background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);
            color: white;
        }

        .mensagem-usuario .mensagem-avatar {
            background: linear-gradient(135deg, #3B82F6 0%, #60A5FA 100%);
            color: white;
        }

        .mensagem-conteudo {
            flex: 1;
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            font-size: 12px;
        }

        .mensagem-conteudo p {
            margin: 0 0 8px 0;
            line-height: 1.5;
        }

        .mensagem-conteudo p:last-child {
            margin-bottom: 0;
        }

        .mensagem-conteudo ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .mensagem-conteudo li {
            margin-bottom: 6px;
        }

        .assistente-input-area {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .assistente-input-area textarea {
            flex: 1;
            resize: none;
            border-radius: 12px;
        }

        .btn-enviar-assistente {
            background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);
            color: white;
            border: none;
            border-radius: 12px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 18px;
        }

        .btn-enviar-assistente:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .assistente-sugestoes {
            margin-top: 16px;
            padding: 16px;
            background: #FFFBEB;
            border: 1px solid #FCD34D;
            border-radius: 12px;
        }

        .assistente-sugestoes h4 {
            margin: 0 0 12px 0;
            color: #92400E;
            font-size: 14px;
        }

        .sugestoes-lista {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sugestao-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .sugestao-item:hover {
            border-color: #F59E0B;
            background: #FFFEF5;
        }

        .sugestao-texto {
            flex: 1;
            font-size: 14px;
        }

        .sugestao-campo {
            font-size: 11px;
            color: #6B7280;
            background: #F3F4F6;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .btn-aplicar-sugestao {
            background: #10B981;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .btn-aplicar-sugestao:hover {
            background: #059669;
        }

        /* Botao Verificar Fatos */
        .btn-factcheck {
            background: linear-gradient(135deg, #059669 0%, #10B981 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.25);
            width: 100%;
            margin-top: 12px;
        }

        .btn-factcheck:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(5, 150, 105, 0.35);
            background: linear-gradient(135deg, #047857 0%, #059669 100%);
        }

        .btn-factcheck:active {
            transform: translateY(0);
        }

        /* Modal Verificar Fatos */
        .modal-factcheck {
            max-width: 700px;
        }

        .factcheck-loading {
            text-align: center;
            padding: 60px 20px;
        }

        .factcheck-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #E5E7EB;
            border-top-color: #10B981;
            border-radius: 50%;
            animation: factcheck-spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes factcheck-spin {
            to {
                transform: rotate(360deg);
            }
        }

        .factcheck-loading p {
            font-size: 16px;
            font-weight: 600;
            color: #1F2937;
            margin: 0 0 8px 0;
        }

        .factcheck-loading small {
            color: #6B7280;
            font-size: 13px;
        }

        .factcheck-resultado {
            padding: 20px;
        }

        .factcheck-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .factcheck-score {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #059669 0%, #10B981 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .factcheck-score span {
            color: white;
            font-size: 24px;
            font-weight: 700;
        }

        .factcheck-info h3 {
            font-size: 18px;
            font-weight: 700;
            color: #065F46;
            margin: 0 0 8px 0;
        }

        .factcheck-info p {
            font-size: 14px;
            color: #047857;
            margin: 0;
            line-height: 1.5;
        }

        .factcheck-fatos {
            margin-bottom: 20px;
        }

        .factcheck-fatos h4 {
            font-size: 14px;
            font-weight: 700;
            color: #1F2937;
            margin: 0 0 12px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .fato-item {
            display: flex;
            gap: 12px;
            padding: 14px;
            background: #F9FAFB;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #10B981;
        }

        .fato-item.pendente {
            border-left-color: #F59E0B;
        }

        .fato-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #D1FAE5;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: #059669;
            font-size: 12px;
        }

        .fato-item.pendente .fato-icon {
            background: #FEF3C7;
            color: #D97706;
        }

        .fato-content {
            flex: 1;
        }

        .fato-content strong {
            display: block;
            font-size: 14px;
            color: #1F2937;
            margin-bottom: 4px;
        }

        .fato-content p {
            font-size: 13px;
            color: #6B7280;
            margin: 0;
            line-height: 1.4;
        }

        .factcheck-observacoes {
            background: #FEF3C7;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .factcheck-observacoes h4 {
            font-size: 13px;
            font-weight: 700;
            color: #92400E;
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .factcheck-observacoes p {
            font-size: 13px;
            color: #78350F;
            margin: 0;
            line-height: 1.5;
        }

        .factcheck-conclusao {
            background: #F0FDF4;
            border-radius: 10px;
            padding: 16px;
            border: 1px solid #BBF7D0;
        }

        .factcheck-conclusao h4 {
            font-size: 13px;
            font-weight: 700;
            color: #166534;
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .factcheck-conclusao p {
            font-size: 13px;
            color: #15803D;
            margin: 0;
            line-height: 1.5;
        }

        .factcheck-fontes {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #E5E7EB;
            font-size: 12px;
            color: #6B7280;
        }

        @media (max-width: 768px) {
            .modal-factcheck {
                width: 100%;
                margin: 10px;
            }

            .factcheck-header {
                flex-direction: column;
                text-align: center;
            }

            .factcheck-score {
                width: 70px;
                height: 70px;
            }

            .factcheck-score span {
                font-size: 20px;
            }

            .fato-item {
                flex-direction: column;
                gap: 8px;
            }

            .fato-icon {
                align-self: flex-start;
            }
        }
    </style>

    <!-- Cropper.js CSS e JS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <!-- Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <script>
        // Vari√°veis globais
        var quill;
        var editorMode = 'visual';
        var embedInstagram = ''; // Guardar embed do Instagram durante edicao

        // Alternar entre modo visual e c√≥digo (DECLARAR NO TOPO PARA ESTAR DISPON√çVEL)
        function toggleEditorMode(mode) {
            const editor = document.getElementById('editor');
            const textarea = document.getElementById('conteudo');
            const visualBtn = document.querySelector('.mode-btn[data-mode="visual"]');
            const codeBtn = document.querySelector('.mode-btn[data-mode="code"]');

            if (!quill) {
                console.error('‚ùå Quill n√£o est√° inicializado ainda');
                return;
            }

            if (mode === 'code') {
                // Salvar conte√∫do do Quill no textarea
                textarea.value = quill.root.innerHTML;

                // Mostrar textarea e esconder Quill
                editor.style.display = 'none';
                textarea.style.display = 'block';

                // Atualizar bot√µes
                visualBtn.classList.remove('active');
                codeBtn.classList.add('active');

                editorMode = 'code';
            } else {
                // Carregar conte√∫do do textarea no Quill
                quill.root.innerHTML = textarea.value;

                // Mostrar Quill e esconder textarea
                editor.style.display = 'block';
                textarea.style.display = 'none';

                // Atualizar bot√µes
                codeBtn.classList.remove('active');
                visualBtn.classList.add('active');

                editorMode = 'visual';
            }
        }

        // Fun√ß√£o para inicializar o Quill
        function initQuill() {
            // Verificar se o Quill foi carregado
            if (typeof Quill === 'undefined') {
                console.error('‚ùå Quill n√£o foi carregado corretamente');
                console.log('üîÑ Tentando carregar Quill novamente...');

                // Tentar carregar o Quill manualmente
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/quill@1.3.6/dist/quill.min.js';
                script.onload = function () {
                    console.log('‚úÖ Quill carregado via fallback');
                    initQuillEditor();
                };
                script.onerror = function () {
                    console.error('‚ùå Falha ao carregar Quill. Verifique sua conex√£o com a internet.');
                    alert('Erro ao carregar o editor. Por favor, recarregue a p√°gina.');
                };
                document.head.appendChild(script);
                return;
            }

            initQuillEditor();
        }

        // Fun√ß√£o para inicializar o editor Quill
        function initQuillEditor() {
            // Inicializar Quill
            quill = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        [{ 'align': [] }],
                        ['link', 'image', 'video'],
                        ['clean']
                    ]
                }
            });

            console.log('‚úÖ Quill inicializado com sucesso');

            // Detectar e converter links do YouTube em embeds
            quill.on('text-change', function(delta, oldDelta, source) {
                if (source === 'user') {
                    convertYouTubeLinksToEmbed();
                }
            });

        // Carregar conte√∫do existente
        <% if (isEdit && article.conteudo) { %>
                let conteudoCarregado = <%- JSON.stringify(article.conteudo) %>;
                console.log('üìù Conte√∫do carregado cont√©m embed?', conteudoCarregado.includes('instagram-media'));
                console.log('üìè Tamanho do conte√∫do carregado:', conteudoCarregado.length);

                // Extrair e guardar o embed do Instagram (se existir)

                // Primeiro, remover TODOS os iframes renderizados do Instagram (evitar duplica√ß√£o)
                // Regex mais agressiva para pegar qualquer iframe do Instagram
                conteudoCarregado = conteudoCarregado.replace(/<iframe[^>]*instagram[^>]*>.*?<\/iframe>/gis, '');
                conteudoCarregado = conteudoCarregado.replace(/<iframe[^>]*class="instagram-media[^"]*"[^>]*>.*?<\/iframe>/gis, '');
                console.log('üßπ Todos os iframes do Instagram removidos para evitar duplica√ß√£o');

                // Regex para capturar o blockquote do Instagram (novo formato sem div wrapper)
                const embedRegex = /<blockquote[^>]*class="instagram-media"[^>]*>[\s\S]*?<\/blockquote>/gi;
                const embedMatch = conteudoCarregado.match(embedRegex);
                if (embedMatch) {
                    embedInstagram = embedMatch[0];
                    console.log('üì± Embed do Instagram encontrado e removido temporariamente');
                    console.log('üìè Tamanho do embed:', embedInstagram.length);
                    // Remover embed do conte√∫do para o Quill n√£o ter problemas
                    conteudoCarregado = conteudoCarregado.replace(embedRegex, '');
                    console.log('üìè Tamanho ap√≥s remover embed:', conteudoCarregado.length);
                }

                // Limpar HTML problem√°tico que o Quill n√£o consegue processar
                // Remover atributos data-* que podem causar problemas
                conteudoCarregado = conteudoCarregado.replace(/data-[a-z-]+="[^"]*"/gi, '');

                // Tentar carregar no Quill com tratamento de erro
                try {
                    quill.root.innerHTML = conteudoCarregado;
                    console.log('‚úÖ Conte√∫do carregado no Quill com sucesso');
                } catch (error) {
                    console.error('‚ùå Erro ao carregar conte√∫do no Quill:', error);
                    // Se falhar, carregar apenas o texto sem formata√ß√£o
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = conteudoCarregado;
                    quill.setText(tempDiv.textContent || tempDiv.innerText || '');
                    console.log('‚ö†Ô∏è Conte√∫do carregado como texto simples');
                }
        <% } %>

        // Garantir que o modo visual est√° ativo
        const editor = document.getElementById('editor');
            const textarea = document.getElementById('conteudo');

            // Sempre come√ßar no modo visual
            editor.style.display = 'block';
            textarea.style.display = 'none';

            // Se houver conte√∫do no textarea, carregar no Quill
            if (textarea.value.trim() && !quill.root.innerHTML.trim()) {
                quill.root.innerHTML = textarea.value;
            }
        }

        // Fun√ß√£o para verificar e mostrar status do agendamento
        function verificarAgendamento() {
            const dataInput = document.getElementById('dataPublicacao');
            const statusDiv = document.getElementById('agendamentoStatus');
            const statusTexto = document.getElementById('agendamentoTexto');
            const publicadoCheckbox = document.getElementById('publicadoCheckbox');

            if (!dataInput || !statusDiv) return;

            const dataSelecionada = new Date(dataInput.value);
            const agora = new Date();

            if (dataSelecionada > agora) {
                // Data futura - agendamento
                const diff = dataSelecionada - agora;
                const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
                const horas = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                let mensagem = 'Publica√ß√£o agendada para ';
                if (dias > 0) mensagem += `${dias} dia${dias > 1 ? 's' : ''} `;
                if (horas > 0) mensagem += `${horas}h `;
                if (minutos > 0 && dias === 0) mensagem += `${minutos}min `;

                statusTexto.textContent = mensagem.trim();
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#FFF3CD';
                statusDiv.style.border = '1px solid #FFE69C';
                statusDiv.style.color = '#856404';

                // Desmarcar "Publicar imediatamente" quando agendar
                if (publicadoCheckbox) {
                    publicadoCheckbox.checked = false;
                }
            } else {
                // Data passada ou presente - publica√ß√£o imediata
                statusTexto.textContent = 'Publica√ß√£o imediata';
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#D4EDDA';
                statusDiv.style.border = '1px solid #C3E6CB';
                statusDiv.style.color = '#155724';

                // Marcar "Publicar imediatamente" quando data for presente/passada
                if (publicadoCheckbox) {
                    publicadoCheckbox.checked = true;
                }
            }
        }

        // Inicializar quando o DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function () {
                initQuill();

                // Monitorar mudan√ßas no campo de data
                const dataInput = document.getElementById('dataPublicacao');
                if (dataInput) {
                    dataInput.addEventListener('change', verificarAgendamento);
                    dataInput.addEventListener('input', verificarAgendamento);
                    // Verificar inicialmente
                    verificarAgendamento();
                }
            });
        } else {
            // DOM j√° est√° pronto
            initQuill();

            // Monitorar mudan√ßas no campo de data
            const dataInput = document.getElementById('dataPublicacao');
            if (dataInput) {
                dataInput.addEventListener('change', verificarAgendamento);
                dataInput.addEventListener('input', verificarAgendamento);
                // Verificar inicialmente
                verificarAgendamento();
            }
        }

        // Salvar como rascunho
        function salvarRascunho() {
            // Preparar conte√∫do
            let content;
            if (editorMode === 'code') {
                const textarea = document.getElementById('conteudo');
                content = textarea.value.trim();
            } else {
                content = quill.root.innerHTML;
            }

            // Valida√ß√µes b√°sicas
            const titulo = document.querySelector('input[name="titulo"]').value.trim();

            if (!titulo) {
                alert('Por favor, adicione um t√≠tulo ao rascunho!');
                document.querySelector('input[name="titulo"]').focus();
                return;
            }

            if (!content || content === '<p><br></p>') {
                alert('Por favor, adicione algum conte√∫do ao rascunho!');
                return;
            }

            // Criar FormData
            const form = document.querySelector('.post-form');
            const btnRascunho = event.target;
            const originalText = btnRascunho.innerHTML;
            btnRascunho.disabled = true;
            btnRascunho.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json'
                }
            })
                .then(async response => {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return response.json();
                    } else {
                        const text = await response.text();
                        throw new Error(text || 'Erro desconhecido');
                    }
                })
                .then(data => {
                    if (data.success) {
                        alert('‚úÖ Rascunho salvo com sucesso!');
                        // Redirecionar para a listagem de posts
                        window.location.href = '/dashboard/posts';
                    } else {
                        alert('‚ùå Erro ao salvar rascunho: ' + (data.message || 'Erro desconhecido'));
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('‚ùå Erro ao salvar rascunho: ' + error.message);
                })
                .finally(() => {
                    btnRascunho.disabled = false;
                    btnRascunho.innerHTML = originalText;
                });
        }

        // Preparar submit
        function prepareSubmit() {
            // Se estiver no modo c√≥digo, usar o valor do textarea
            if (editorMode === 'code') {
                const textarea = document.getElementById('conteudo');
                // O valor j√° est√° no textarea, n√£o precisa fazer nada
                if (textarea.value.trim().length === 0) {
                    alert('Por favor, adicione conte√∫do ao post!');
                    textarea.focus();
                    return false;
                }

                // Adicionar embed do Instagram de volta se existir
                if (typeof embedInstagram !== 'undefined' && embedInstagram) {
                    textarea.value += embedInstagram;
                    console.log('üì± Embed do Instagram adicionado de volta ao conte√∫do (modo c√≥digo)');
                }
            } else {
                // Se estiver no modo visual, usar o Quill
                let content = quill.root.innerHTML;

                // Adicionar embed do Instagram de volta se existir
                if (typeof embedInstagram !== 'undefined' && embedInstagram) {
                    content += embedInstagram;
                    console.log('üì± Embed do Instagram adicionado de volta ao conte√∫do (modo visual)');
                }

                document.getElementById('conteudo').value = content;

                // Validar se o conte√∫do n√£o est√° vazio
                const text = quill.getText().trim();
                if (text.length === 0) {
                    alert('Por favor, adicione conte√∫do ao post!');
                    quill.focus();
                    return false;
                }
            }

            return true;
        }

        // Converter links do YouTube em embeds automaticamente
        let youtubeConvertTimeout = null;
        let isConvertingYoutube = false;
        function convertYouTubeLinksToEmbed() {
            if (youtubeConvertTimeout) clearTimeout(youtubeConvertTimeout);
            if (isConvertingYoutube) return;
            
            youtubeConvertTimeout = setTimeout(() => {
                try {
                    if (!quill || !quill.root) return;
                    
                    const content = quill.root.innerHTML;
                    if (!content) return;
                    
                    // Padr√µes de URL do YouTube
                    const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/shorts\/)([a-zA-Z0-9_-]{11})/g;
                    
                    let newContent = content;
                    let hasChanges = false;
                    let match;
                    
                    while ((match = youtubeRegex.exec(content)) !== null) {
                        const fullUrl = match[0];
                        const videoId = match[1];
                        
                        // Pular se j√° tem embed deste v√≠deo
                        if (newContent.includes('youtube.com/embed/' + videoId)) continue;
                        
                        // Pular se est√° dentro de src ou href
                        const idx = match.index;
                        const before = content.substring(Math.max(0, idx - 10), idx);
                        if (before.includes('src=') || before.includes('href=')) continue;
                        
                        // Criar embed
                        const embed = '<p><br></p><div class="video-container" style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;max-width:100%;margin:15px 0;"><iframe src="https://www.youtube.com/embed/' + videoId + '" style="position:absolute;top:0;left:0;width:100%;height:100%;border:0;" allow="accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture" allowfullscreen loading="lazy"></iframe></div><p><br></p>';
                        
                        newContent = newContent.replace(fullUrl, embed);
                        hasChanges = true;
                        console.log('üé¨ YouTube convertido:', videoId);
                    }
                    
                    if (hasChanges) {
                        isConvertingYoutube = true;
                        const delta = quill.clipboard.convert(newContent);
                        quill.setContents(delta, 'silent');
                        isConvertingYoutube = false;
                    }
                } catch (e) {
                    console.error('Erro ao converter YouTube:', e);
                    isConvertingYoutube = false;
                }
            }, 1000);
        }

        // FACT-CHECK - Toggle campos
        function toggleFactCheckFields() {
            const checkbox = document.getElementById('isFactCheck');
            const fields = document.getElementById('factCheckFields');
            if (checkbox.checked) {
                fields.style.display = 'block';
            } else {
                fields.style.display = 'none';
            }
        }

        // BIBLIOTECA DE M√çDIA
        let mediaLibraryData = [];
        let selectedMedia = [];
        let mediaLibraryMode = 'featured'; // 'featured' ou 'content'
        let selectMode = false; // Modo de selecao multipla

        function openMediaLibrary(mode = 'featured') {
            mediaLibraryMode = mode;
            selectedMedia = [];
            selectMode = false;
            const modal = document.getElementById('mediaLibraryModal');
            modal.classList.add('active');
            modal.style.display = 'flex';
            loadMediaLibrary();
            updateSelectedCount();
            // Resetar botao de selecao
            const btn = document.getElementById('btnSelectMode');
            if (btn) {
                btn.innerHTML = '<i class="fas fa-check-square"></i> Selecionar';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            }
        }

        function closeMediaLibrary() {
            console.log('closeMediaLibrary chamada');
            const modal = document.getElementById('mediaLibraryModal');
            modal.style.display = 'none';
            modal.classList.remove('active');
            selectedMedia = [];
            console.log('Modal escondido!');
        }

        function switchModalTab(tab, event) {
            document.querySelectorAll('.modal-tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.modal-tab-content').forEach(c => c.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Fallback: encontrar o bot√£o pela tab
                document.querySelector(`[onclick*="'${tab}'"]`)?.classList.add('active');
            }
            document.getElementById('modal-' + tab).classList.add('active');
        }

        async function loadMediaLibrary() {
            const tipo = document.getElementById('mediaTypeFilter').value;
            const url = tipo ? `/dashboard/media?tipo=${tipo}` : '/dashboard/media';

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    mediaLibraryData = data.media;
                    renderMediaGrid(data.media);
                }
            } catch (error) {
                console.error('Erro ao carregar m√≠dia:', error);
                document.getElementById('mediaGrid').innerHTML = '<div class="loading">Erro ao carregar m√≠dia</div>';
            }
        }

        function renderMediaGrid(media) {
            const grid = document.getElementById('mediaGrid');

            if (media.length === 0) {
                grid.innerHTML = '<div class="loading">Nenhuma m√≠dia encontrada. Fa√ßa upload na aba "Fazer Upload".</div>';
                return;
            }

            grid.innerHTML = media.map(item => `
            <div class="media-item" data-id="${item.id}" data-url="${item.url}" data-tipo="${item.tipo}" onclick="toggleMediaSelection(${item.id}, '${item.url}', '${item.tipo}')">
                ${item.tipo === 'imagem' ? `
                    <button type="button" class="media-item-edit-btn" onclick="event.stopPropagation(); openImageEditor(${item.id}, '${item.url}')" title="Editar imagem">
                        <i class="fas fa-crop"></i>
                    </button>
                ` : ''}
                <div class="media-item-checkbox">
                    <i class="fas fa-check"></i>
                </div>
                ${item.tipo === 'imagem' ? `<img src="${item.url}" alt="${item.nomeOriginal}">` : ''}
                ${item.tipo === 'video' ? `<div style="display:flex;align-items:center;justify-content:center;height:100%;"><i class="fas fa-video" style="font-size:48px;color:#666;"></i></div>` : ''}
                ${item.tipo === 'audio' ? `<div style="display:flex;align-items:center;justify-content:center;height:100%;"><i class="fas fa-music" style="font-size:48px;color:#666;"></i></div>` : ''}
                <div class="media-item-info">${item.nomeOriginal}</div>
            </div>
        `).join('');
        }

        function toggleMediaSelection(id, url, tipo) {
            const item = document.querySelector(`.media-item[data-id="${id}"]`);
            const index = selectedMedia.findIndex(m => m.id === id);

            if (index > -1) {
                // Desselecionar
                selectedMedia.splice(index, 1);
                item.classList.remove('selected');
            } else {
                // Selecionar
                // No modo featured, permitir apenas uma selecao por vez
                if (mediaLibraryMode === 'featured' && !selectMode) {
                    // Desselecionar todos os outros
                    selectedMedia.forEach(m => {
                        const otherItem = document.querySelector(`.media-item[data-id="${m.id}"]`);
                        if (otherItem) otherItem.classList.remove('selected');
                    });
                    selectedMedia = [];
                }

                selectedMedia.push({ id, url, tipo });
                item.classList.add('selected');
            }

            updateSelectedCount();

            // Se modo 'ai-image' e e imagem, insere automaticamente na previa da IA
            if (mediaLibraryMode === 'ai-image' && tipo === 'imagem') {
                console.log('Modo ai-image detectado no clique! URL:', url);
                selectedMedia = [{ id, url, tipo }];
                selectMediaForAI(url);
            }
        }

        function selectMediaForFeatured(url) {
            document.getElementById('imagem').value = url;
            document.getElementById('previewImg').src = url;
            document.getElementById('imagePreview').style.display = 'block';
            closeMediaLibrary();
        }

        function selectMediaForAI(url) {
            console.log('selectMediaForAI chamada com URL:', url);
            const inputElement = document.getElementById('aiImagemDestaque');
            const imgElement = document.getElementById('aiImagePreviewImg');
            const previewElement = document.getElementById('aiImagePreview');

            console.log('Elementos encontrados:', {
                input: !!inputElement,
                img: !!imgElement,
                preview: !!previewElement
            });

            if (inputElement) inputElement.value = url;
            if (imgElement) imgElement.src = url;
            if (previewElement) previewElement.style.display = 'block';

            console.log('Fechando biblioteca...');
            closeMediaLibrary();
            console.log('Biblioteca fechada!');
        }

        function toggleSelectMode() {
            selectMode = !selectMode;
            const btn = document.getElementById('btnSelectMode');

            if (selectMode) {
                btn.innerHTML = '<i class="fas fa-times"></i> Cancelar';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
            } else {
                btn.innerHTML = '<i class="fas fa-check-square"></i> Selecionar';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
                cancelSelection();
            }
        }

        function cancelSelection() {
            selectedMedia = [];
            document.querySelectorAll('.media-item.selected').forEach(item => {
                item.classList.remove('selected');
            });
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const count = selectedMedia.length;

            // Atualizar texto na barra de selecao
            const countText = document.getElementById('selectedCountText');
            if (countText) countText.textContent = count;

            // Mostrar/ocultar barra de selecao
            const selectionBar = document.getElementById('mediaSelectionBar');
            if (selectionBar) {
                if (count > 0) {
                    selectionBar.classList.add('active');
                } else {
                    selectionBar.classList.remove('active');
                }
            }
        }

        async function deleteSelectedMedia() {
            if (selectedMedia.length === 0) {
                alert('Selecione pelo menos uma midia para excluir.');
                return;
            }

            const confirmMsg = selectedMedia.length === 1
                ? 'Deseja excluir esta midia?'
                : `Deseja excluir ${selectedMedia.length} midias selecionadas?`;

            if (!confirm(confirmMsg)) return;

            let successCount = 0;
            let errorCount = 0;

            for (const media of selectedMedia) {
                try {
                    const response = await fetch(`/dashboard/media/${media.id}`, {
                        method: 'DELETE'
                    });
                    const data = await response.json();
                    if (data.success) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    console.error('Erro ao excluir midia:', error);
                    errorCount++;
                }
            }

            if (successCount > 0) {
                alert(`${successCount} midia(s) excluida(s) com sucesso!`);
            }
            if (errorCount > 0) {
                alert(`Erro ao excluir ${errorCount} midia(s).`);
            }

            cancelSelection();
            loadMediaLibrary();
        }

        function useSelectedMedia() {
            if (selectedMedia.length === 0) {
                alert('Selecione pelo menos uma midia.');
                return;
            }

            // Se for imagem destaque, usar a primeira selecionada
            if (mediaLibraryMode === 'featured' && selectedMedia[0].tipo === 'imagem') {
                selectMediaForFeatured(selectedMedia[0].url);
            } else if (mediaLibraryMode === 'content') {
                // Inserir todas as imagens no conteudo
                selectedMedia.forEach(media => {
                    if (media.tipo === 'imagem') {
                        insertMediaToContent(media.url);
                    }
                });
                closeMediaLibrary();
            }

            cancelSelection();
        }

        function filterMedia() {
            const search = document.getElementById('mediaSearch').value.toLowerCase();
            const filtered = mediaLibraryData.filter(item =>
                item.nomeOriginal.toLowerCase().includes(search)
            );
            renderMediaGrid(filtered);
        }

        async function handleModalUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            const progressDiv = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            progressDiv.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'Enviando...';

            try {
                const xhr = new XMLHttpRequest();

                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = (e.loaded / e.total) * 100;
                        progressFill.style.width = percent + '%';
                        progressText.textContent = `Enviando... ${Math.round(percent)}%`;
                    }
                });

                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        const data = JSON.parse(xhr.responseText);
                        if (data.success) {
                            progressText.textContent = 'Upload conclu√≠do!';
                            setTimeout(() => {
                                progressDiv.style.display = 'none';
                                document.getElementById('fileInputModal').value = '';
                                switchModalTab('biblioteca');
                                loadMediaLibrary();
                                selectMedia(data.media.url);
                            }, 1000);
                        }
                    } else {
                        progressText.textContent = 'Erro no upload';
                    }
                });

                xhr.open('POST', '/dashboard/media/upload');
                xhr.send(formData);

            } catch (error) {
                console.error('Erro no upload:', error);
                progressText.textContent = 'Erro no upload';
            }
        }

        // Buscar imagens no Bing
        async function buscarImagensBing() {
            const inputElement = document.getElementById('bingSearchInput');
            const query = inputElement.value.trim();

            if (!query) {
                alert('Por favor, digite uma palavra-chave para buscar');
                inputElement.focus();
                return;
            }

            const resultsDiv = document.getElementById('bingSearchResults');
            const loadingDiv = document.getElementById('bingSearchLoading');

            // Limpar resultados anteriores
            resultsDiv.innerHTML = '';
            loadingDiv.style.display = 'block';

            // Desabilitar bot√£o durante a busca
            const searchBtn = event?.target || document.querySelector('[onclick="buscarImagensBing()"]');
            if (searchBtn) {
                searchBtn.disabled = true;
                searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
            }

            try {
                const response = await fetch('/api/ia/buscar-imagens-bing', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });

                const data = await response.json();
                loadingDiv.style.display = 'none';

                if (data.success && data.imagens && data.imagens.length > 0) {
                    renderBingImages(data.imagens);
                    console.log(`‚úÖ ${data.imagens.length} imagens encontradas no Bing`);
                } else {
                    resultsDiv.innerHTML = `
                    <div class="bing-placeholder">
                        <i class="fas fa-exclamation-circle" style="font-size: 48px; color: #ff9800; margin-bottom: 16px;"></i>
                        <p style="color: #666;">Nenhuma imagem encontrada para "${query}"</p>
                        <p style="color: #999; font-size: 13px;">Tente usar outras palavras-chave</p>
                    </div>
                `;
                }
            } catch (error) {
                console.error('Erro ao buscar imagens no Bing:', error);
                loadingDiv.style.display = 'none';
                resultsDiv.innerHTML = `
                <div class="bing-placeholder">
                    <i class="fas fa-times-circle" style="font-size: 48px; color: #f44336; margin-bottom: 16px;"></i>
                    <p style="color: #666;">Erro ao buscar imagens</p>
                    <p style="color: #999; font-size: 13px;">${error.message}</p>
                </div>
            `;
            } finally {
                // Reabilitar bot√£o
                if (searchBtn) {
                    searchBtn.disabled = false;
                    searchBtn.innerHTML = '<i class="fas fa-search"></i> Buscar Imagens';
                }
            }
        }

        function renderBingImages(imagens) {
            const resultsDiv = document.getElementById('bingSearchResults');
            resultsDiv.innerHTML = imagens.map((img, index) => `
            <div class="bing-image-item">
                <img src="${img.thumbnail || img.url}" alt="${img.descricao}" loading="lazy" onerror="this.src='https://via.placeholder.com/300x300?text=Erro+ao+carregar'">
                <div class="bing-image-overlay">
                    <span class="bing-image-info" title="${img.descricao}">${img.fonte || 'Bing'}</span>
                    <button type="button" class="bing-image-select" onclick="selecionarImagemBing('${img.url.replace(/'/g, "\\'")}', '${(img.descricao || '').replace(/'/g, "\\'")}')">
                        <i class="fas fa-check"></i> Usar
                    </button>
                </div>
            </div>
        `).join('');
        }

        async function selecionarImagemBing(url, descricao) {
            try {
                // Fazer upload da imagem URL para o servidor
                const response = await fetch('/dashboard/media/upload-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, descricao })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Imagem adicionada √† biblioteca com sucesso!');
                    switchModalTab('biblioteca');
                    loadMediaLibrary();
                    // Selecionar automaticamente a imagem rec√©m-adicionada
                    setTimeout(() => {
                        selectMedia(data.media.url);
                    }, 500);
                } else {
                    alert('Erro ao adicionar imagem: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao selecionar imagem:', error);
                alert('Erro ao adicionar imagem √† biblioteca');
            }
        }

        // Buscar imagens no Google
        async function buscarImagensGoogle() {
            const inputElement = document.getElementById('googleSearchInput');
            const query = inputElement.value.trim();

            if (!query) {
                alert('Por favor, digite uma palavra-chave para buscar');
                inputElement.focus();
                return;
            }

            const resultsDiv = document.getElementById('googleSearchResults');
            const loadingDiv = document.getElementById('googleSearchLoading');

            // Limpar resultados anteriores
            resultsDiv.innerHTML = '';
            loadingDiv.style.display = 'block';

            // Desabilitar bot√£o durante a busca
            const searchBtn = event?.target || document.querySelector('[onclick="buscarImagensGoogle()"]');
            if (searchBtn) {
                searchBtn.disabled = true;
                searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
            }

            try {
                const response = await fetch('/api/ia/buscar-imagens-google', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });

                const data = await response.json();
                loadingDiv.style.display = 'none';

                if (data.success && data.imagens && data.imagens.length > 0) {
                    renderGoogleImages(data.imagens);
                    console.log(`‚úÖ ${data.imagens.length} imagens encontradas no Google`);
                } else {
                    resultsDiv.innerHTML = `
                    <div class="bing-placeholder">
                        <i class="fas fa-exclamation-circle" style="font-size: 48px; color: #ff9800; margin-bottom: 16px;"></i>
                        <p style="color: #666;">Nenhuma imagem encontrada para "${query}"</p>
                        <p style="color: #999; font-size: 13px;">Tente usar outras palavras-chave</p>
                    </div>
                `;
                }
            } catch (error) {
                console.error('Erro ao buscar imagens no Google:', error);
                loadingDiv.style.display = 'none';
                resultsDiv.innerHTML = `
                <div class="bing-placeholder">
                    <i class="fas fa-times-circle" style="font-size: 48px; color: #f44336; margin-bottom: 16px;"></i>
                    <p style="color: #666;">Erro ao buscar imagens</p>
                    <p style="color: #999; font-size: 13px;">${error.message}</p>
                </div>
            `;
            } finally {
                // Reabilitar bot√£o
                if (searchBtn) {
                    searchBtn.disabled = false;
                    searchBtn.innerHTML = '<i class="fab fa-google"></i> Buscar Imagens';
                }
            }
        }

        function renderGoogleImages(imagens) {
            const resultsDiv = document.getElementById('googleSearchResults');
            resultsDiv.innerHTML = imagens.map((img, index) => `
            <div class="bing-image-item">
                <img src="${img.thumbnail || img.url}" alt="${img.descricao}" loading="lazy" onerror="this.src='https://via.placeholder.com/300x300?text=Erro+ao+carregar'">
                <div class="bing-image-overlay">
                    <span class="bing-image-info" title="${img.descricao}">${img.fonte || 'Google'}</span>
                    <button type="button" class="bing-image-select" onclick="selecionarImagemGoogle('${img.url.replace(/'/g, "\\'")}', '${(img.descricao || '').replace(/'/g, "\\'")}')">
                        <i class="fas fa-check"></i> Usar
                    </button>
                </div>
            </div>
        `).join('');
        }

        async function selecionarImagemGoogle(url, descricao) {
            try {
                // Fazer upload da imagem URL para o servidor
                const response = await fetch('/dashboard/media/upload-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, descricao })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Imagem adicionada √† biblioteca com sucesso!');
                    switchModalTab('biblioteca');
                    loadMediaLibrary();
                    // Selecionar automaticamente a imagem rec√©m-adicionada
                    setTimeout(() => {
                        selectMedia(data.media.url);
                    }, 500);
                } else {
                    alert('Erro ao adicionar imagem: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao selecionar imagem do Google:', error);
                alert('Erro ao adicionar imagem √† biblioteca');
            }
        }

        // Deletar m√≠dia selecionada
        function selectMedia(url) {
            console.log('selectMedia chamada com URL:', url);
            // Tenta encontrar o item na biblioteca carregada
            const item = mediaLibraryData.find(m => m.url === url);

            if (item) {
                console.log('Item encontrado na biblioteca:', item);
                // Se j√° estiver selecionado, n√£o faz nada
                const isSelected = selectedMedia.some(m => m.id === item.id);
                if (!isSelected) {
                    toggleMediaSelection(item.id, item.url, item.tipo);
                }
            } else {
                console.log('Item n√£o encontrado na biblioteca local, for√ßando sele√ß√£o direta...');
                // Fallback: Selecionar diretamente baseado no modo atual
                if (mediaLibraryMode === 'featured') {
                    selectMediaForFeatured(url);
                } else if (mediaLibraryMode === 'ai-image') {
                    selectMediaForAI(url);
                } else {
                    // Modo content ou outro
                    // Adicionar mock ao selectedMedia para insertSelectedMedia funcionar
                    selectedMedia.push({ id: Date.now(), url: url, tipo: 'imagem' }); // Assumindo imagem
                    updateSelectedCount();
                }
            }
        }

        async function deleteSelectedMedia() {
            if (selectedMedia.length === 0) return;

            if (!confirm(`Deseja realmente excluir ${selectedMedia.length} arquivo(s)?`)) return;

            try {
                for (const media of selectedMedia) {
                    await fetch(`/dashboard/media/${media.id}`, { method: 'DELETE' });
                }

                selectedMedia = [];
                loadMediaLibrary();
                alert('Arquivos exclu√≠dos com sucesso!');
            } catch (error) {
                console.error('Erro ao deletar:', error);
                alert('Erro ao deletar arquivos');
            }
        }

        // Fun√ß√£o para usar m√≠dia selecionada (bot√£o "Usar")
        function useSelectedMedia() {
            if (selectedMedia.length === 0) {
                alert('Nenhuma m√≠dia selecionada');
                return;
            }

            console.log('useSelectedMedia - modo:', mediaLibraryMode);
            console.log('useSelectedMedia - selectedMedia:', selectedMedia);

            // Se estiver no modo featured (imagem destaque), usar apenas a primeira selecionada
            if (mediaLibraryMode === 'featured') {
                if (selectedMedia.length > 0) {
                    selectMediaForFeatured(selectedMedia[0].url);
                    return;
                }
            }

            // Se estiver no modo ai-image, inserir na pr√©via da IA
            if (mediaLibraryMode === 'ai-image') {
                console.log('Modo ai-image detectado');
                if (selectedMedia.length > 0 && selectedMedia[0].tipo === 'imagem') {
                    console.log('Chamando selectMediaForAI com URL:', selectedMedia[0].url);
                    selectMediaForAI(selectedMedia[0].url);
                    return;
                } else {
                    alert('Por favor, selecione apenas uma imagem');
                    return;
                }
            }

            // Modo content - inserir no editor Quill
            insertSelectedMedia();
        }

        // Inserir m√≠dia no editor Quill
        function insertSelectedMedia() {
            if (selectedMedia.length === 0) {
                alert('Nenhuma m√≠dia selecionada');
                return;
            }

            // Modo normal - inserir no editor Quill
            const range = quill.getSelection(true);
            const position = range ? range.index : quill.getLength();

            selectedMedia.forEach((media, index) => {
                if (media.tipo === 'imagem') {
                    quill.insertEmbed(position + index, 'image', media.url);
                    quill.insertText(position + index + 1, '\n');
                } else if (media.tipo === 'video') {
                    quill.insertEmbed(position + index, 'video', media.url);
                    quill.insertText(position + index + 1, '\n');
                } else if (media.tipo === 'audio') {
                    // Para √°udio, inserir como link
                    quill.insertText(position + index, `üéµ √Åudio: `);
                    quill.insertText(position + index + 9, media.url, 'link', media.url);
                    quill.insertText(position + index + 9 + media.url.length, '\n');
                }
            });

            closeMediaLibrary();
            alert(`${selectedMedia.length} arquivo(s) inserido(s) no conte√∫do!`);
        }

        // Remover imagem destaque
        function removeImage() {
            document.getElementById('imagem').value = '';
            document.getElementById('imagePreview').style.display = 'none';
        }

        // Fechar modal ao clicar fora
        document.getElementById('mediaLibraryModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeMediaLibrary();
            }
        });

        // ============================================
        // FUN√á√ïES DA IA
        // ============================================

        // Abrir modal para criar mat√©ria com IA
        function openAIModal() {
            document.getElementById('aiModal').style.display = 'flex';
        }

        // Fechar modal da IA
        function closeAIModal() {
            document.getElementById('aiModal').style.display = 'none';
        }

        // Vari√°vel para controlar se a biblioteca foi aberta pela IA
        let mediaLibraryForAI = false;

        // Abrir biblioteca de m√≠dia para selecionar imagem da IA
        function openMediaLibraryForAI() {
            console.log('openMediaLibraryForAI chamada');
            mediaLibraryForAI = true;
            mediaLibraryMode = 'ai-image';
            selectedMedia = [];
            console.log('Modo definido como:', mediaLibraryMode);
            document.getElementById('mediaLibraryModal').style.display = 'flex';
            loadMediaLibrary();
            updateSelectedCount();
        }

        // Remover imagem selecionada da IA
        function removeAIImage() {
            document.getElementById('aiImagemDestaque').value = '';
            document.getElementById('aiImagePreview').style.display = 'none';
        }

        // Selecionar imagem sugerida
        function selecionarImagemSugerida(url) {
            document.getElementById('imagem').value = url;
            document.getElementById('previewImg').src = url;
            document.getElementById('imagePreview').style.display = 'block';
            alert('‚úÖ Imagem selecionada! A mat√©ria j√° est√° pronta para publica√ß√£o.');
        }

        // Selecionar imagem sugerida e fechar modal
        function selecionarImagemSugeridaEFechar(url) {
            document.getElementById('imagem').value = url;
            document.getElementById('previewImg').src = url;
            document.getElementById('imagePreview').style.display = 'block';
            closeAIModal();
            alert('‚úÖ Mat√©ria criada com sucesso! Imagem selecionada. Revise e publique.');
        }

        // Finalizar sem imagem
        function finalizarSemImagem() {
            closeAIModal();
            alert('‚úÖ Mat√©ria criada com sucesso! Voc√™ pode adicionar uma imagem depois.');
        }

        // Trocar tab da IA
        function switchAITab(tab) {
            document.querySelectorAll('.ai-tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.ai-tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById('ai-tab-' + tab).classList.add('active');
        }

        // Expandir conte√∫do com IA
        async function expandirConteudoComIA() {
            const informacoes = document.getElementById('aiConteudoInformacoes').value;

            if (!informacoes || informacoes.trim().length < 20) {
                alert('Por favor, forne√ßa pelo menos algumas informa√ß√µes b√°sicas (m√≠nimo 20 caracteres)');
                return;
            }

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Expandindo...';

            try {
                const response = await fetch('/api/ia/expandir-conteudo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        conteudo: informacoes
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Substituir o conte√∫do pelo expandido
                    document.getElementById('aiConteudoInformacoes').value = data.conteudoExpandido;
                    alert('‚úÖ Conte√∫do expandido com sucesso! Revise e clique em "Gerar Mat√©ria" quando estiver pronto.');
                } else {
                    alert('‚ùå Erro: ' + (data.error || 'N√£o foi poss√≠vel expandir o conte√∫do'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao expandir conte√∫do: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Criar mat√©ria por tema (aba "Por Tema")
        async function criarComIA() {
            const tema = document.getElementById('aiTema').value.trim();
            const categoria = document.getElementById('aiCategoria').value;
            const palavrasChave = document.getElementById('aiPalavrasChave').value;
            const pesquisarInternet = document.getElementById('aiPesquisarInternet').checked;
            const linksText = document.getElementById('aiLinks').value.trim();
            const modoAutomatico = document.getElementById('aiModoAutomatico').checked;

            if (!tema) {
                alert('Por favor, digite o tema da mat√©ria');
                document.getElementById('aiTema').focus();
                return;
            }

            // Processar links (um por linha)
            const links = linksText ? linksText.split('\n').map(l => l.trim()).filter(l => l) : [];

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            // Mostrar mensagem de acordo com as op√ß√µes selecionadas
            if (pesquisarInternet) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> üåê Pesquisando na internet e gerando mat√©ria...';
            } else {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando mat√©ria...';
            }

            try {
                const response = await fetch('/api/ia/criar-materia', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tema,
                        categoria,
                        palavrasChave,
                        pesquisarInternet,
                        links
                    })
                });

                const data = await response.json();

                if (data.success) {
                    await processarRespostaMateria(data, modoAutomatico);
                } else {
                    alert('‚ùå Erro ao criar mat√©ria: ' + (data.error || 'Erro desconhecido'));
                }

            } catch (error) {
                console.error('Erro ao criar mat√©ria:', error);
                alert('‚ùå Erro ao criar mat√©ria: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Criar mat√©ria por conte√∫do
        async function criarPorConteudo() {
            const tituloSugerido = document.getElementById('aiConteudoTitulo').value;
            const informacoes = document.getElementById('aiConteudoInformacoes').value;
            const categoria = document.getElementById('aiConteudoCategoria').value;
            const palavrasChave = document.getElementById('aiConteudoPalavrasChave').value;
            const imagemDestaque = document.getElementById('aiConteudoImagemDestaque').value;
            const modoAutomatico = document.getElementById('aiConteudoModoAutomatico').checked;

            if (!informacoes || informacoes.trim().length < 50) {
                alert('Por favor, forne√ßa informa√ß√µes suficientes (m√≠nimo 50 caracteres)');
                return;
            }

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando mat√©ria humanizada...';

            try {
                const response = await fetch('/api/ia/criar-por-conteudo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tituloSugerido,
                        informacoes,
                        categoria,
                        palavrasChave,
                        modoAutomatico
                    })
                });

                const data = await response.json();
                console.log('Resposta completa da API:', data);

                if (data.success && data.materia) {
                    // Preencher os campos
                    document.getElementById('titulo').value = data.materia.titulo;
                    document.getElementById('descricao').value = data.materia.descricao;
                    quill.root.innerHTML = data.materia.conteudo;

                    // Se tiver imagem selecionada manualmente, preencher
                    if (imagemDestaque) {
                        document.getElementById('imagem').value = imagemDestaque;
                        document.getElementById('previewImg').src = imagemDestaque;
                        document.getElementById('imagePreview').style.display = 'block';
                    }

                    // Se modo autom√°tico e houver imagens sugeridas
                    if (modoAutomatico && data.materia.imagensSugeridas && data.materia.imagensSugeridas.length > 0) {
                        const primeiraImagem = data.materia.imagensSugeridas[0];
                        document.getElementById('imagem').value = primeiraImagem.url;
                        document.getElementById('previewImg').src = primeiraImagem.url;
                        document.getElementById('imagePreview').style.display = 'block';
                    }

                    closeAIModal();
                    alert('‚úÖ Mat√©ria criada com sucesso! Conte√∫do humanizado e sem pl√°gio. Revise e publique!');
                } else {
                    alert('‚ùå Erro: ' + (data.error || 'N√£o foi poss√≠vel criar a mat√©ria'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao criar mat√©ria: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Criar mat√©ria por link
        async function criarPorLink() {
            const linkUrl = document.getElementById('aiLinkUrl').value;
            const textoPostagem = document.getElementById('aiLinkTexto').value;
            const categoria = document.getElementById('aiLinkCategoria').value;
            const modoAutomatico = document.getElementById('aiLinkModoAutomatico').checked;
            const pesquisarInternet = document.getElementById('aiLinkPesquisarInternet').checked;
            const transcreverVideo = document.getElementById('aiLinkTranscreverVideo').checked;

            if (!linkUrl && !textoPostagem) {
                alert('Por favor, cole o link da postagem OU o texto manualmente');
                return;
            }

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;

            // Se tem texto manual, usar direto
            if (textoPostagem) {
                btn.innerHTML = pesquisarInternet
                    ? '<i class="fas fa-spinner fa-spin"></i> Gerando mat√©ria e pesquisando na internet...'
                    : '<i class="fas fa-spinner fa-spin"></i> Gerando mat√©ria do texto...';

                try {
                    const response = await fetch('/api/ia/criar-por-texto', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            texto: textoPostagem,
                            linkReferencia: linkUrl,
                            categoria,
                            pesquisarInternet
                        })
                    });

                    const data = await response.json();
                    await processarRespostaMateria(data, modoAutomatico);

                } catch (error) {
                    console.error('Erro:', error);
                    alert('‚ùå Erro ao criar mat√©ria: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
                return;
            }

            // Se tem apenas link, tentar extrair automaticamente
            // Detectar tipo de link para mensagem apropriada
            const isVideo = linkUrl.includes('/reel') || linkUrl.includes('/reels') ||
                linkUrl.includes('/watch') || linkUrl.includes('fb.watch') ||
                linkUrl.includes('/videos/');

            let loadingMsg = '<i class="fas fa-spinner fa-spin"></i> ';
            if (isVideo && transcreverVideo) {
                loadingMsg += 'üé• Transcrevendo v√≠deo';
                if (pesquisarInternet) loadingMsg += ' ‚Üí üåê Pesquisando';
                loadingMsg += ' ‚Üí ‚ú® Gerando mat√©ria...';
            } else if (pesquisarInternet) {
                loadingMsg += 'üì± Extraindo ‚Üí üåê Pesquisando ‚Üí ‚ú® Gerando mat√©ria...';
            } else {
                loadingMsg += 'üì± Extraindo e gerando mat√©ria...';
            }
            btn.innerHTML = loadingMsg;

            try {
                const response = await fetch('/api/ia/criar-por-link', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        link: linkUrl,
                        categoria,
                        pesquisarInternet,
                        transcreverVideo
                    })
                });

                const data = await response.json();

                if (data.success) {
                    await processarRespostaMateria(data, modoAutomatico);
                } else {
                    // Se erro de extra√ß√£o, mostrar mensagem espec√≠fica
                    if (data.error && data.error.includes('extrair')) {
                        alert('‚ùå ' + data.error + '\n\nüí° Dica: Cole o texto da postagem no campo "OU Cole o Texto Manualmente" e tente novamente.');
                        // Focar no campo de texto
                        document.getElementById('aiLinkTexto').focus();
                    } else {
                        alert('‚ùå Erro: ' + data.error);
                    }
                }

            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao criar mat√©ria: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Fun√ß√£o auxiliar para processar resposta da mat√©ria
        async function processarRespostaMateria(data, modoAutomatico) {
            console.log('Resposta da API:', data);
            console.log('Imagens sugeridas:', data.materia?.imagensSugeridas);

            if (data.success) {
                // Preencher os campos
                document.getElementById('titulo').value = data.materia.titulo;
                document.getElementById('descricao').value = data.materia.descricao;
                quill.root.innerHTML = data.materia.conteudo;

                // Mostrar sugest√µes de imagens se houver
                if (data.materia.imagensSugeridas && data.materia.imagensSugeridas.length > 0) {
                    // Se modo autom√°tico est√° ativo, selecionar primeira imagem automaticamente
                    if (modoAutomatico) {
                        console.log('Modo autom√°tico: selecionando primeira imagem automaticamente');
                        const primeiraImagem = data.materia.imagensSugeridas[0];

                        // Fazer upload da imagem do Google primeiro
                        try {
                            const uploadResponse = await fetch('/dashboard/media/upload-url', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    url: primeiraImagem.url,
                                    descricao: primeiraImagem.descricao || 'Imagem da mat√©ria'
                                })
                            });

                            const uploadData = await uploadResponse.json();

                            if (uploadData.success && uploadData.media) {
                                // Usar a URL local da imagem baixada
                                document.getElementById('imagem').value = uploadData.media.url;
                                document.getElementById('previewImg').src = uploadData.media.url;
                                document.getElementById('imagePreview').style.display = 'block';

                                closeAIModal();
                                alert('‚úÖ Mat√©ria criada com sucesso! Imagem selecionada automaticamente. Revise e publique!');
                                return;
                            } else {
                                console.error('Erro ao fazer upload da imagem:', uploadData.error);
                                // Continuar sem imagem autom√°tica
                            }
                        } catch (error) {
                            console.error('Erro ao fazer upload autom√°tico da imagem:', error);
                            // Continuar sem imagem autom√°tica
                        }
                    }
                }

                closeAIModal();
                alert('‚úÖ Mat√©ria criada com sucesso! Revise e ajuste conforme necess√°rio.');
            } else {
                alert('‚ùå Erro: ' + data.error);
            }
        }

        // Toggle dropdown de IA para campos espec√≠ficos
        function toggleAIDropdownField(campo) {
            event.stopPropagation();
            const dropdown = document.getElementById(`aiDropdown${campo.charAt(0).toUpperCase() + campo.slice(1)}`);

            // Fechar outros dropdowns
            document.querySelectorAll('.ai-dropdown-menu').forEach(d => {
                if (d !== dropdown) {
                    d.classList.remove('active');
                }
            });

            dropdown.classList.toggle('active');
        }

        // Aplicar IA no campo com a√ß√£o espec√≠fica
        async function aplicarIACampo(campo, acao) {
            const elemento = document.getElementById(campo);
            const texto = elemento.value;

            if (!texto || texto.trim() === '') {
                alert('Campo vazio, nada para processar');
                return;
            }

            // Fechar dropdown
            const dropdown = document.getElementById(`aiDropdown${campo.charAt(0).toUpperCase() + campo.slice(1)}`);
            dropdown.classList.remove('active');

            // Desabilitar todos os bot√µes do dropdown
            const buttons = dropdown.querySelectorAll('.ai-dropdown-item');
            const clickedButton = event.target.closest('.ai-dropdown-item');
            const originalTexts = Array.from(buttons).map(btn => btn.innerHTML);

            buttons.forEach(btn => {
                btn.disabled = true;
            });

            if (clickedButton) {
                clickedButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
            }

            try {
                const endpoint = acao === 'corrigir' ? '/api/ia/corrigir-texto' : '/api/ia/tornar-polemico';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ texto, tipo: campo })
                });

                const data = await response.json();

                if (data.success) {
                    elemento.value = (data.textoCorrigido || data.textoPolemico || data.resultado).trim();
                    alert(acao === 'corrigir' ? '‚úÖ Texto corrigido!' : 'üî• T√≠tulo mais pol√™mico criado!');
                } else {
                    alert('‚ùå Erro: ' + data.error);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao processar: ' + error.message);
            } finally {
                // Restaurar bot√µes
                buttons.forEach((btn, index) => {
                    btn.disabled = false;
                    btn.innerHTML = originalTexts[index];
                });
            }
        }

        // Corrigir campo espec√≠fico (manter para compatibilidade)
        async function corrigirCampo(campo) {
            aplicarIACampo(campo, 'corrigir');
        }

        // Toggle dropdown IA
        function toggleAIDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('aiDropdownMenu');
            dropdown.classList.toggle('active');
        }

        // Fechar dropdown ao clicar fora
        document.addEventListener('click', function (event) {
            const dropdown = document.getElementById('aiDropdownMenu');
            const btnDropdown = document.querySelector('.btn-ai-dropdown');

            if (dropdown && !btnDropdown.contains(event.target)) {
                dropdown.classList.remove('active');
            }

            // Fechar dropdowns dos campos (t√≠tulo e descri√ß√£o)
            document.querySelectorAll('.ai-dropdown-menu').forEach(dropdown => {
                const wrapper = dropdown.closest('.ai-dropdown-wrapper');
                if (wrapper && !wrapper.contains(event.target)) {
                    dropdown.classList.remove('active');
                }
            });
        });

        // Corrigir conte√∫do do editor
        async function corrigirConteudo(tipo) {
            // Fechar dropdown
            document.getElementById('aiDropdownMenu').classList.remove('active');

            const html = quill.root.innerHTML;
            const texto = quill.getText();

            if (!texto || texto.trim() === '') {
                alert('Conte√∫do vazio, nada para processar');
                return;
            }

            const btn = document.querySelector('.btn-ai-correct');
            const originalText = btn.innerHTML;
            btn.disabled = true;

            if (tipo === 'corrigir') {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Corrigindo...';
            } else {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reescrevendo...';
            }

            try {
                let endpoint, bodyData, successMessage;

                if (tipo === 'corrigir') {
                    // Corrigir erros de portugu√™s
                    endpoint = '/api/ia/corrigir-texto';
                    bodyData = { texto: html, tipo: 'conteudo' };
                    successMessage = '‚úÖ Conte√∫do corrigido!';
                } else {
                    // Reescrever mat√©ria estilo G1
                    endpoint = '/api/ia/reescrever-materia';
                    bodyData = { conteudo: html };
                    successMessage = '‚úÖ Mat√©ria reescrita com sucesso!';
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bodyData)
                });

                const data = await response.json();

                if (data.success) {
                    quill.root.innerHTML = data.textoCorrigido || data.conteudo;
                    alert(successMessage);
                } else {
                    alert('‚ùå Erro: ' + data.error);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao processar: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Fechar modal da IA ao clicar fora
        document.getElementById('aiModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeAIModal();
            }
        });

        // ==================== ACRESCENTAR INFORMA√á√ÉO COM IA ====================
        function abrirModalAcrescentarInfo() {
            const titulo = document.getElementById('titulo').value;
            const conteudo = quill.root.innerHTML;
            const texto = quill.getText();

            if (!titulo && (!texto || texto.trim() === '')) {
                alert('‚ö†Ô∏è Voc√™ precisa ter pelo menos um t√≠tulo ou conte√∫do para acrescentar informa√ß√µes');
                return;
            }

            document.getElementById('modalAcrescentarInfo').style.display = 'flex';
            document.getElementById('instrucaoAcrescentar').value = '';
            document.getElementById('instrucaoAcrescentar').focus();
        }

        function fecharModalAcrescentarInfo() {
            document.getElementById('modalAcrescentarInfo').style.display = 'none';
        }

        // Alias para o botao Gerar com IA
        async function gerarAcrescentarInfo() {
            const instrucao = document.getElementById('instrucaoAcrescentar').value;

            if (!instrucao || instrucao.trim() === '') {
                alert('‚ö†Ô∏è Por favor, descreva o que voc√™ quer acrescentar ou modificar');
                document.getElementById('instrucaoAcrescentar').focus();
                return;
            }

            const tituloAtual = document.getElementById('titulo').value;
            const conteudoAtual = quill.root.innerHTML;

            const btn = document.getElementById('btnGerarAcrescentar');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';

            try {
                const response = await fetch('/api/ia/acrescentar-informacao', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        titulo: tituloAtual,
                        conteudo: conteudoAtual,
                        instrucao: instrucao
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Atualizar t√≠tulo se foi modificado
                    if (data.titulo && data.titulo !== tituloAtual) {
                        document.getElementById('titulo').value = data.titulo;
                    }

                    // Atualizar conte√∫do se foi modificado
                    if (data.conteudo && data.conteudo !== conteudoAtual) {
                        quill.root.innerHTML = data.conteudo;
                    }

                    fecharModalAcrescentarInfo();
                    alert('‚úÖ Modifica√ß√µes aplicadas com sucesso!');
                } else {
                    alert('‚ùå Erro: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao processar: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function aplicarAcrescentarInfo() {
            const instrucao = document.getElementById('instrucaoAcrescentar').value;

            if (!instrucao || instrucao.trim() === '') {
                alert('‚ö†Ô∏è Por favor, descreva o que voc√™ quer acrescentar ou modificar');
                return;
            }

            const tituloAtual = document.getElementById('titulo').value;
            const conteudoAtual = quill.root.innerHTML;
            const textoAtual = quill.getText();

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';

            try {
                const response = await fetch('/api/ia/acrescentar-informacao', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        titulo: tituloAtual,
                        conteudo: conteudoAtual,
                        instrucao: instrucao
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Atualizar t√≠tulo se foi modificado
                    if (data.titulo && data.titulo !== tituloAtual) {
                        document.getElementById('titulo').value = data.titulo;
                    }

                    // Atualizar conte√∫do se foi modificado
                    if (data.conteudo && data.conteudo !== conteudoAtual) {
                        quill.root.innerHTML = data.conteudo;
                    }

                    fecharModalAcrescentarInfo();
                    alert('‚úÖ Modifica√ß√µes aplicadas com sucesso!');
                } else {
                    alert('‚ùå Erro: ' + data.error);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao processar: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Fechar modal ao clicar fora
        document.getElementById('modalAcrescentarInfo').addEventListener('click', function (e) {
            if (e.target === this) {
                fecharModalAcrescentarInfo();
            }
        });

        // Fechar modal da IA ao clicar fora
        document.getElementById('aiModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeAIModal();
            }
        });

        // ==================== ASSISTENTE IA ====================
        function abrirAssistenteIA() {
            document.getElementById('modalAssistenteIA').style.display = 'flex';
            document.getElementById('assistenteInput').focus();
        }

        function fecharAssistenteIA() {
            document.getElementById('modalAssistenteIA').style.display = 'none';
        }

        // Fechar modal ao clicar fora
        document.getElementById('modalAssistenteIA').addEventListener('click', function (e) {
            if (e.target === this) {
                fecharAssistenteIA();
            }
        });

        async function enviarMensagemAssistente() {
            const input = document.getElementById('assistenteInput');
            const mensagem = input.value.trim();
            const pesquisarInternet = document.getElementById('assistentePesquisarInternet').checked;

            if (!mensagem) return;

            // Adicionar mensagem do usu√°rio ao chat
            const mensagensDiv = document.getElementById('assistenteMensagens');
            const pesquisaInfo = pesquisarInternet ? ' <span style="color: #22C55E; font-size: 11px;"><i class="fas fa-globe"></i> com pesquisa</span>' : '';
            mensagensDiv.innerHTML += `
                <div class="mensagem-usuario">
                    <div class="mensagem-avatar"><i class="fas fa-user"></i></div>
                    <div class="mensagem-conteudo"><p>${mensagem}${pesquisaInfo}</p></div>
                </div>
            `;

            input.value = '';
            input.disabled = true;

            // Adicionar indicador de carregamento
            const loadingMsg = pesquisarInternet
                ? '<i class="fas fa-spinner fa-spin"></i> Pesquisando na internet e gerando mat√©ria...'
                : '<i class="fas fa-spinner fa-spin"></i> Pensando...';
            mensagensDiv.innerHTML += `
                <div class="mensagem-ia" id="msgLoading">
                    <div class="mensagem-avatar"><i class="fas fa-robot"></i></div>
                    <div class="mensagem-conteudo"><p>${loadingMsg}</p></div>
                </div>
            `;
            mensagensDiv.scrollTop = mensagensDiv.scrollHeight;

            try {
                // Coletar contexto atual do post
                const tituloAtual = document.getElementById('titulo').value;
                const descricaoAtual = document.getElementById('descricao').value;
                const conteudoAtual = quill.getText();

                const response = await fetch('/api/ia/assistente', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mensagem,
                        pesquisarInternet,
                        contexto: {
                            titulo: tituloAtual,
                            descricao: descricaoAtual,
                            conteudo: conteudoAtual
                        }
                    })
                });

                const data = await response.json();

                // Remover loading
                document.getElementById('msgLoading').remove();

                if (data.success) {
                    // Mostrar resposta da IA
                    mensagensDiv.innerHTML += `
                        <div class="mensagem-ia">
                            <div class="mensagem-avatar"><i class="fas fa-robot"></i></div>
                            <div class="mensagem-conteudo"><p>${data.resposta}</p></div>
                        </div>
                    `;

                    // Se tem sugest√µes, mostrar
                    if (data.sugestoes && data.sugestoes.length > 0) {
                        mostrarSugestoes(data.sugestoes);
                    }
                } else {
                    mensagensDiv.innerHTML += `
                        <div class="mensagem-ia">
                            <div class="mensagem-avatar"><i class="fas fa-robot"></i></div>
                            <div class="mensagem-conteudo"><p>Desculpe, ocorreu um erro: ${data.error}</p></div>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('msgLoading')?.remove();
                mensagensDiv.innerHTML += `
                    <div class="mensagem-ia">
                        <div class="mensagem-avatar"><i class="fas fa-robot"></i></div>
                        <div class="mensagem-conteudo"><p>Erro ao processar: ${error.message}</p></div>
                    </div>
                `;
            } finally {
                input.disabled = false;
                input.focus();
                mensagensDiv.scrollTop = mensagensDiv.scrollHeight;
            }
        }

        function mostrarSugestoes(sugestoes) {
            const sugestoesDiv = document.getElementById('assistenteSugestoes');
            const listaDiv = document.getElementById('sugestoesLista');

            listaDiv.innerHTML = sugestoes.map((s, i) => {
                // Para campo "todos", mostrar preview do t√≠tulo
                let textoPreview = s.texto;
                if (s.campo === 'todos') {
                    textoPreview = s.titulo ? `<strong>${s.titulo}</strong><br><small style="color:#666;">${(s.descricao || '').substring(0, 100)}...</small>` : 'Mat√©ria completa';
                }
                const campoLabel = s.campo === 'todos' ? 'Mat√©ria Completa' : s.campo;
                return `
                    <div class="sugestao-item" onclick="aplicarSugestao(${i})">
                        <div class="sugestao-texto">${textoPreview}</div>
                        <span class="sugestao-campo">${campoLabel}</span>
                        <button type="button" class="btn-aplicar-sugestao">Aplicar</button>
                    </div>
                `;
            }).join('');

            sugestoesDiv.style.display = 'block';
            window.sugestoesAtuais = sugestoes;
        }

        function aplicarSugestao(index) {
            const sugestao = window.sugestoesAtuais[index];
            if (!sugestao) return;

            switch (sugestao.campo) {
                case 'titulo':
                    document.getElementById('titulo').value = sugestao.texto;
                    break;
                case 'descricao':
                    document.getElementById('descricao').value = sugestao.texto;
                    break;
                case 'conteudo':
                    quill.root.innerHTML = sugestao.texto;
                    break;
                case 'todos':
                    if (sugestao.titulo) document.getElementById('titulo').value = sugestao.titulo;
                    if (sugestao.descricao) document.getElementById('descricao').value = sugestao.descricao;
                    if (sugestao.conteudo) quill.root.innerHTML = sugestao.conteudo;
                    break;
            }

            document.getElementById('assistenteSugestoes').style.display = 'none';

            const mensagensDiv = document.getElementById('assistenteMensagens');
            mensagensDiv.innerHTML += `
                <div class="mensagem-ia">
                    <div class="mensagem-avatar"><i class="fas fa-check"></i></div>
                    <div class="mensagem-conteudo"><p>‚úÖ Sugest√£o aplicada com sucesso!</p></div>
                </div>
            `;
            mensagensDiv.scrollTop = mensagensDiv.scrollHeight;
        }

        // ==================== VERIFICAR FATOS ====================
        async function verificarFatosMateria() {
            const titulo = document.getElementById('titulo').value.trim();
            const descricao = document.getElementById('descricao').value.trim();
            const conteudo = quill ? quill.root.innerHTML : document.getElementById('conteudo').value;

            if (!titulo) {
                alert('Por favor, preencha o titulo da materia antes de verificar os fatos.');
                return;
            }

            if (!conteudo || conteudo === '<p><br></p>') {
                alert('Por favor, escreva o conteudo da materia antes de verificar os fatos.');
                return;
            }

            document.getElementById('modalVerificarFatos').style.display = 'flex';
            document.getElementById('factcheckLoading').style.display = 'block';
            document.getElementById('factcheckResultado').style.display = 'none';

            try {
                const response = await fetch('/api/factcheck/verificar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ titulo, descricao, conteudo })
                });

                const data = await response.json();
                document.getElementById('factcheckLoading').style.display = 'none';
                document.getElementById('factcheckResultado').style.display = 'block';

                if (data.success) {
                    renderizarResultadoFactcheck(data);
                } else {
                    document.getElementById('factcheckResultado').innerHTML = '<div style="text-align:center;padding:40px;color:#DC2626;"><i class="fas fa-exclamation-triangle" style="font-size:48px;margin-bottom:16px;"></i><h3>Erro na verificacao</h3><p>' + (data.error || 'Nao foi possivel verificar os fatos.') + '</p></div>';
                }
            } catch (error) {
                document.getElementById('factcheckLoading').style.display = 'none';
                document.getElementById('factcheckResultado').style.display = 'block';
                document.getElementById('factcheckResultado').innerHTML = '<div style="text-align:center;padding:40px;color:#DC2626;"><i class="fas fa-exclamation-triangle" style="font-size:48px;margin-bottom:16px;"></i><h3>Erro de conexao</h3><p>Nao foi possivel conectar ao servico.</p></div>';
            }
        }

        function renderizarResultadoFactcheck(response) {
            const data = response.data || response;
            const fatos = data.fatos || [];
            const fontes = data.fontes || [];
            const numFontes = data.fontesConsultadas || fontes.length || 0;

            let fatosHtml = '';
            fatos.forEach(fato => {
                fatosHtml += '<div class="fato-item ' + (fato.status === 'pendente' ? 'pendente' : '') + '"><div class="fato-icon"><i class="fas ' + (fato.status === 'confirmado' ? 'fa-check' : 'fa-question') + '"></i></div><div class="fato-content"><strong>' + fato.afirmacao + '</strong><p>' + (fato.explicacao || '') + '</p></div></div>';
            });

            let observacoesHtml = data.observacoes ? '<div class="factcheck-observacoes"><h4><i class="fas fa-info-circle"></i> Observacoes</h4><p>' + data.observacoes + '</p></div>' : '';

            let fontesHtml = '';
            if (fontes.length > 0) {
                fontesHtml = '<div style="margin-top:16px;padding-top:16px;border-top:1px solid #E5E7EB;"><h4 style="font-size:13px;font-weight:700;color:#1F2937;margin:0 0 12px 0;"><i class="fas fa-link"></i> Fontes Consultadas</h4>';
                fontes.forEach(fonte => {
                    fontesHtml += '<div style="margin-bottom:8px;padding:10px;background:#F9FAFB;border-radius:8px;"><a href="' + fonte.url + '" target="_blank" style="color:#0669de;font-weight:500;font-size:13px;text-decoration:none;">' + fonte.titulo + '</a><p style="font-size:12px;color:#6B7280;margin:4px 0 0 0;line-height:1.4;">' + (fonte.snippet || '').substring(0, 150) + '...</p></div>';
                });
                fontesHtml += '</div>';
            }

            document.getElementById('factcheckResultado').innerHTML = '<div class="factcheck-header"><div class="factcheck-score"><span>' + (data.confianca || 100) + '%</span></div><div class="factcheck-info"><h3>' + (data.verificado ? 'Materia Verificada' : 'Verificacao Pendente') + '</h3><p>' + (data.resumo || 'A materia foi analisada.') + '</p></div></div>' + (fatos.length > 0 ? '<div class="factcheck-fatos"><h4><i class="fas fa-list-check"></i> Fatos Verificados</h4>' + fatosHtml + '</div>' : '') + observacoesHtml + '<div class="factcheck-conclusao"><h4><i class="fas fa-check-circle"></i> Conclusao</h4><p>' + (data.conclusao || 'A materia esta baseada em fatos verificaveis.') + '</p></div><div class="factcheck-fontes"><i class="fas fa-globe"></i> ' + numFontes + ' fontes consultadas</div>' + fontesHtml;
        }

        function fecharModalVerificarFatos() {
            document.getElementById('modalVerificarFatos').style.display = 'none';
        }

        document.getElementById('modalVerificarFatos').addEventListener('click', function (e) {
            if (e.target === this) fecharModalVerificarFatos();
        });

        // ==================== EDITOR DE IMAGENS ====================
        let cropper = null;
        let currentEditingMediaId = null;

        function openImageEditor(mediaId, imageUrl) {
            currentEditingMediaId = mediaId;
            const modal = document.getElementById('imageEditorModal');
            const image = document.getElementById('imageEditorCanvas');

            // Destruir cropper anterior se existir
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }

            // Carregar imagem
            image.src = imageUrl;
            modal.classList.add('active');

            // Inicializar Cropper.js ap√≥s a imagem carregar
            image.onload = function () {
                cropper = new Cropper(image, {
                    viewMode: 1, // Imagem n√£o pode ser menor que o container
                    dragMode: 'move',
                    aspectRatio: NaN,
                    autoCropArea: 0.9, // √Årea inicial 90%
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: true,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false,
                    background: true,
                    responsive: true,
                    checkOrientation: true,
                    modal: false,
                    movable: true,
                    zoomable: true,
                    zoomOnWheel: true,
                    wheelZoomRatio: 0.1,
                    minCropBoxWidth: 50,
                    minCropBoxHeight: 50,
                    ready: function () {
                        // Ajustar zoom inicial para preencher melhor o container
                        const containerData = cropper.getContainerData();
                        const imageData = cropper.getImageData();

                        // Calcular zoom para preencher altura
                        const zoomRatio = containerData.height / imageData.naturalHeight;
                        if (zoomRatio > 1) {
                            cropper.zoomTo(zoomRatio * 0.9);
                        }
                    }
                });
            };
        }

        function closeImageEditor() {
            const modal = document.getElementById('imageEditorModal');
            modal.classList.remove('active');

            if (cropper) {
                cropper.destroy();
                cropper = null;
            }

            currentEditingMediaId = null;
        }

        function rotateImage(degrees) {
            if (cropper) {
                cropper.rotate(degrees);
            }
        }

        function flipImage(direction) {
            if (!cropper) return;

            if (direction === 'horizontal') {
                const scaleX = cropper.getData().scaleX || 1;
                cropper.scaleX(-scaleX);
            } else if (direction === 'vertical') {
                const scaleY = cropper.getData().scaleY || 1;
                cropper.scaleY(-scaleY);
            }
        }

        function resetCrop() {
            if (cropper) {
                cropper.reset();
            }
        }

        function changeAspectRatio() {
            if (!cropper) return;

            const select = document.getElementById('aspectRatio');
            const ratio = parseFloat(select.value);

            cropper.setAspectRatio(ratio);
        }

        function zoomImage(ratio) {
            if (!cropper) return;
            cropper.zoom(ratio);
        }

        async function saveEditedImage() {
            if (!cropper || !currentEditingMediaId) {
                alert('Erro ao salvar imagem');
                return;
            }

            try {
                // Obter canvas com a imagem editada (tamanho reduzido)
                const canvas = cropper.getCroppedCanvas({
                    maxWidth: 2048,  // Reduzido de 4096
                    maxHeight: 2048, // Reduzido de 4096
                    fillColor: '#fff',
                    imageSmoothingEnabled: true,
                    imageSmoothingQuality: 'high'
                });

                // Converter para base64 com qualidade reduzida
                const imageData = canvas.toDataURL('image/webp', 0.75); // Reduzido de 0.85

                // Verificar tamanho (limite ~10MB)
                const sizeInMB = (imageData.length * 0.75) / (1024 * 1024);
                console.log('Tamanho da imagem:', sizeInMB.toFixed(2), 'MB');

                if (sizeInMB > 10) {
                    alert('‚ö†Ô∏è Imagem muito grande! Tente recortar uma √°rea menor ou reduzir o zoom.');
                    return;
                }

                // Mostrar loading
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

                // Enviar para o servidor
                const response = await fetch(`/dashboard/media/${currentEditingMediaId}/edit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ imageData })
                });

                // Verificar se a resposta √© JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Resposta inv√°lida do servidor (n√£o √© JSON)');
                }

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Imagem editada e salva com sucesso!');
                    closeImageEditor();
                    loadMediaLibrary(); // Recarregar biblioteca
                } else {
                    alert('‚ùå Erro ao salvar imagem: ' + data.message);
                }

                btn.disabled = false;
                btn.innerHTML = originalText;
            } catch (error) {
                console.error('Erro ao salvar imagem:', error);
                alert('‚ùå Erro ao salvar imagem: ' + error.message);
            }
        }

        // Fechar modal do editor ao clicar fora
        document.getElementById('imageEditorModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeImageEditor();
            }
        });

        // ==================== MODO BORRACHA M√ÅGICA ====================
        let eraserMode = false;
        let eraserCanvas = null;
        let eraserContext = null;
        let isDrawing = false;

        function toggleEraserMode() {
            eraserMode = !eraserMode;
            const btn = document.getElementById('eraserBtn');
            const container = document.querySelector('.editor-canvas-container');

            console.log('üßπ Modo borracha:', eraserMode ? 'ATIVADO' : 'DESATIVADO');

            if (eraserMode) {
                btn.classList.add('active');
                container.classList.add('eraser-mode');

                // Desabilitar cropper temporariamente
                if (cropper) {
                    cropper.disable();
                    console.log('‚úÖ Cropper desabilitado');
                }

                // Criar canvas de borracha sobre a imagem
                setupEraserCanvas();

                alert('‚úÖ Modo Borracha Ativado!\n\nDesenhe sobre a √°rea que deseja remover.');
            } else {
                btn.classList.remove('active');
                container.classList.remove('eraser-mode');

                // Reabilitar cropper
                if (cropper) {
                    cropper.enable();
                    console.log('‚úÖ Cropper reabilitado');
                }

                // Remover canvas de borracha
                if (eraserCanvas) {
                    eraserCanvas.remove();
                    eraserCanvas = null;
                    eraserContext = null;
                    console.log('‚úÖ Canvas de borracha removido');
                }
            }
        }

        function setupEraserCanvas() {
            const container = document.querySelector('.editor-canvas-container');

            // Remover canvas anterior se existir
            if (eraserCanvas) {
                eraserCanvas.remove();
            }

            // Criar canvas overlay
            eraserCanvas = document.createElement('canvas');
            eraserCanvas.style.position = 'absolute';
            eraserCanvas.style.top = '0';
            eraserCanvas.style.left = '0';
            eraserCanvas.style.cursor = 'crosshair';
            eraserCanvas.style.zIndex = '1000';
            eraserCanvas.style.pointerEvents = 'auto';

            // Ajustar tamanho do canvas para cobrir todo o container
            const rect = container.getBoundingClientRect();
            eraserCanvas.width = rect.width;
            eraserCanvas.height = rect.height;
            eraserCanvas.style.width = '100%';
            eraserCanvas.style.height = '100%';

            container.appendChild(eraserCanvas);
            eraserContext = eraserCanvas.getContext('2d');

            // Configurar contexto para desenho de m√°scara
            eraserContext.strokeStyle = 'rgba(255, 0, 0, 0.7)';
            eraserContext.lineWidth = 30;
            eraserContext.lineCap = 'round';
            eraserContext.lineJoin = 'round';

            console.log('‚úÖ Canvas de borracha criado:', eraserCanvas.width, 'x', eraserCanvas.height);

            // Event listeners para desenho
            eraserCanvas.addEventListener('mousedown', startErasing);
            eraserCanvas.addEventListener('mousemove', erase);
            eraserCanvas.addEventListener('mouseup', stopErasing);
            eraserCanvas.addEventListener('mouseleave', stopErasing);

            // Touch events para mobile
            eraserCanvas.addEventListener('touchstart', handleTouchStart);
            eraserCanvas.addEventListener('touchmove', handleTouchMove);
            eraserCanvas.addEventListener('touchend', stopErasing);
        }

        function startErasing(e) {
            isDrawing = true;
            const rect = eraserCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            eraserContext.beginPath();
            eraserContext.moveTo(x, y);
        }

        function erase(e) {
            if (!isDrawing) return;

            const rect = eraserCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            eraserContext.lineTo(x, y);
            eraserContext.stroke();
        }

        function stopErasing() {
            if (!isDrawing) return;
            isDrawing = false;
            eraserContext.closePath();

            // Aplicar remo√ß√£o de objeto
            applyObjectRemoval();
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            eraserCanvas.dispatchEvent(mouseEvent);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            eraserCanvas.dispatchEvent(mouseEvent);
        }

        function applyObjectRemoval() {
            if (!eraserCanvas || !eraserContext) return;

            // Pegar dados da m√°scara desenhada
            const maskData = eraserContext.getImageData(0, 0, eraserCanvas.width, eraserCanvas.height);

            // Pegar imagem original do cropper
            const canvas = cropper.getCroppedCanvas();
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

            // Aplicar inpainting simples (preenchimento com cor de fundo ou blur)
            const scaleX = canvas.width / eraserCanvas.width;
            const scaleY = canvas.height / eraserCanvas.height;

            for (let y = 0; y < eraserCanvas.height; y++) {
                for (let x = 0; x < eraserCanvas.width; x++) {
                    const maskIdx = (y * eraserCanvas.width + x) * 4;

                    // Se a m√°scara tem cor vermelha (√°rea marcada para remo√ß√£o)
                    if (maskData.data[maskIdx] > 0) {
                        const imgX = Math.floor(x * scaleX);
                        const imgY = Math.floor(y * scaleY);
                        const imgIdx = (imgY * canvas.width + imgX) * 4;

                        // Aplicar blur/transpar√™ncia ou cor de preenchimento
                        // Aqui vamos fazer transparente
                        imageData.data[imgIdx + 3] = 0; // Alpha = 0 (transparente)
                    }
                }
            }

            // Aplicar de volta na imagem
            ctx.putImageData(imageData, 0, 0);

            // Atualizar cropper com nova imagem
            const newImageUrl = canvas.toDataURL('image/png');
            document.getElementById('imageEditorCanvas').src = newImageUrl;

            // Limpar canvas de borracha
            eraserContext.clearRect(0, 0, eraserCanvas.width, eraserCanvas.height);

            // Reinicializar cropper
            if (cropper) {
                cropper.destroy();
            }

            const image = document.getElementById('imageEditorCanvas');
            image.onload = function () {
                cropper = new Cropper(image, {
                    viewMode: 1,
                    dragMode: 'move',
                    aspectRatio: NaN,
                    autoCropArea: 1,
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false,
                    background: false,
                    responsive: true,
                    checkOrientation: true,
                    modal: true,
                    minContainerWidth: 200,
                    minContainerHeight: 200
                });

                // Desabilitar se ainda em modo borracha
                if (eraserMode) {
                    cropper.disable();
                }
            };
        }

    </script>

    <%- include('../partials/footer') %>