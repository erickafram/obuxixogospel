<%- include('../dashboard/partials/header', { title: 'Dashboard', user: user }) %>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* Estilos Compactos e Din√¢micos para Dashboard */
    :root {
        --card-shadow: 0 2px 8px rgba(0,0,0,0.04);
        --card-hover-shadow: 0 8px 16px rgba(0,0,0,0.08);
        --primary-gradient: linear-gradient(135deg, #0669de 0%, #3d8bfd 100%);
    }

    .dashboard-content {
        font-size: 0.85rem; /* Fonte menor global */
        max-width: 1600px;
        margin: 0 auto;
    }

    .welcome-section {
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .welcome-section h1 {
        font-size: 1.25rem;
        font-weight: 700;
        margin: 0;
        color: #2D3748;
    }

    .welcome-section p {
        font-size: 0.85rem;
        color: #718096;
        margin: 2px 0 0 0;
    }

    .date-badge {
        background: #fff;
        padding: 6px 12px;
        border-radius: 20px;
        border: 1px solid #e2e8f0;
        color: #4a5568;
        font-weight: 500;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* Grid de Estat√≠sticas */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-card {
        background: white;
        padding: 1rem;
        border-radius: 10px;
        box-shadow: var(--card-shadow);
        border: 1px solid #edf2f7;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--card-hover-shadow);
        border-color: #e2e8f0;
    }

    .stat-icon-wrapper {
        width: 42px;
        height: 42px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        flex-shrink: 0;
    }

    .stat-info h3 {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #718096;
        margin: 0 0 2px 0;
        font-weight: 600;
    }

    .stat-info .value {
        font-size: 1.4rem;
        font-weight: 700;
        color: #1a202c;
        line-height: 1.2;
    }

    .stat-trend {
        font-size: 0.7rem;
        margin-top: 2px;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .trend-up { color: #38a169; }
    .trend-neutral { color: #718096; }

    /* Se√ß√£o de Gr√°ficos e A√ß√µes */
    .dashboard-main-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1.5rem;
    }

    .dashboard-card {
        background: white;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
        border: 1px solid #edf2f7;
        padding: 1.25rem;
        height: 100%;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        border-bottom: 1px solid #f7fafc;
        padding-bottom: 0.75rem;
    }

    .card-header h2 {
        font-size: 0.95rem;
        font-weight: 600;
        color: #2d3748;
        margin: 0;
    }

    /* A√ß√µes R√°pidas - Grid mais denso */
    .actions-grid-compact {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.75rem;
    }

    .action-btn {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        background: #f8fafc;
        border: 1px solid #edf2f7;
        border-radius: 8px;
        color: #4a5568;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.2s;
        font-size: 0.85rem;
    }

    .action-btn:hover {
        background: white;
        border-color: #3182ce;
        color: #3182ce;
        transform: translateX(3px);
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .action-btn i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
        font-size: 1rem;
    }

    .action-btn.primary {
        background: var(--primary-gradient);
        color: white;
        border: none;
    }

    .action-btn.primary:hover {
        opacity: 0.95;
        color: white;
    }

    /* Responsividade */
    @media (max-width: 1024px) {
        .dashboard-main-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 640px) {
        .stats-grid {
            grid-template-columns: 1fr 1fr;
        }
        .welcome-section {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
    }
</style>

<div class="dashboard-content">
    <!-- Cabe√ßalho -->
    <div class="welcome-section">
        <div>
            <h1>Bem-vindo, <%= user.nome.split(' ')[0] %>! üëã</h1>
            <p>Vis√£o geral do Obuxixo Gospel</p>
        </div>
        <div class="date-badge">
            <i class="far fa-calendar-alt"></i>
            <span id="currentDate"></span>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <!-- Posts -->
        <div class="stat-card">
            <div class="stat-icon-wrapper" style="background: #FFF5F5; color: #E53E3E;">
                <i class="fas fa-newspaper"></i>
            </div>
            <div class="stat-info">
                <h3>Publica√ß√µes</h3>
                <div class="value"><%= stats.totalPosts || 0 %></div>
                <div class="stat-trend trend-up">
                    <i class="fas fa-arrow-up"></i> <span>Atualizado</span>
                </div>
            </div>
        </div>

        <!-- Views -->
        <div class="stat-card">
            <div class="stat-icon-wrapper" style="background: #F0FFF4; color: #38A169;">
                <i class="fas fa-eye"></i>
            </div>
            <div class="stat-info">
                <h3>Visualiza√ß√µes</h3>
                <div class="value"><%= (stats.totalViews || 0).toLocaleString('pt-BR') %></div>
                <div class="stat-trend trend-up">
                    <i class="fas fa-chart-line"></i> <span>Total</span>
                </div>
            </div>
        </div>

        <!-- Categories -->
        <div class="stat-card">
            <div class="stat-icon-wrapper" style="background: #EBF8FF; color: #3182CE;">
                <i class="fas fa-folder"></i>
            </div>
            <div class="stat-info">
                <h3>Categorias</h3>
                <div class="value"><%= stats.totalCategories || 0 %></div>
                <div class="stat-trend trend-neutral">
                    <i class="fas fa-minus"></i> <span>Ativas</span>
                </div>
            </div>
        </div>

        <!-- Visualiza√ß√µes Hoje -->
        <div class="stat-card">
            <div class="stat-icon-wrapper" style="background: #FEF3C7; color: #D97706;">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
                <h3>Hoje</h3>
                <div class="value"><%= (stats.todayViews || 0).toLocaleString('pt-BR') %></div>
                <div class="stat-trend trend-up">
                    <i class="fas fa-eye"></i> <span>Visualiza√ß√µes</span>
                </div>
            </div>
        </div>

        <% if (user.role === 'admin') { %>
        <!-- Users -->
        <div class="stat-card">
            <div class="stat-icon-wrapper" style="background: #EBF4FF; color: #5A67D8;">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-info">
                <h3>Equipe</h3>
                <div class="value"><%= stats.totalUsers || 1 %></div>
                <div class="stat-trend trend-neutral">
                    <i class="fas fa-user-shield"></i> <span>Usu√°rios</span>
                </div>
            </div>
        </div>
        <% } %>
    </div>

    <!-- Main Grid: Charts & Actions -->
    <div class="dashboard-main-grid">
        <!-- Chart Section -->
        <div class="dashboard-card">
            <div class="card-header">
                <h2><i class="fas fa-chart-bar" style="margin-right: 8px; color: #3182ce;"></i>Desempenho Recente</h2>
            </div>
            <div style="position: relative; height: 250px; width: 100%;">
                <canvas id="viewsChart"></canvas>
            </div>
        </div>

        <!-- Quick Actions Section -->
        <div class="dashboard-card">
            <div class="card-header">
                <h2><i class="fas fa-bolt" style="margin-right: 8px; color: #D69E2E;"></i>A√ß√µes R√°pidas</h2>
            </div>
            <div class="actions-grid-compact">
                <a href="/dashboard/posts/novo" class="action-btn primary">
                    <i class="fas fa-plus-circle"></i> Criar Nova Mat√©ria
                </a>
                <a href="/dashboard/posts" class="action-btn">
                    <i class="fas fa-list-alt"></i> Gerenciar Posts
                </a>
                <a href="/dashboard/categorias" class="action-btn">
                    <i class="fas fa-tags"></i> Categorias
                </a>
                <a href="/" target="_blank" class="action-btn">
                    <i class="fas fa-external-link-alt"></i> Ver Site
                </a>
                <% if (user.role === 'admin') { %>
                <a href="/dashboard/configuracoes" class="action-btn">
                    <i class="fas fa-cog"></i> Configura√ß√µes
                </a>
                <% } %>
            </div>
        </div>
    </div>
</div>

<script>
    // Data Atual
    const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('pt-BR', dateOptions);

    // Dados reais do backend
    const dailyViewsData = <%- JSON.stringify(stats.dailyViews || []) %>;

    // Configura√ß√£o do Gr√°fico com dados reais
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('viewsChart').getContext('2d');
        
        // Gradiente para o gr√°fico
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(49, 130, 206, 0.3)');
        gradient.addColorStop(1, 'rgba(49, 130, 206, 0.02)');

        // Processar dados reais do backend
        const labels = dailyViewsData.map(item => {
            const date = new Date(item.date + 'T12:00:00');
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        });
        const dataPoints = dailyViewsData.map(item => item.views || 0);
        
        // Calcular total da semana
        const weekTotal = dataPoints.reduce((a, b) => a + b, 0);

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Visualiza√ß√µes',
                    data: dataPoints,
                    borderColor: '#3182ce',
                    backgroundColor: gradient,
                    borderWidth: 3,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#3182ce',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 8,
                    pointHoverBackgroundColor: '#3182ce',
                    pointHoverBorderColor: '#fff',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(45, 55, 72, 0.95)',
                        padding: 12,
                        cornerRadius: 8,
                        displayColors: false,
                        titleFont: {
                            size: 13,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 14
                        },
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y.toLocaleString('pt-BR') + ' visualiza√ß√µes';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            borderDash: [4, 4],
                            color: '#edf2f7'
                        },
                        ticks: {
                            font: {
                                size: 11
                            },
                            callback: function(value) {
                                return value.toLocaleString('pt-BR');
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 11
                            }
                        }
                    }
                }
            }
        });
        
        // Adicionar resumo abaixo do gr√°fico
        const chartContainer = document.getElementById('viewsChart').parentElement;
        const summaryDiv = document.createElement('div');
        summaryDiv.style.cssText = 'display: flex; justify-content: space-around; margin-top: 15px; padding-top: 15px; border-top: 1px solid #edf2f7;';
        summaryDiv.innerHTML = `
            <div style="text-align: center;">
                <div style="font-size: 0.75rem; color: #718096; text-transform: uppercase;">Total 7 dias</div>
                <div style="font-size: 1.1rem; font-weight: 700; color: #2d3748;">${weekTotal.toLocaleString('pt-BR')}</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 0.75rem; color: #718096; text-transform: uppercase;">M√©dia/dia</div>
                <div style="font-size: 1.1rem; font-weight: 700; color: #2d3748;">${Math.round(weekTotal / 7).toLocaleString('pt-BR')}</div>
            </div>
        `;
        chartContainer.appendChild(summaryDiv);
    });
</script>

<%- include('../dashboard/partials/footer') %>
