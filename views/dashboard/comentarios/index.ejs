<%- include('../partials/header', { title: 'Comentários', user: user }) %>

<div class="dashboard-content">
    <!-- Header Compacto -->
    <div class="page-header">
        <div class="header-left">
            <h1><i class="fas fa-comments"></i> Comentários</h1>
            <p>Gerencie e modere os comentários</p>
        </div>
        <div class="header-right">
            <button onclick="loadComments()" class="btn-icon" title="Atualizar">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <!-- Stats Cards Compactos -->
    <div class="stats-row">
        <div class="mini-stat purple">
            <div class="mini-stat-icon"><i class="fas fa-comments"></i></div>
            <div class="mini-stat-info">
                <span class="mini-stat-value" id="totalComments">0</span>
                <span class="mini-stat-label">Total</span>
            </div>
        </div>
        <div class="mini-stat orange">
            <div class="mini-stat-icon"><i class="fas fa-clock"></i></div>
            <div class="mini-stat-info">
                <span class="mini-stat-value" id="pendingComments">0</span>
                <span class="mini-stat-label">Pendentes</span>
            </div>
        </div>
        <div class="mini-stat green">
            <div class="mini-stat-icon"><i class="fas fa-check-circle"></i></div>
            <div class="mini-stat-info">
                <span class="mini-stat-value" id="approvedComments">0</span>
                <span class="mini-stat-label">Aprovados</span>
            </div>
        </div>
    </div>

    <!-- Filtros Compactos -->
    <div class="filters-bar">
        <div class="search-input">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Buscar comentários..." onkeyup="applyFilters()">
        </div>
        <div class="filter-group">
            <select id="statusFilter" onchange="applyFilters()">
                <option value="all">Todos</option>
                <option value="pending">Pendentes</option>
                <option value="approved">Aprovados</option>
            </select>
            <button class="btn-text" onclick="clearFilters()">
                <i class="fas fa-times"></i> Limpar
            </button>
        </div>
    </div>

    <!-- Info de Resultados -->
    <div class="results-bar" id="resultsInfo" style="display: none;">
        <span id="resultsText"></span>
    </div>

    <!-- Card da Tabela -->
    <div class="table-card">
        <table class="compact-table">
            <thead>
                <tr>
                    <th width="40"></th>
                    <th>Autor</th>
                    <th>Comentário</th>
                    <th width="150">Post</th>
                    <th width="90">Data</th>
                    <th width="80">Status</th>
                    <th width="100">Ações</th>
                </tr>
            </thead>
            <tbody id="commentsTableBody">
                <tr id="commentsLoading">
                    <td colspan="7" class="loading-cell">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Carregando...</span>
                    </td>
                </tr>
                <tr id="noComments" style="display: none;">
                    <td colspan="7" class="empty-cell">
                        <i class="fas fa-inbox"></i>
                        <span>Nenhum comentário encontrado</span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<style>
    /* ========== ESTILOS COMPACTOS COMENTÁRIOS ========== */
    .dashboard-content {
        font-size: 0.8rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Header */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #edf2f7;
    }

    .page-header h1 {
        font-size: 1.1rem;
        font-weight: 700;
        color: #2d3748;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .page-header h1 i {
        color: #667eea;
    }

    .page-header p {
        font-size: 0.75rem;
        color: #718096;
        margin: 2px 0 0 0;
    }

    .btn-icon {
        width: 32px;
        height: 32px;
        border: 1px solid #e2e8f0;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #4a5568;
        transition: all 0.2s;
    }

    .btn-icon:hover {
        background: #f7fafc;
        border-color: #3182ce;
        color: #3182ce;
    }

    /* Stats Row */
    .stats-row {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .mini-stat {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #edf2f7;
        box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .mini-stat-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
    }

    .mini-stat.purple .mini-stat-icon { background: #EDE9FE; color: #7C3AED; }
    .mini-stat.orange .mini-stat-icon { background: #FEF3C7; color: #D97706; }
    .mini-stat.green .mini-stat-icon { background: #D1FAE5; color: #059669; }

    .mini-stat-info {
        display: flex;
        flex-direction: column;
    }

    .mini-stat-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1a202c;
        line-height: 1;
    }

    .mini-stat-label {
        font-size: 0.65rem;
        color: #718096;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        margin-top: 2px;
    }

    /* Filters Bar */
    .filters-bar {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        margin-bottom: 0.75rem;
        flex-wrap: wrap;
    }

    .search-input {
        position: relative;
        flex: 1;
        min-width: 200px;
    }

    .search-input i {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #a0aec0;
        font-size: 0.75rem;
    }

    .search-input input {
        width: 100%;
        padding: 0.5rem 0.75rem 0.5rem 2rem;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 0.8rem;
        transition: all 0.2s;
    }

    .search-input input:focus {
        outline: none;
        border-color: #3182ce;
        box-shadow: 0 0 0 2px rgba(49,130,206,0.1);
    }

    .filter-group {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .filter-group select {
        padding: 0.5rem 0.75rem;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 0.8rem;
        background: white;
        cursor: pointer;
    }

    .btn-text {
        background: none;
        border: none;
        color: #718096;
        font-size: 0.75rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 0.5rem;
    }

    .btn-text:hover {
        color: #e53e3e;
    }

    /* Results Bar */
    .results-bar {
        font-size: 0.7rem;
        color: #718096;
        padding: 0.5rem 0;
        border-bottom: 1px solid #edf2f7;
        margin-bottom: 0.5rem;
    }

    /* Table Card */
    .table-card {
        background: white;
        border-radius: 8px;
        border: 1px solid #edf2f7;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .compact-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
    }

    .compact-table thead {
        background: #f7fafc;
    }

    .compact-table th {
        padding: 0.6rem 0.75rem;
        text-align: left;
        font-weight: 600;
        color: #4a5568;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        border-bottom: 1px solid #edf2f7;
    }

    .compact-table td {
        padding: 0.6rem 0.75rem;
        border-bottom: 1px solid #f7fafc;
        vertical-align: middle;
    }

    .compact-table tbody tr:hover {
        background: #fafbfc;
    }

    .loading-cell, .empty-cell {
        text-align: center;
        padding: 2rem !important;
        color: #a0aec0;
    }

    .loading-cell i, .empty-cell i {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        display: block;
    }

    /* Avatar */
    .comment-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.7rem;
    }

    /* Comment Text */
    .comment-text {
        max-width: 300px;
        color: #4a5568;
        font-size: 0.8rem;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Badges */
    .badge {
        display: inline-flex;
        align-items: center;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.6rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.02em;
    }

    .badge-success { background: #D1FAE5; color: #065F46; }
    .badge-warning { background: #FEF3C7; color: #92400E; }

    /* Post Link */
    .post-link {
        color: #3182ce;
        text-decoration: none;
        font-size: 0.75rem;
        max-width: 140px;
        display: inline-block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .post-link:hover { text-decoration: underline; }

    /* Action Buttons */
    .action-btn {
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
        font-size: 0.65rem;
        cursor: pointer;
        transition: all 0.15s;
        display: inline-flex;
        align-items: center;
        gap: 3px;
        text-decoration: none;
        color: white;
    }

    .btn-approve { background: #48BB78; }
    .btn-approve:hover { background: #38A169; }
    .btn-delete { background: #F56565; }
    .btn-delete:hover { background: #E53E3E; }
    .btn-view { background: #4299E1; }
    .btn-view:hover { background: #3182CE; }

    /* Author Info */
    .author-name {
        font-weight: 500;
        color: #2d3748;
        font-size: 0.8rem;
    }

    .author-email {
        font-size: 0.7rem;
        color: #a0aec0;
    }

    /* Date */
    .date-text {
        font-size: 0.7rem;
        color: #718096;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .stats-row { flex-direction: column; }
        .filters-bar { flex-direction: column; }
        .search-input { width: 100%; }
        .filter-group { width: 100%; justify-content: space-between; }
    }
</style>

<script>
let allComments = [];

// Carregar comentários ao iniciar
document.addEventListener('DOMContentLoaded', function() {
    loadComments();
    
    // Busca em tempo real
    const searchInput = document.getElementById('searchInput');
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            applyFilters();
        }, 300);
    });
});

async function loadComments() {
    const loading = document.getElementById('commentsLoading');
    const noComments = document.getElementById('noComments');
    
    loading.style.display = 'table-row';
    noComments.style.display = 'none';
    
    try {
        const response = await fetch('/dashboard/comentarios/api/all');
        const data = await response.json();
        
        console.log('Comentários carregados:', data); // Debug
        
        if (data.success) {
            allComments = data.comments || [];
            console.log('Total de comentários:', allComments.length); // Debug
            updateStats();
            applyFilters();
        } else {
            throw new Error(data.error || 'Erro ao carregar comentários');
        }
    } catch (error) {
        console.error('Erro ao carregar:', error);
        const tbody = document.getElementById('commentsTableBody');
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 40px; color: #e53e3e;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>
                    <p>Erro ao carregar comentários: ${error.message}</p>
                    <button onclick="loadComments()" class="btn btn-secondary" style="margin-top: 15px;">
                        <i class="fas fa-sync-alt"></i> Tentar Novamente
                    </button>
                </td>
            </tr>
        `;
    } finally {
        loading.style.display = 'none';
    }
}

function updateStats() {
    const total = allComments.length;
    const pending = allComments.filter(c => !c.aprovado || c.aprovado === 0).length;
    const approved = allComments.filter(c => c.aprovado === true || c.aprovado === 1).length;
    
    console.log('Stats - Total:', total, 'Pendentes:', pending, 'Aprovados:', approved); // Debug
    
    document.getElementById('totalComments').textContent = total;
    document.getElementById('pendingComments').textContent = pending;
    document.getElementById('approvedComments').textContent = approved;
}

function applyFilters() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    
    console.log('Filtro selecionado:', statusFilter); // Debug
    console.log('Total de comentários:', allComments.length); // Debug
    
    let filtered = allComments;
    
    // Filtrar por status
    if (statusFilter === 'pending') {
        // Verifica tanto boolean false quanto número 0
        filtered = filtered.filter(c => !c.aprovado || c.aprovado === 0);
        console.log('Pendentes encontrados:', filtered.length); // Debug
    } else if (statusFilter === 'approved') {
        // Verifica tanto boolean true quanto número 1
        filtered = filtered.filter(c => c.aprovado === true || c.aprovado === 1);
        console.log('Aprovados encontrados:', filtered.length); // Debug
    }
    
    // Filtrar por busca
    if (searchTerm) {
        filtered = filtered.filter(c => 
            c.nome.toLowerCase().includes(searchTerm) ||
            c.email.toLowerCase().includes(searchTerm) ||
            c.comentario.toLowerCase().includes(searchTerm) ||
            (c.article && c.article.titulo.toLowerCase().includes(searchTerm))
        );
        console.log('Após busca:', filtered.length); // Debug
    }
    
    console.log('Comentários filtrados:', filtered); // Debug
    renderComments(filtered);
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = 'all';
    applyFilters();
}

function renderComments(comments) {
    const tbody = document.getElementById('commentsTableBody');
    const noComments = document.getElementById('noComments');
    const resultsInfo = document.getElementById('resultsInfo');
    const resultsText = document.getElementById('resultsText');
    
    if (comments.length === 0) {
        tbody.innerHTML = '';
        noComments.style.display = 'table-row';
        resultsInfo.style.display = 'none';
        return;
    }
    
    noComments.style.display = 'none';
    resultsInfo.style.display = 'block';
    resultsText.textContent = `Mostrando ${comments.length} de ${allComments.length} comentário(s)`;
    
    tbody.innerHTML = comments.map(comment => {
        const date = new Date(comment.created_at);
        const formattedDate = date.toLocaleDateString('pt-BR', { 
            day: '2-digit', 
            month: 'short', 
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const initial = comment.nome.charAt(0).toUpperCase();
        
        return `
            <tr>
                <td>
                    <div class="comment-avatar">${initial}</div>
                </td>
                <td>
                    <div style="font-weight: 500; color: #2D3748; margin-bottom: 1px; font-size: 13px;">${escapeHtml(comment.nome)}</div>
                    <div style="font-size: 11px; color: #718096;">${escapeHtml(comment.email)}</div>
                </td>
                <td>
                    <div class="comment-text" title="${escapeHtml(comment.comentario)}">
                        ${escapeHtml(comment.comentario)}
                    </div>
                </td>
                <td>
                    ${comment.article ? `
                        <a href="/${comment.article.categoria || 'noticias'}/${comment.article.url_amigavel}" 
                           target="_blank" 
                           class="post-link"
                           title="${escapeHtml(comment.article.titulo)}">
                            ${escapeHtml(comment.article.titulo)}
                        </a>
                    ` : '<span style="color: #999; font-size: 12px;">-</span>'}
                </td>
                <td style="font-size: 12px; color: #4A5568;">${formattedDate}</td>
                <td>
                    ${(comment.aprovado === true || comment.aprovado === 1) ? 
                        '<span class="badge badge-success">✓ Aprovado</span>' : 
                        '<span class="badge badge-warning">⏱ Pendente</span>'}
                </td>
                <td>
                    <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                        ${(!comment.aprovado || comment.aprovado === 0) ? `
                            <button onclick="approveComment(${comment.id})" 
                                    class="action-btn btn-approve"
                                    title="Aprovar">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : ''}
                        <button onclick="deleteComment(${comment.id})" 
                                class="action-btn btn-delete"
                                title="Deletar">
                            <i class="fas fa-trash"></i>
                        </button>
                        ${comment.article ? `
                            <a href="/${comment.article.categoria || 'noticias'}/${comment.article.url_amigavel}#comentarios" 
                               target="_blank" 
                               class="action-btn btn-view"
                               title="Ver post">
                                <i class="fas fa-eye"></i>
                            </a>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

async function approveComment(id) {
    if (!confirm('Deseja aprovar este comentário?')) return;
    
    try {
        const response = await fetch(`/dashboard/comentarios/api/${id}/approve`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('✅ Comentário aprovado com sucesso!');
            loadComments();
        } else {
            throw new Error(data.error || 'Erro ao aprovar comentário');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('❌ Erro ao aprovar comentário: ' + error.message);
    }
}

async function deleteComment(id) {
    if (!confirm('Deseja realmente deletar este comentário? Esta ação não pode ser desfeita.')) return;
    
    try {
        const response = await fetch(`/dashboard/comentarios/api/${id}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('✅ Comentário deletado com sucesso!');
            loadComments();
        } else {
            throw new Error(data.error || 'Erro ao deletar comentário');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('❌ Erro ao deletar comentário: ' + error.message);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>

<%- include('../partials/footer') %>
