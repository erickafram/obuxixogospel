<%- include('../partials/header', { title: 'Mat√©rias via YouTube', user: user }) %>

<div class="dashboard-content">
    <div class="content-header">
        <div>
            <h1><i class="fab fa-youtube" style="color: #FF0000;"></i> Mat√©rias via YouTube</h1>
            <p>Transcreva v√≠deos do YouTube e gere mat√©rias automaticamente com IA</p>
        </div>
    </div>

    <!-- Etapa 1: Inserir URL do V√≠deo -->
    <div id="step1" class="step-container active">
        <div class="card">
            <div class="card-header">
                <h3><i class="fab fa-youtube"></i> Passo 1: Inserir V√≠deo do YouTube</h3>
            </div>
            <div class="card-body">
                <form id="formTranscrever" onsubmit="transcreverVideo(event)">
                    <div class="form-group">
                        <label for="videoUrl">
                            <i class="fas fa-link"></i> URL do V√≠deo do YouTube *
                        </label>
                        <input 
                            type="url" 
                            id="videoUrl" 
                            name="videoUrl" 
                            class="form-control" 
                            placeholder="https://www.youtube.com/watch?v=..."
                            required
                        >
                        <small>Cole a URL completa do v√≠deo do YouTube</small>
                    </div>

                    <div class="form-group">
                        <label for="categoria">
                            <i class="fas fa-folder"></i> Categoria das Mat√©rias
                        </label>
                        <select id="categoria" name="categoria" class="form-control">
                            <% if (categorias && categorias.length > 0) { %>
                                <% categorias.forEach(cat => { %>
                                    <option value="<%= cat.slug %>"><%= cat.nome %></option>
                                <% }); %>
                            <% } else { %>
                                <option value="noticias">Not√≠cias</option>
                                <option value="musica">M√∫sica</option>
                                <option value="eventos">Eventos</option>
                                <option value="ministerios">Minist√©rios</option>
                                <option value="estudos">Estudos</option>
                            <% } %>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="maxArticles">
                            <i class="fas fa-list-ol"></i> Quantidade M√°xima de Mat√©rias
                        </label>
                        <select id="maxArticles" name="maxArticles" class="form-control">
                            <option value="1">1 mat√©ria</option>
                            <option value="2">2 mat√©rias</option>
                            <option value="3" selected>3 mat√©rias</option>
                            <option value="5">5 mat√©rias</option>
                            <option value="7">7 mat√©rias</option>
                            <option value="10">10 mat√©rias</option>
                            <option value="15">15 mat√©rias</option>
                            <option value="20">20 mat√©rias</option>
                        </select>
                        <small>A IA identificar√° os principais t√≥picos do v√≠deo e gerar√° mat√©rias separadas</small>
                    </div>

                    <div class="form-group">
                        <label for="statusPublicacao">
                            <i class="fas fa-eye"></i> Destino das Mat√©rias
                        </label>
                        <select id="statusPublicacao" name="statusPublicacao" class="form-control">
                            <option value="rascunho" selected>üìù Salvar como Rascunho</option>
                            <option value="publicado">‚úÖ Publicar Imediatamente</option>
                            <option value="exportar">üì• Exportar para Arquivo (para importar no servidor)</option>
                        </select>
                        <small>Use "Exportar para Arquivo" para gerar localmente e importar no servidor de produ√ß√£o</small>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Como funciona:</strong>
                        <ol style="margin: 10px 0 0 20px; font-size: 13px;">
                            <li>O sistema obt√©m a transcri√ß√£o/legendas do v√≠deo (sem baixar)</li>
                            <li>A IA analisa o conte√∫do e identifica os principais t√≥picos</li>
                            <li>Para cada t√≥pico, uma mat√©ria √© gerada no estilo jornal√≠stico (Metr√≥poles/G1)</li>
                            <li>As mat√©rias s√£o salvas como rascunho para voc√™ revisar</li>
                        </ol>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Importante:</strong> O v√≠deo precisa ter legendas/closed captions dispon√≠veis (autom√°ticas ou manuais).
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg" id="btnTranscrever">
                        <i class="fas fa-play"></i> Transcrever e Gerar Mat√©rias
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Etapa 2: Processando -->
    <div id="step2" class="step-container">
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-cog fa-spin"></i> Processando V√≠deo</h3>
            </div>
            <div class="card-body">
                <div class="processing-container">
                    <div class="processing-status">
                        <div class="status-item" id="status-transcript">
                            <i class="fas fa-circle-notch fa-spin"></i>
                            <span>Obtendo transcri√ß√£o do v√≠deo...</span>
                        </div>
                        <div class="status-item pending" id="status-analyze">
                            <i class="fas fa-clock"></i>
                            <span>Analisando t√≥picos...</span>
                        </div>
                        <div class="status-item pending" id="status-generate">
                            <i class="fas fa-clock"></i>
                            <span>Gerando mat√©rias...</span>
                        </div>
                        <div class="status-item pending" id="status-save">
                            <i class="fas fa-clock"></i>
                            <span>Salvando como rascunho...</span>
                        </div>
                    </div>
                    
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <p class="progress-text" id="progressText">Iniciando...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Etapa 3: Transcri√ß√£o e T√≥picos -->
    <div id="step3" class="step-container">
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-file-alt"></i> Passo 2: Transcri√ß√£o Obtida</h3>
            </div>
            <div class="card-body">
                <div class="transcript-info">
                    <div class="info-badge">
                        <i class="fas fa-text-width"></i>
                        <span id="transcriptLength">0</span> caracteres
                    </div>
                    <div class="info-badge">
                        <i class="fas fa-lightbulb"></i>
                        <span id="topicsCount">0</span> t√≥pico(s) identificado(s)
                    </div>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-scroll"></i> Transcri√ß√£o Completa</label>
                    <textarea id="transcriptText" class="form-control" rows="8" readonly></textarea>
                </div>

                <div id="topicsList" class="topics-list"></div>

                <div class="action-buttons-container">
                    <button onclick="voltarPasso1()" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <button onclick="gerarMateriasDoTopicos()" class="btn btn-primary btn-lg" id="btnGerarMaterias">
                        <i class="fas fa-magic"></i> Gerar Mat√©rias (<span id="btnGerarCount">0</span>)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Etapa 4: Mat√©rias Geradas -->
    <div id="step4" class="step-container">
        <div class="card">
            <div class="card-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3><i class="fas fa-newspaper"></i> Passo 3: Mat√©rias Geradas</h3>
                    <div id="resultInfo" class="progress-info"></div>
                </div>
            </div>
            <div class="card-body">
                <div id="materiasGeradas" class="materias-list"></div>
                
                <div class="action-buttons-container">
                    <button onclick="voltarPasso1()" class="btn btn-secondary">
                        <i class="fas fa-home"></i> Novo V√≠deo
                    </button>
                    <button onclick="exportarMateriasGeradas()" class="btn btn-success" id="btnExportarGeradas">
                        <i class="fas fa-download"></i> Exportar para Arquivo
                    </button>
                    <a href="/dashboard/posts" class="btn btn-primary">
                        <i class="fas fa-list"></i> Ver Todos os Posts
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.step-container {
    display: none;
}
.step-container.active {
    display: block;
}

.processing-container {
    text-align: center;
    padding: 40px 20px;
}

.processing-status {
    display: flex;
    flex-direction: column;
    gap: 16px;
    max-width: 400px;
    margin: 0 auto 30px;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: #f0fdf4;
    border-radius: 8px;
    color: #166534;
    font-size: 14px;
}

.status-item.pending {
    background: #f8fafc;
    color: #94a3b8;
}

.status-item.active {
    background: #eff6ff;
    color: #1d4ed8;
}

.status-item.done {
    background: #f0fdf4;
    color: #166534;
}

.status-item.done i {
    color: #22c55e;
}

.status-item.error {
    background: #fef2f2;
    color: #dc2626;
}

.progress-bar-container {
    width: 100%;
    max-width: 500px;
    height: 8px;
    background: #e2e8f0;
    border-radius: 4px;
    margin: 0 auto 16px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #0669de, #3d8bfd);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.progress-text {
    color: #64748b;
    font-size: 14px;
}

.transcript-info {
    display: flex;
    gap: 16px;
    margin-bottom: 20px;
}

.info-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: #f1f5f9;
    border-radius: 20px;
    font-size: 13px;
    color: #475569;
}

.info-badge i {
    color: #0669de;
}

.topics-list {
    margin-top: 20px;
}

.topic-card {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
}

.topic-card.selected {
    border-color: #0669de;
    background: #eff6ff;
}

.topic-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
}

.topic-header input[type="checkbox"] {
    width: 18px;
    height: 18px;
}

.topic-title {
    font-weight: 600;
    color: #1e293b;
    flex: 1;
}

.topic-summary {
    color: #64748b;
    font-size: 13px;
    margin-left: 30px;
}

.materias-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.materia-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.materia-card.success {
    border-left: 4px solid #22c55e;
}

.materia-card.error {
    border-left: 4px solid #ef4444;
}

.materia-header {
    padding: 16px;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
}

.materia-title {
    font-size: 16px;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 4px;
}

.materia-meta {
    font-size: 12px;
    color: #64748b;
}

.materia-body {
    padding: 16px;
}

.materia-description {
    color: #475569;
    font-size: 14px;
    line-height: 1.6;
    margin-bottom: 12px;
}

.materia-actions {
    display: flex;
    gap: 8px;
    padding: 12px 16px;
    background: #f8fafc;
    border-top: 1px solid #e2e8f0;
}

.action-buttons-container {
    display: flex;
    gap: 12px;
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid #e2e8f0;
}

.alert {
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 14px;
}

.alert-info {
    background: #eff6ff;
    border: 1px solid #bfdbfe;
    color: #1e40af;
}

.alert-warning {
    background: #fffbeb;
    border: 1px solid #fcd34d;
    color: #92400e;
}

.alert-success {
    background: #f0fdf4;
    border: 1px solid #86efac;
    color: #166534;
}

.alert-danger {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-primary {
    background: linear-gradient(135deg, #0669de, #3d8bfd);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(6, 105, 222, 0.3);
}

.btn-secondary {
    background: #f1f5f9;
    color: #475569;
}

.btn-secondary:hover {
    background: #e2e8f0;
}

.btn-success {
    background: #22c55e;
    color: white;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

.btn-lg {
    padding: 14px 28px;
    font-size: 15px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #374151;
    font-size: 14px;
}

.form-control {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s, box-shadow 0.2s;
}

.form-control:focus {
    outline: none;
    border-color: #0669de;
    box-shadow: 0 0 0 3px rgba(6, 105, 222, 0.1);
}

small {
    display: block;
    margin-top: 6px;
    color: #6b7280;
    font-size: 12px;
}

.card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    margin-bottom: 24px;
}

.card-header {
    padding: 20px 24px;
    border-bottom: 1px solid #e5e7eb;
}

.card-header h3 {
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
    display: flex;
    align-items: center;
    gap: 10px;
}

.card-body {
    padding: 24px;
}
</style>

<script>
let currentTranscript = null;
let currentTopics = [];

async function transcreverVideo(event) {
    event.preventDefault();
    
    const videoUrl = document.getElementById('videoUrl').value.trim();
    const categoria = document.getElementById('categoria').value;
    const maxArticles = parseInt(document.getElementById('maxArticles').value);
    const statusPublicacao = document.getElementById('statusPublicacao').value;
    
    console.log('Status de publica√ß√£o selecionado:', statusPublicacao);
    
    if (!videoUrl) {
        alert('Por favor, insira a URL do v√≠deo');
        return;
    }
    
    // Mostrar etapa de processamento
    showStep(2);
    updateStatus('transcript', 'active');
    updateProgress(10, 'Obtendo transcri√ß√£o do v√≠deo...');
    
    try {
        // 1. Obter transcri√ß√£o
        const transcriptResponse = await fetch('/api/youtube/transcript', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ videoUrl })
        });
        
        const transcriptData = await transcriptResponse.json();
        
        if (!transcriptData.success) {
            throw new Error(transcriptData.message || 'Erro ao obter transcri√ß√£o');
        }
        
        currentTranscript = transcriptData.transcript;
        updateStatus('transcript', 'done');
        updateStatus('analyze', 'active');
        updateProgress(30, 'Analisando t√≥picos do v√≠deo...');
        
        // 2. Analisar t√≥picos (passando metadados do v√≠deo para identificar corretamente quem est√° falando)
        const topicsResponse = await fetch('/api/youtube/analyze-topics', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                transcript: currentTranscript.text,
                maxTopics: maxArticles,
                metadata: currentTranscript.metadata // Passar t√≠tulo, descri√ß√£o e canal do v√≠deo
            })
        });
        
        const topicsData = await topicsResponse.json();
        
        if (!topicsData.success) {
            throw new Error(topicsData.message || 'Erro ao analisar t√≥picos');
        }
        
        currentTopics = topicsData.topics;
        updateStatus('analyze', 'done');
        updateStatus('generate', 'active');
        updateProgress(50, 'Gerando mat√©rias...');
        
        // 3. Gerar mat√©rias
        const articlesResponse = await fetch('/api/youtube/generate-articles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                topics: currentTopics,
                categoria: categoria
            })
        });
        
        const articlesData = await articlesResponse.json();
        
        if (!articlesData.success) {
            throw new Error(articlesData.message || 'Erro ao gerar mat√©rias');
        }
        
        updateStatus('generate', 'done');
        updateStatus('save', 'active');
        const statusText = statusPublicacao === 'publicado' ? 'Publicando mat√©rias...' : 'Salvando mat√©rias como rascunho...';
        updateProgress(80, statusText);
        
        // 4. Salvar ou Exportar mat√©rias
        console.log('Verificando destino:', statusPublicacao, '| √â exportar?', statusPublicacao === 'exportar');
        
        if (statusPublicacao === 'exportar') {
            // Exportar para arquivo JSON
            console.log('Iniciando exporta√ß√£o para arquivo...');
            updateProgress(90, 'Gerando arquivo de exporta√ß√£o...');
            
            const exportData = {
                exportedAt: new Date().toISOString(),
                videoUrl: videoUrl,
                videoId: currentTranscript.videoId,
                categoria: categoria,
                articles: articlesData.articles.map(article => ({
                    titulo: article.titulo,
                    descricao: article.descricao,
                    conteudo: article.conteudo,
                    categoria: categoria,
                    autor: 'Reda√ß√£o Obuxixo Gospel'
                }))
            };
            
            // Criar e baixar arquivo
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `youtube-materias-${currentTranscript.videoId}-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            updateStatus('save', 'done');
            updateProgress(100, 'Arquivo exportado com sucesso!');
            
            // Mostrar mensagem de sucesso
            setTimeout(() => {
                showExportSuccess(articlesData.articles.length, currentTranscript.videoId);
            }, 500);
        } else {
            // Salvar no banco de dados
            const saveResponse = await fetch('/api/youtube/save-articles', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    articles: articlesData.articles,
                    categoria: categoria,
                    videoId: currentTranscript.videoId,
                    publicado: statusPublicacao === 'publicado'
                })
            });
            
            const saveData = await saveResponse.json();
            
            if (!saveData.success) {
                throw new Error(saveData.message || 'Erro ao salvar mat√©rias');
            }
            
            updateStatus('save', 'done');
            updateProgress(100, 'Conclu√≠do!');
            
            // Mostrar resultados
            setTimeout(() => {
                showResults(saveData.savedArticles);
            }, 500);
        }
        
    } catch (error) {
        console.error('Erro:', error);
        updateProgress(0, 'Erro: ' + error.message);
        
        // Marcar status atual como erro
        document.querySelectorAll('.status-item.active').forEach(el => {
            el.classList.remove('active');
            el.classList.add('error');
            el.querySelector('i').className = 'fas fa-times-circle';
        });
        
        setTimeout(() => {
            alert('Erro: ' + error.message);
            showStep(1);
        }, 1000);
    }
}

function showStep(stepNumber) {
    document.querySelectorAll('.step-container').forEach(el => {
        el.classList.remove('active');
    });
    document.getElementById('step' + stepNumber).classList.add('active');
    
    // Reset status quando voltar ao passo 1
    if (stepNumber === 1) {
        resetStatus();
    }
}

function updateStatus(statusId, state) {
    const el = document.getElementById('status-' + statusId);
    el.className = 'status-item ' + state;
    
    const icon = el.querySelector('i');
    switch(state) {
        case 'active':
            icon.className = 'fas fa-circle-notch fa-spin';
            break;
        case 'done':
            icon.className = 'fas fa-check-circle';
            break;
        case 'error':
            icon.className = 'fas fa-times-circle';
            break;
        default:
            icon.className = 'fas fa-clock';
    }
}

function resetStatus() {
    ['transcript', 'analyze', 'generate', 'save'].forEach(id => {
        updateStatus(id, 'pending');
    });
    updateProgress(0, 'Iniciando...');
}

function updateProgress(percent, text) {
    document.getElementById('progressBar').style.width = percent + '%';
    document.getElementById('progressText').textContent = text;
}

function showResults(articles) {
    const container = document.getElementById('materiasGeradas');
    container.innerHTML = '';
    
    const statusPublicacao = document.getElementById('statusPublicacao').value;
    const isPublicado = statusPublicacao === 'publicado';
    
    let successCount = 0;
    let errorCount = 0;
    
    articles.forEach((article, index) => {
        if (article.error) {
            errorCount++;
            container.innerHTML += `
                <div class="materia-card error">
                    <div class="materia-header">
                        <div class="materia-title">‚ùå Erro ao gerar mat√©ria</div>
                        <div class="materia-meta">${article.topicTitle || 'T√≥pico ' + (index + 1)}</div>
                    </div>
                    <div class="materia-body">
                        <p class="materia-description">${article.errorMessage}</p>
                    </div>
                </div>
            `;
        } else {
            successCount++;
            const statusBadge = isPublicado 
                ? '<span style="color: #22c55e;"><i class="fas fa-check-circle"></i> Publicado</span>'
                : '<span style="color: #f59e0b;"><i class="fas fa-file-alt"></i> Rascunho</span>';
            
            container.innerHTML += `
                <div class="materia-card success">
                    <div class="materia-header">
                        <div class="materia-title">${article.titulo}</div>
                        <div class="materia-meta">
                            <i class="fas fa-folder"></i> ${article.categoria} &nbsp;|&nbsp;
                            ${statusBadge}
                        </div>
                    </div>
                    <div class="materia-body">
                        <p class="materia-description">${article.descricao}</p>
                    </div>
                    <div class="materia-actions">
                        <a href="/dashboard/posts/editar/${article.id}" class="btn btn-primary btn-sm">
                            <i class="fas fa-edit"></i> Editar
                        </a>
                        <a href="/${article.categoria}/${article.urlAmigavel}" target="_blank" class="btn btn-secondary btn-sm">
                            <i class="fas fa-eye"></i> Visualizar
                        </a>
                    </div>
                </div>
            `;
        }
    });
    
    document.getElementById('resultInfo').innerHTML = `
        <span style="color: #22c55e;"><i class="fas fa-check-circle"></i> ${successCount} gerada(s)</span>
        ${errorCount > 0 ? `<span style="color: #ef4444; margin-left: 12px;"><i class="fas fa-times-circle"></i> ${errorCount} erro(s)</span>` : ''}
    `;
    
    // Guardar artigos para poss√≠vel exporta√ß√£o posterior
    window.lastGeneratedArticles = articles.filter(a => !a.error);
    
    showStep(4);
}

// Fun√ß√£o para exportar mat√©rias j√° geradas
async function exportarMateriasGeradas() {
    if (!window.lastGeneratedArticles || window.lastGeneratedArticles.length === 0) {
        alert('Nenhuma mat√©ria dispon√≠vel para exportar');
        return;
    }
    
    const btn = document.getElementById('btnExportarGeradas');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando dados...';
    btn.disabled = true;
    
    try {
        // Buscar conte√∫do completo das mat√©rias do banco
        const articleIds = window.lastGeneratedArticles.map(a => a.id).filter(id => id);
        
        let articlesToExport = [];
        
        if (articleIds.length > 0) {
            // Buscar dados completos do banco
            const response = await fetch('/api/articles/export-by-ids', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: articleIds })
            });
            
            const data = await response.json();
            if (data.success) {
                articlesToExport = data.articles;
            } else {
                throw new Error(data.message || 'Erro ao buscar mat√©rias');
            }
        } else {
            // Usar dados em mem√≥ria se n√£o tiver IDs
            articlesToExport = window.lastGeneratedArticles;
        }
        
        const categoria = document.getElementById('categoria').value;
        
        const exportData = {
            exportedAt: new Date().toISOString(),
            videoUrl: document.getElementById('videoUrl').value || 'N/A',
            videoId: currentTranscript?.videoId || 'unknown',
            categoria: categoria,
            articles: articlesToExport.map(article => ({
                titulo: article.titulo,
                descricao: article.descricao,
                conteudo: article.conteudo || '',
                categoria: article.categoria || categoria,
                autor: article.autor || 'Reda√ß√£o Obuxixo Gospel'
            }))
        };
        
        // Criar e baixar arquivo
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `youtube-materias-${exportData.videoId}-${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert(`‚úÖ ${articlesToExport.length} mat√©ria(s) exportada(s) com sucesso!\n\nImporte o arquivo no servidor de produ√ß√£o em:\nDashboard ‚Üí Posts ‚Üí Importar Mat√©rias`);
    } catch (error) {
        alert('Erro ao exportar: ' + error.message);
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

function voltarPasso1() {
    currentTranscript = null;
    currentTopics = [];
    document.getElementById('videoUrl').value = '';
    showStep(1);
}

function showExportSuccess(count, videoId) {
    const container = document.getElementById('materiasGeradas');
    container.innerHTML = `
        <div class="alert alert-success" style="text-align: center; padding: 40px;">
            <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
            <h3 style="margin-bottom: 12px;">Arquivo Exportado com Sucesso!</h3>
            <p style="margin-bottom: 20px;">
                <strong>${count} mat√©ria(s)</strong> foram exportadas para um arquivo JSON.<br>
                O download deve ter iniciado automaticamente.
            </p>
            <div class="alert alert-info" style="text-align: left; max-width: 600px; margin: 0 auto;">
                <strong><i class="fas fa-info-circle"></i> Pr√≥ximos passos:</strong>
                <ol style="margin: 10px 0 0 20px;">
                    <li>Acesse o servidor de produ√ß√£o</li>
                    <li>V√° em <strong>Dashboard ‚Üí Posts</strong></li>
                    <li>Clique em <strong>"Importar Mat√©rias"</strong></li>
                    <li>Fa√ßa upload do arquivo JSON baixado</li>
                    <li>As mat√©rias ser√£o importadas como rascunho</li>
                </ol>
            </div>
        </div>
    `;
    
    document.getElementById('resultInfo').innerHTML = `
        <span style="color: #22c55e;"><i class="fas fa-download"></i> ${count} exportada(s)</span>
    `;
    
    showStep(4);
}
</script>

<%- include('../partials/footer') %>
