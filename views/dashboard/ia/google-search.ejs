<%- include('../partials/header', { title: 'Pesquisa Google + Trends', user: user }) %>

<div class="dashboard-content">
    <div class="content-header">
        <div>
            <h1><i class="fab fa-google" style="color: #4285f4;"></i> Pesquisa Google + Trends</h1>
            <p>Pesquise assuntos em alta e gere matÃ©rias automaticamente com IA</p>
        </div>
    </div>

    <!-- Tabs de navegaÃ§Ã£o -->
    <div class="tabs-container">
        <button class="tab-btn active" onclick="switchTab('pesquisa')" id="tabPesquisa">
            <i class="fab fa-google"></i> Pesquisa Google
        </button>
        <button class="tab-btn" onclick="switchTab('trends')" id="tabTrends">
            <i class="fas fa-chart-line"></i> Google Trends
        </button>
    </div>

    <!-- Tab: Pesquisa Google -->
    <div id="tab-pesquisa" class="tab-content active">
        <!-- Palavras-chave em Alta do Google -->
        <div class="card" style="margin-bottom: 16px;">
            <div class="card-header" style="padding: 12px 18px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="font-size: 14px; margin: 0;"><i class="fas fa-fire" style="color: #e53e3e;"></i> Palavras-chave em Alta (Google)</h3>
                    <button type="button" class="btn btn-sm btn-outline" onclick="carregarPalavrasChaveGoogle()" id="btnAtualizarPalavras" style="font-size: 11px; padding: 4px 10px;">
                        <i class="fas fa-sync-alt"></i> Atualizar
                    </button>
                </div>
            </div>
            <div class="card-body" style="padding: 12px 18px;">
                <div id="palavrasChave" class="keywords-container">
                    <div style="text-align: center; padding: 20px; color: #718096;">
                        <span class="loading-spinner"></span>
                        <p style="margin-top: 10px; font-size: 12px;">Buscando palavras-chave em alta no Google...</p>
                    </div>
                </div>
                <p id="fontePalavras" style="font-size: 11px; color: #a0aec0; margin-top: 10px; margin-bottom: 0;"></p>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3><i class="fab fa-google"></i> Pesquisar no Google</h3>
            </div>
            <div class="card-body">
                <form id="formPesquisa" onsubmit="realizarPesquisa(event)">
                    <div class="form-group">
                        <label for="termo">
                            <i class="fas fa-search"></i> Termo de Pesquisa *
                        </label>
                        <input 
                            type="text" 
                            id="termo" 
                            name="termo" 
                            class="form-control" 
                            placeholder="Ex: Silas Malafaia, AndrÃ© ValadÃ£o, etc..."
                            required
                        >
                    </div>

                    <div class="form-row-3">
                        <div class="form-group">
                            <label for="plataforma">
                                <i class="fas fa-globe"></i> Pesquisar em
                            </label>
                            <select id="plataforma" name="plataforma" class="form-control">
                                <option value="todas">ğŸŒ Todas as fontes</option>
                                <optgroup label="Redes Sociais">
                                    <option value="instagram">ğŸ“¸ Instagram</option>
                                    <option value="twitter">ğŸ¦ Twitter/X</option>
                                    <option value="youtube">â–¶ï¸ YouTube</option>
                                    <option value="facebook">ğŸ“˜ Facebook</option>
                                    <option value="tiktok">ğŸµ TikTok</option>
                                    <option value="threads">ğŸ§µ Threads</option>
                                    <option value="linkedin">ğŸ’¼ LinkedIn</option>
                                </optgroup>
                                <optgroup label="Portais de NotÃ­cias">
                                    <option value="g1">ğŸ“° G1 / Globo</option>
                                    <option value="uol">ğŸ“° UOL</option>
                                    <option value="folha">ğŸ“° Folha de SP</option>
                                    <option value="estadao">ğŸ“° EstadÃ£o</option>
                                    <option value="r7">ğŸ“° R7</option>
                                    <option value="terra">ğŸ“° Terra</option>
                                    <option value="ig">ğŸ“° iG</option>
                                    <option value="metropoles">ğŸ“° MetrÃ³poles</option>
                                    <option value="cnn">ğŸ“º CNN Brasil</option>
                                    <option value="band">ğŸ“º Band</option>
                                    <option value="sbt">ğŸ“º SBT</option>
                                    <option value="record">ğŸ“º Record</option>
                                </optgroup>
                                <optgroup label="Sites Gospel">
                                    <option value="gospelprime">â›ª Gospel Prime</option>
                                    <option value="gospelmais">â›ª Gospel Mais</option>
                                    <option value="pleno">â›ª Pleno News</option>
                                    <option value="guiame">â›ª Guiame</option>
                                    <option value="conexao">â›ª ConexÃ£o Jornalismo</option>
                                    <option value="verdadegospel">â›ª Verdade Gospel</option>
                                    <option value="ofuxicogospel">â›ª Verdade Gospel</option>
                                </optgroup>
                                <optgroup label="Outros">
                                    <option value="blogs">ğŸ“ Blogs (Medium, WordPress)</option>
                                </optgroup>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="periodo">
                                <i class="fas fa-clock"></i> PerÃ­odo
                            </label>
                            <select id="periodo" name="periodo" class="form-control">
                                <option value="ultimas-24h">ğŸ• Ãšltimas 24 horas</option>
                                <option value="ultima-semana">ğŸ“… Ãšltima semana</option>
                                <option value="ultimo-mes">ğŸ“† Ãšltimo mÃªs</option>
                                <option value="ultima-hora">â° Ãšltima hora</option>
                                <option value="ultimo-ano">ğŸ“… Ãšltimo ano</option>
                                <option value="qualquer">ğŸ”„ Qualquer perÃ­odo</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="categoriaMateria">
                                <i class="fas fa-folder"></i> Categoria
                            </label>
                            <select id="categoriaMateria" name="categoriaMateria" class="form-control">
                                <% if (typeof categorias !== 'undefined' && categorias.length > 0) { %>
                                    <% categorias.forEach(cat => { %>
                                        <option value="<%= cat.slug %>"><%= cat.nome %></option>
                                    <% }); %>
                                <% } else { %>
                                    <option value="noticias">NotÃ­cias</option>
                                <% } %>
                            </select>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" id="btnPesquisar">
                        <i class="fas fa-search"></i> Pesquisar
                    </button>
                </form>
            </div>
        </div>

        <!-- Resultados da Pesquisa -->
        <div id="resultadosPesquisa" class="card" style="display: none;">
            <div class="card-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3><i class="fas fa-list"></i> Resultados (<span id="totalResultados">0</span>)</h3>
                    <div>
                        <span id="selecionadosCount" style="margin-right: 15px; color: #718096;">0 selecionados</span>
                        <button onclick="gerarMateriasSelecionadas()" class="btn btn-success" id="btnGerarMaterias" disabled>
                            <i class="fas fa-magic"></i> Gerar MatÃ©rias (<span id="btnGerarCount">0</span>)
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="listaResultados" class="resultados-lista"></div>
            </div>
        </div>
    </div>

    <!-- Tab: Google Trends -->
    <div id="tab-trends" class="tab-content">
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-chart-line"></i> Assuntos em Alta</h3>
            </div>
            <div class="card-body">
                <!-- Sub-tabs para Trends -->
                <div class="sub-tabs" style="margin-bottom: 15px;">
                    <button class="sub-tab-btn active" onclick="switchTrendsTab('geral')" id="subTabGeral">
                        <i class="fas fa-globe"></i> Trends Gerais
                    </button>
                    <button class="sub-tab-btn" onclick="switchTrendsTab('gospel')" id="subTabGospel">
                        <i class="fas fa-church"></i> Trends Gospel
                    </button>
                </div>

                <!-- Sub-tab: Trends Gerais -->
                <div id="trends-geral" class="sub-tab-content active">
                    <div style="display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-end; flex-wrap: wrap;">
                        <div class="form-group" style="margin-bottom: 0; min-width: 200px; flex: 1;">
                            <label for="trendsRegiao"><i class="fas fa-globe-americas"></i> RegiÃ£o</label>
                            <select id="trendsRegiao" class="form-control">
                            <optgroup label="AmÃ©rica do Sul">
                                <option value="BR" selected>ğŸ‡§ğŸ‡· Brasil</option>
                                <option value="AR">ï¿½ï¿½ Argentina</option>
                                <option value="CL">ğŸ‡¨ğŸ‡± Chile</option>
                                <option value="CO">ğŸ‡¨ğŸ‡´ ColÃ´mbia</option>
                                <option value="PE">ğŸ‡µï¿½ Peru</option>
                                <option value="VE">ğŸ‡»ğŸ‡ª Venezuela</option>
                                <option value="UY">ğŸ‡ºğŸ‡¾ Uruguai</option>
                                <option value="PY">ğŸ‡µğŸ‡¾ Paraguai</option>
                                <option value="BO">ğŸ‡§ğŸ‡´ BolÃ­via</option>
                                <option value="EC">ï¿½ï¿½ Equador</option>
                            </optgroup>
                            <optgroup label="AmÃ©rica do Norte">
                                <option value="US">ğŸ‡ºğŸ‡¸ Estados Unidos</option>
                                <option value="CA">ğŸ‡¨ğŸ‡¦ CanadÃ¡</option>
                                <option value="MX">ğŸ‡²ğŸ‡½ MÃ©xico</option>
                            </optgroup>
                            <optgroup label="Europa">
                                <option value="PT">ğŸ‡µğŸ‡¹ Portugal</option>
                                <option value="ES">ğŸ‡ªğŸ‡¸ Espanha</option>
                                <option value="GB">ğŸ‡¬ğŸ‡§ Reino Unido</option>
                                <option value="FR">ğŸ‡«ğŸ‡· FranÃ§a</option>
                                <option value="DE">ğŸ‡©ğŸ‡ª Alemanha</option>
                                <option value="IT">ğŸ‡®ğŸ‡¹ ItÃ¡lia</option>
                                <option value="NL">ğŸ‡³ğŸ‡± Holanda</option>
                                <option value="BE">ğŸ‡§ğŸ‡ª BÃ©lgica</option>
                                <option value="CH">ğŸ‡¨ğŸ‡­ SuÃ­Ã§a</option>
                                <option value="AT">ğŸ‡¦ğŸ‡¹ Ãustria</option>
                                <option value="PL">ğŸ‡µğŸ‡± PolÃ´nia</option>
                                <option value="SE">ğŸ‡¸ğŸ‡ª SuÃ©cia</option>
                                <option value="NO">ğŸ‡³ğŸ‡´ Noruega</option>
                                <option value="DK">ğŸ‡©ğŸ‡° Dinamarca</option>
                                <option value="FI">ğŸ‡«ğŸ‡® FinlÃ¢ndia</option>
                                <option value="IE">ğŸ‡®ğŸ‡ª Irlanda</option>
                                <option value="GR">ğŸ‡¬ğŸ‡· GrÃ©cia</option>
                                <option value="RU">ğŸ‡·ğŸ‡º RÃºssia</option>
                                <option value="UA">ğŸ‡ºğŸ‡¦ UcrÃ¢nia</option>
                            </optgroup>
                            <optgroup label="Ãsia">
                                <option value="JP">ğŸ‡¯ğŸ‡µ JapÃ£o</option>
                                <option value="KR">ğŸ‡°ğŸ‡· Coreia do Sul</option>
                                <option value="CN">ğŸ‡¨ğŸ‡³ China</option>
                                <option value="IN">ğŸ‡®ğŸ‡³ Ãndia</option>
                                <option value="ID">ğŸ‡®ğŸ‡© IndonÃ©sia</option>
                                <option value="TH">ğŸ‡¹ğŸ‡­ TailÃ¢ndia</option>
                                <option value="VN">ğŸ‡»ğŸ‡³ VietnÃ£</option>
                                <option value="PH">ğŸ‡µğŸ‡­ Filipinas</option>
                                <option value="MY">ğŸ‡²ğŸ‡¾ MalÃ¡sia</option>
                                <option value="SG">ğŸ‡¸ğŸ‡¬ Singapura</option>
                                <option value="IL">ğŸ‡®ğŸ‡± Israel</option>
                                <option value="AE">ğŸ‡¦ğŸ‡ª Emirados Ãrabes</option>
                                <option value="SA">ğŸ‡¸ğŸ‡¦ ArÃ¡bia Saudita</option>
                                <option value="TR">ğŸ‡¹ğŸ‡· Turquia</option>
                            </optgroup>
                            <optgroup label="Oceania">
                                <option value="AU">ğŸ‡¦ğŸ‡º AustrÃ¡lia</option>
                                <option value="NZ">ğŸ‡³ğŸ‡¿ Nova ZelÃ¢ndia</option>
                            </optgroup>
                            <optgroup label="Ãfrica">
                                <option value="ZA">ğŸ‡¿ğŸ‡¦ Ãfrica do Sul</option>
                                <option value="EG">ğŸ‡ªğŸ‡¬ Egito</option>
                                <option value="NG">ğŸ‡³ğŸ‡¬ NigÃ©ria</option>
                                <option value="KE">ğŸ‡°ğŸ‡ª QuÃªnia</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <button onclick="buscarTrends()" class="btn btn-primary" id="btnTrends">
                            <i class="fas fa-sync"></i> Buscar Trends
                        </button>
                    </div>
                </div>
                    <p style="font-size: 12px; color: #718096; margin-bottom: 15px;">
                        <i class="fas fa-info-circle"></i> Clique em qualquer trend para pesquisar e gerar matÃ©rias.
                    </p>
                    
                    <div id="trendsList" class="trends-lista-vertical"></div>
                </div>

                <!-- Sub-tab: Trends Gospel -->
                <div id="trends-gospel" class="sub-tab-content">
                    <p style="font-size: 13px; color: #4a5568; margin-bottom: 15px; background: #f0fdf4; padding: 10px 15px; border-radius: 8px; border-left: 3px solid #22c55e;">
                        <i class="fas fa-church" style="color: #22c55e;"></i> 
                        <strong>NotÃ­cias e termos em alta</strong> relacionados ao universo gospel, evangÃ©lico e cristÃ£o.
                    </p>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button onclick="buscarTrendsGospel()" class="btn btn-primary" id="btnTrendsGospel">
                            <i class="fas fa-sync"></i> Buscar Trends Gospel
                        </button>
                    </div>
                    
                    <div id="trendsGospelList" class="trends-lista-vertical"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de GeraÃ§Ã£o -->
    <div id="modalGeracao" class="modal" style="display: none;">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3><i class="fas fa-magic"></i> Gerando MatÃ©rias</h3>
                <button onclick="fecharModal()" class="btn-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="progressoGeracao"></div>
            </div>
        </div>
    </div>
</div>

<style>
/* Content Header */
.content-header {
    margin-bottom: 24px;
    padding-bottom: 18px;
    border-bottom: 1px solid #E2E8F0;
}

.content-header h1 {
    font-size: 22px;
    font-weight: 600;
    margin-bottom: 5px;
    color: #1A202C;
    display: flex;
    align-items: center;
    gap: 10px;
}

.content-header p {
    color: #718096;
    font-size: 13px;
    margin: 0;
}

/* Card */
.card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    border: 1px solid #E8E8E8;
    margin-bottom: 24px;
}

.card-header {
    padding: 16px 18px;
    border-bottom: 1px solid #E2E8F0;
    background: #FAFBFC;
    border-radius: 12px 12px 0 0;
}

.card-header h3 {
    font-size: 14px;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
    color: #2D3748;
}

.card-body {
    padding: 20px;
}

/* Form */
.form-group {
    margin-bottom: 18px;
}

.form-group label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 500;
    margin-bottom: 7px;
    font-size: 12px;
    color: #2D3748;
}

.form-control {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #E2E8F0;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s;
    box-sizing: border-box;
}

.form-control:focus {
    outline: none;
    border-color: #FF6B00;
    box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.1);
}

/* Tabs */
.tabs-container {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 2px solid #e2e8f0;
    padding-bottom: 0;
}

.tab-btn {
    padding: 12px 20px;
    border: none;
    background: #f7fafc;
    color: #718096;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border-radius: 8px 8px 0 0;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
}

.tab-btn:hover {
    background: #edf2f7;
    color: #4a5568;
}

.tab-btn.active {
    background: #FF6B00;
    color: white;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* Sub-tabs */
.sub-tabs {
    display: flex;
    gap: 8px;
    padding: 4px;
    background: #f1f5f9;
    border-radius: 10px;
    width: fit-content;
}

.sub-tab-btn {
    padding: 8px 16px;
    border: none;
    background: transparent;
    color: #64748b;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
}

.sub-tab-btn:hover {
    background: #e2e8f0;
    color: #475569;
}

.sub-tab-btn.active {
    background: white;
    color: #FF6B00;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.sub-tab-btn i {
    font-size: 12px;
}

.sub-tab-content {
    display: none;
}

.sub-tab-content.active {
    display: block;
}

/* Form Row 3 columns */
.form-row-3 {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 18px;
}

@media (max-width: 768px) {
    .form-row-3 {
        grid-template-columns: 1fr;
    }
}

/* Keywords Container */
.keywords-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.keyword-tag {
    display: inline-flex;
    align-items: center;
    padding: 6px 12px;
    background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%);
    border: 1px solid #c7d2fe;
    border-radius: 20px;
    font-size: 12px;
    color: #4338ca;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
}

.keyword-tag:hover {
    background: linear-gradient(135deg, #4338ca 0%, #6366f1 100%);
    color: white;
    border-color: #4338ca;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(67, 56, 202, 0.3);
}

.btn-outline {
    background: white;
    border: 1px solid #e2e8f0;
    color: #718096;
}

.btn-outline:hover {
    background: #f7fafc;
    border-color: #cbd5e0;
    color: #4a5568;
}

/* Buttons */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 18px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-primary {
    background: linear-gradient(135deg, #FF6B00 0%, #E65100 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
}

.btn-primary:disabled {
    background: #cbd5e0;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.btn-success {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: white;
}

.btn-success:disabled {
    background: #cbd5e0;
    cursor: not-allowed;
}

.btn-secondary {
    background: #edf2f7;
    color: #4a5568;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

/* Resultados */
.resultados-lista {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.resultado-item {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    padding: 15px;
    background: #f8fafc;
    border-radius: 10px;
    border: 2px solid transparent;
    transition: all 0.2s;
    cursor: pointer;
}

.resultado-item:hover {
    background: #edf2f7;
}

.resultado-item.selected {
    border-color: #FF6B00;
    background: #fff5eb;
}

.resultado-checkbox {
    width: 22px;
    height: 22px;
    margin-top: 3px;
    cursor: pointer;
}

.resultado-info {
    flex: 1;
    min-width: 0;
}

.resultado-titulo {
    font-size: 16px;
    font-weight: 600;
    color: #1a202c;
    margin-bottom: 5px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.resultado-titulo a {
    color: inherit;
    text-decoration: none;
}

.resultado-titulo a:hover {
    color: #FF6B00;
}

.resultado-descricao {
    font-size: 14px;
    color: #718096;
    margin-bottom: 8px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.resultado-meta {
    display: flex;
    align-items: center;
    gap: 15px;
    font-size: 12px;
    color: #a0aec0;
}

.resultado-plataforma {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 10px;
    background: #e2e8f0;
    border-radius: 20px;
    font-weight: 500;
}

.resultado-plataforma.instagram { background: #fce7f3; color: #be185d; }
.resultado-plataforma.twitter { background: #dbeafe; color: #1d4ed8; }
.resultado-plataforma.youtube { background: #fee2e2; color: #dc2626; }
.resultado-plataforma.facebook { background: #dbeafe; color: #2563eb; }
.resultado-plataforma.g1 { background: #fef3c7; color: #d97706; }

.resultado-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* Trends - Layout em Lista Vertical */
.trends-lista-vertical {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 600px;
    overflow-y: auto;
}

.trend-item-vertical {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 15px;
    background: #f8fafc;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    border-left: 3px solid transparent;
}

.trend-item-vertical:hover {
    background: #fff5eb;
    border-left-color: #FF6B00;
    transform: translateX(3px);
}

.trend-item-vertical:nth-child(-n+3) {
    background: linear-gradient(135deg, #fff5eb 0%, #fef3c7 100%);
    border-left-color: #f59e0b;
}

.trend-item-vertical:nth-child(-n+3):hover {
    background: linear-gradient(135deg, #ffedd5 0%, #fde68a 100%);
}

.trend-numero-vertical {
    min-width: 28px;
    height: 28px;
    background: #e2e8f0;
    color: #4a5568;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 12px;
}

.trend-item-vertical:nth-child(-n+3) .trend-numero-vertical {
    background: linear-gradient(135deg, #FF6B00, #E65100);
    color: white;
}

.trend-info-vertical {
    flex: 1;
    min-width: 0;
}

.trend-titulo-vertical {
    font-weight: 500;
    color: #1a202c;
    font-size: 14px;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.trend-meta-vertical {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 4px;
}

.trend-trafego-vertical {
    font-size: 11px;
    color: #FF6B00;
    font-weight: 600;
    background: #fff5eb;
    padding: 2px 8px;
    border-radius: 10px;
}

.trend-descricao-vertical {
    font-size: 11px;
    color: #718096;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.trend-action-vertical {
    color: #a0aec0;
    font-size: 14px;
    transition: color 0.2s;
}

.trend-item-vertical:hover .trend-action-vertical {
    color: #FF6B00;
}

/* Scrollbar personalizada para trends */
.trends-lista-vertical::-webkit-scrollbar {
    width: 6px;
}

.trends-lista-vertical::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
}

.trends-lista-vertical::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

.trends-lista-vertical::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* Modal */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: 12px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-lg {
    max-width: 800px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e2e8f0;
}

.modal-header h3 {
    margin: 0;
}

.btn-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #718096;
}

.modal-body {
    padding: 20px;
}

/* Progress Item */
.progress-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: #f8fafc;
    border-radius: 8px;
    margin-bottom: 10px;
}

.progress-item.success {
    background: #d1fae5;
}

.progress-item.error {
    background: #fee2e2;
}

.progress-item.loading {
    background: #fef3c7;
}

.progress-icon {
    font-size: 20px;
}

.progress-text {
    flex: 1;
}

/* Loading */
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #e2e8f0;
    border-top-color: #FF6B00;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 768px) {
    .form-row {
        flex-direction: column;
    }
    
    .tabs-container {
        flex-wrap: wrap;
    }
    
    .trends-lista {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
let resultadosSelecionados = [];

// Alternar tabs
function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
    document.getElementById(`tab-${tab}`).classList.add('active');
    
    if (tab === 'trends') {
        buscarTrends();
    }
}

// Realizar pesquisa no Google
async function realizarPesquisa(event) {
    event.preventDefault();
    
    const termo = document.getElementById('termo').value;
    const plataforma = document.getElementById('plataforma').value;
    const periodo = document.getElementById('periodo').value;
    
    const btn = document.getElementById('btnPesquisar');
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner"></span> Pesquisando...';
    
    try {
        const response = await fetch('/dashboard/ia/google-search/pesquisar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ termo, plataforma, periodo })
        });
        
        const data = await response.json();
        
        if (data.success) {
            exibirResultados(data.resultados, data.googleUrl, data.abrirManualmente);
        } else {
            alert('Erro: ' + data.error);
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao realizar pesquisa');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-search"></i> Pesquisar';
    }
}

// Exibir resultados
function exibirResultados(resultados, googleUrl, abrirManualmente) {
    const container = document.getElementById('listaResultados');
    const card = document.getElementById('resultadosPesquisa');
    
    document.getElementById('totalResultados').textContent = resultados.length;
    resultadosSelecionados = [];
    atualizarContadores();
    
    if (resultados.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #718096;">
                <i class="fas fa-search" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px; display: block;"></i>
                <p style="margin-bottom: 20px;">O Google pode estar bloqueando a pesquisa automÃ¡tica.</p>
                <p style="margin-bottom: 20px;">Clique no botÃ£o abaixo para abrir a pesquisa diretamente no Google:</p>
                <a href="${googleUrl}" target="_blank" class="btn btn-primary" style="text-decoration: none;">
                    <i class="fab fa-google"></i> Abrir no Google
                </a>
            </div>
        `;
    } else {
        container.innerHTML = resultados.map(r => `
            <div class="resultado-item" onclick="toggleResultado(${r.id}, this)" data-id="${r.id}">
                <input type="checkbox" class="resultado-checkbox" id="check-${r.id}" onclick="event.stopPropagation()">
                <div class="resultado-info">
                    <div class="resultado-titulo">
                        <a href="${r.link}" target="_blank" onclick="event.stopPropagation()">${r.titulo}</a>
                    </div>
                    ${r.descricao ? `<div class="resultado-descricao">${r.descricao}</div>` : ''}
                    <div class="resultado-meta">
                        <span class="resultado-plataforma ${r.plataforma}">${getPlataformaIcon(r.plataforma)} ${r.plataforma}</span>
                        ${r.data ? `<span><i class="fas fa-clock"></i> ${r.data}</span>` : ''}
                    </div>
                </div>
                <div class="resultado-actions">
                    <button onclick="event.stopPropagation(); gerarMateriaUnica('${encodeURIComponent(r.link)}', '${encodeURIComponent(r.titulo)}')" class="btn btn-sm btn-primary">
                        <i class="fas fa-magic"></i> Gerar
                    </button>
                </div>
            </div>
        `).join('');
        
        // Guardar dados dos resultados
        window.resultadosData = resultados;
    }
    
    card.style.display = 'block';
}

// Toggle seleÃ§Ã£o de resultado
function toggleResultado(id, element) {
    const checkbox = document.getElementById(`check-${id}`);
    checkbox.checked = !checkbox.checked;
    element.classList.toggle('selected', checkbox.checked);
    
    if (checkbox.checked) {
        const resultado = window.resultadosData.find(r => r.id === id);
        if (resultado && !resultadosSelecionados.find(r => r.id === id)) {
            resultadosSelecionados.push(resultado);
        }
    } else {
        resultadosSelecionados = resultadosSelecionados.filter(r => r.id !== id);
    }
    
    atualizarContadores();
}

// Atualizar contadores
function atualizarContadores() {
    const count = resultadosSelecionados.length;
    document.getElementById('selecionadosCount').textContent = count + ' selecionados';
    document.getElementById('btnGerarCount').textContent = count;
    document.getElementById('btnGerarMaterias').disabled = count === 0;
}

// Ãcone da plataforma
function getPlataformaIcon(plataforma) {
    const icons = {
        instagram: 'ğŸ“¸',
        twitter: 'ğŸ¦',
        youtube: 'â–¶ï¸',
        facebook: 'ğŸ“˜',
        tiktok: 'ğŸµ',
        g1: 'ğŸ“°',
        uol: 'ğŸ“°',
        gospelprime: 'â›ª',
        gospelmais: 'â›ª',
        pleno: 'â›ª',
        web: 'ğŸŒ'
    };
    return icons[plataforma] || 'ğŸŒ';
}

// Gerar matÃ©ria Ãºnica
async function gerarMateriaUnica(urlEncoded, tituloEncoded) {
    const url = decodeURIComponent(urlEncoded);
    const titulo = decodeURIComponent(tituloEncoded);
    const categoria = document.getElementById('categoriaMateria').value;
    
    if (!confirm(`Gerar matÃ©ria para:\n"${titulo}"?`)) return;
    
    document.getElementById('modalGeracao').style.display = 'flex';
    document.getElementById('progressoGeracao').innerHTML = `
        <div class="progress-item loading">
            <span class="loading-spinner"></span>
            <span class="progress-text">Extraindo conteÃºdo de ${url}...</span>
        </div>
    `;
    
    try {
        // 1. Extrair conteÃºdo
        const extractRes = await fetch('/dashboard/ia/google-search/extrair', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url, titulo })
        });
        
        const extractData = await extractRes.json();
        
        if (!extractData.success) {
            throw new Error(extractData.error);
        }
        
        document.getElementById('progressoGeracao').innerHTML += `
            <div class="progress-item success">
                <span class="progress-icon">âœ…</span>
                <span class="progress-text">ConteÃºdo extraÃ­do (${extractData.conteudo.length} caracteres)</span>
            </div>
            <div class="progress-item loading">
                <span class="loading-spinner"></span>
                <span class="progress-text">Gerando matÃ©ria com IA...</span>
            </div>
        `;
        
        // 2. Gerar matÃ©ria
        const genRes = await fetch('/dashboard/ia/google-search/gerar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                titulo: extractData.titulo,
                conteudo: extractData.conteudo,
                url: extractData.url,
                imagem: extractData.imagem,
                categoria
            })
        });
        
        const genData = await genRes.json();
        
        if (genData.success) {
            document.getElementById('progressoGeracao').innerHTML += `
                <div class="progress-item success">
                    <span class="progress-icon">âœ…</span>
                    <span class="progress-text">MatÃ©ria gerada com sucesso!</span>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <a href="/dashboard/posts/${genData.materia.id}/editar" class="btn btn-primary">
                        <i class="fas fa-edit"></i> Editar MatÃ©ria
                    </a>
                    <button onclick="fecharModal()" class="btn btn-secondary">Fechar</button>
                </div>
            `;
        } else {
            throw new Error(genData.error);
        }
        
    } catch (error) {
        document.getElementById('progressoGeracao').innerHTML += `
            <div class="progress-item error">
                <span class="progress-icon">âŒ</span>
                <span class="progress-text">Erro: ${error.message}</span>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button onclick="fecharModal()" class="btn btn-secondary">Fechar</button>
            </div>
        `;
    }
}

// Gerar matÃ©rias selecionadas
async function gerarMateriasSelecionadas() {
    if (resultadosSelecionados.length === 0) return;
    
    if (!confirm(`Gerar ${resultadosSelecionados.length} matÃ©rias?`)) return;
    
    document.getElementById('modalGeracao').style.display = 'flex';
    const progressContainer = document.getElementById('progressoGeracao');
    progressContainer.innerHTML = '';
    
    const categoria = document.getElementById('categoriaMateria').value;
    let sucessos = 0;
    let erros = 0;
    
    for (let i = 0; i < resultadosSelecionados.length; i++) {
        const resultado = resultadosSelecionados[i];
        const itemId = `progress-${i}`;
        
        progressContainer.innerHTML += `
            <div id="${itemId}" class="progress-item loading">
                <span class="loading-spinner"></span>
                <span class="progress-text">[${i+1}/${resultadosSelecionados.length}] ${resultado.titulo.substring(0, 50)}...</span>
            </div>
        `;
        
        try {
            // Extrair e gerar
            const extractRes = await fetch('/dashboard/ia/google-search/extrair', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: resultado.link, titulo: resultado.titulo })
            });
            
            const extractData = await extractRes.json();
            
            if (extractData.success) {
                const genRes = await fetch('/dashboard/ia/google-search/gerar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        titulo: extractData.titulo,
                        conteudo: extractData.conteudo,
                        url: extractData.url,
                        imagem: extractData.imagem,
                        categoria
                    })
                });
                
                const genData = await genRes.json();
                
                if (genData.success) {
                    document.getElementById(itemId).className = 'progress-item success';
                    document.getElementById(itemId).innerHTML = `
                        <span class="progress-icon">âœ…</span>
                        <span class="progress-text">[${i+1}/${resultadosSelecionados.length}] ${resultado.titulo.substring(0, 50)}...</span>
                    `;
                    sucessos++;
                } else {
                    throw new Error(genData.error);
                }
            } else {
                throw new Error(extractData.error);
            }
        } catch (error) {
            document.getElementById(itemId).className = 'progress-item error';
            document.getElementById(itemId).innerHTML = `
                <span class="progress-icon">âŒ</span>
                <span class="progress-text">[${i+1}/${resultadosSelecionados.length}] Erro: ${error.message}</span>
            `;
            erros++;
        }
        
        // Pequeno delay entre requisiÃ§Ãµes
        await new Promise(r => setTimeout(r, 1000));
    }
    
    progressContainer.innerHTML += `
        <div style="margin-top: 20px; padding: 15px; background: #f0fdf4; border-radius: 8px; text-align: center;">
            <p><strong>ConcluÃ­do!</strong></p>
            <p>âœ… ${sucessos} matÃ©rias geradas | âŒ ${erros} erros</p>
            <a href="/dashboard/posts" class="btn btn-primary" style="margin-top: 10px;">
                <i class="fas fa-list"></i> Ver MatÃ©rias
            </a>
            <button onclick="fecharModal()" class="btn btn-secondary" style="margin-top: 10px;">Fechar</button>
        </div>
    `;
}

// Switch sub-tabs de Trends
function switchTrendsTab(tab) {
    // Atualizar botÃµes
    document.getElementById('subTabGeral').classList.toggle('active', tab === 'geral');
    document.getElementById('subTabGospel').classList.toggle('active', tab === 'gospel');
    
    // Atualizar conteÃºdo
    document.getElementById('trends-geral').classList.toggle('active', tab === 'geral');
    document.getElementById('trends-gospel').classList.toggle('active', tab === 'gospel');
    
    // Carregar trends gospel automaticamente na primeira vez
    if (tab === 'gospel' && document.getElementById('trendsGospelList').innerHTML === '') {
        buscarTrendsGospel();
    }
}

// Buscar Trends Gospel (notÃ­cias e termos do nicho)
async function buscarTrendsGospel() {
    const btn = document.getElementById('btnTrendsGospel');
    const container = document.getElementById('trendsGospelList');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner"></span> Buscando...';
    container.innerHTML = '<div style="text-align: center; padding: 40px;"><span class="loading-spinner"></span><p style="margin-top: 10px; color: #718096;">Buscando notÃ­cias gospel em alta...</p></div>';
    
    try {
        // Buscar notÃ­cias gospel do Google News
        const response = await fetch('/dashboard/ia/google-search/trends-gospel', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (data.success && data.trends.length > 0) {
            container.innerHTML = data.trends.map((t, i) => `
                <div class="trend-item-vertical" onclick="pesquisarTrend('${encodeURIComponent(t.titulo)}')">
                    <div class="trend-numero-vertical">${i + 1}</div>
                    <div class="trend-info-vertical">
                        <div class="trend-titulo-vertical">${t.titulo}</div>
                        <div class="trend-meta-vertical">
                            ${t.fonte ? `<span class="trend-trafego-vertical">ğŸ“° ${t.fonte}</span>` : '<span class="trend-trafego-vertical">â›ª Gospel</span>'}
                            ${t.data ? `<span class="trend-descricao-vertical">${t.data}</span>` : ''}
                        </div>
                    </div>
                    <i class="fas fa-arrow-right trend-action-vertical"></i>
                </div>
            `).join('');
        } else {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #718096;">
                    <i class="fas fa-church" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px; display: block;"></i>
                    <p>NÃ£o foi possÃ­vel carregar notÃ­cias gospel.</p>
                    <p style="font-size: 12px;">Tente novamente em alguns segundos.</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Erro:', error);
        container.innerHTML = '<p style="color: red; text-align: center;">Erro ao buscar trends gospel. Tente novamente.</p>';
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sync"></i> Buscar Trends Gospel';
    }
}

// Buscar Google Trends
async function buscarTrends() {
    const btn = document.getElementById('btnTrends');
    const container = document.getElementById('trendsList');
    const regiao = document.getElementById('trendsRegiao').value;
    
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner"></span> Buscando...';
    container.innerHTML = '<div style="text-align: center; padding: 40px;"><span class="loading-spinner"></span></div>';
    
    try {
        const response = await fetch('/dashboard/ia/google-search/trends', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ regiao })
        });
        
        const data = await response.json();
        
        if (data.success && data.trends.length > 0) {
            container.innerHTML = data.trends.map((t, i) => `
                <div class="trend-item-vertical" onclick="pesquisarTrend('${encodeURIComponent(t.titulo)}')">
                    <div class="trend-numero-vertical">${i + 1}</div>
                    <div class="trend-info-vertical">
                        <div class="trend-titulo-vertical">${t.titulo}</div>
                        <div class="trend-meta-vertical">
                            ${t.trafego ? `<span class="trend-trafego-vertical">ğŸ”¥ ${t.trafego}</span>` : '<span class="trend-trafego-vertical">ğŸ”¥ Em alta</span>'}
                            ${t.descricao ? `<span class="trend-descricao-vertical">${t.descricao}</span>` : ''}
                        </div>
                    </div>
                    <i class="fas fa-arrow-right trend-action-vertical"></i>
                </div>
            `).join('');
        } else {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #718096;">
                    <i class="fas fa-chart-line" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px; display: block;"></i>
                    <p>NÃ£o foi possÃ­vel carregar os trends para esta regiÃ£o.</p>
                    <p style="font-size: 12px;">Tente outra regiÃ£o ou aguarde alguns segundos.</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Erro:', error);
        container.innerHTML = '<p style="color: red; text-align: center;">Erro ao buscar trends. Tente novamente.</p>';
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sync"></i> Buscar Trends';
    }
}

// Usar palavra-chave sugerida
function usarPalavraChave(palavra) {
    document.getElementById('termo').value = palavra;
    document.getElementById('termo').focus();
}

// Carregar palavras-chave do Google
async function carregarPalavrasChaveGoogle() {
    const container = document.getElementById('palavrasChave');
    const btn = document.getElementById('btnAtualizarPalavras');
    const fonteEl = document.getElementById('fontePalavras');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner" style="width: 12px; height: 12px;"></span>';
    container.innerHTML = `
        <div style="text-align: center; padding: 20px; color: #718096;">
            <span class="loading-spinner"></span>
            <p style="margin-top: 10px; font-size: 12px;">Buscando palavras-chave em alta no Google...</p>
        </div>
    `;
    
    try {
        const response = await fetch('/dashboard/ia/google-search/palavras-chave', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tema: 'gospel' })
        });
        
        const data = await response.json();
        
        if (data.success && data.palavrasChave.length > 0) {
            container.innerHTML = data.palavrasChave.map(p => 
                `<span class="keyword-tag" onclick="usarPalavraChave('${p.replace(/'/g, "\\'")}')">${p}</span>`
            ).join('');
            fonteEl.innerHTML = `<i class="fas fa-info-circle"></i> ${data.total} termos encontrados via ${data.fonte}`;
        } else {
            container.innerHTML = `
                <div style="text-align: center; padding: 15px; color: #718096;">
                    <i class="fas fa-exclamation-circle" style="font-size: 24px; opacity: 0.5;"></i>
                    <p style="margin-top: 8px; font-size: 12px;">NÃ£o foi possÃ­vel carregar palavras-chave. Clique em Atualizar.</p>
                </div>
            `;
            fonteEl.innerHTML = '';
        }
    } catch (error) {
        console.error('Erro:', error);
        container.innerHTML = `
            <div style="text-align: center; padding: 15px; color: #e53e3e;">
                <i class="fas fa-times-circle" style="font-size: 24px;"></i>
                <p style="margin-top: 8px; font-size: 12px;">Erro ao buscar palavras-chave. Tente novamente.</p>
            </div>
        `;
        fonteEl.innerHTML = '';
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sync-alt"></i> Atualizar';
    }
}

// Carregar palavras-chave ao abrir a pÃ¡gina
document.addEventListener('DOMContentLoaded', function() {
    carregarPalavrasChaveGoogle();
});

// Pesquisar trend
function pesquisarTrend(termoEncoded) {
    const termo = decodeURIComponent(termoEncoded);
    document.getElementById('termo').value = termo;
    switchTab('pesquisa');
    document.getElementById('formPesquisa').dispatchEvent(new Event('submit'));
}

// Fechar modal
function fecharModal() {
    document.getElementById('modalGeracao').style.display = 'none';
}

// Fechar modal ao clicar fora
document.getElementById('modalGeracao')?.addEventListener('click', function(e) {
    if (e.target === this) fecharModal();
});
</script>

<%- include('../partials/footer') %>
