<%- include('../partials/header', { title: 'Categorias', user: user }) %>

<div class="dashboard-content">
    <div class="content-header">
        <div>
            <h1>Categorias</h1>
            <p>Gerencie as categorias do portal gospel</p>
        </div>
        <button onclick="openModal()" class="btn btn-primary">
            <i class="fas fa-plus"></i> Nova Categoria
        </button>
    </div>

    <% if (typeof success !== 'undefined' && success) { %>
    <div class="alert alert-success">
        <%= success %>
    </div>
    <% } %>

    <div class="card">
        <div class="card-header">
            <div class="search-filter">
                <input type="text" id="searchCategories" placeholder="Buscar categorias..." class="search-input">
            </div>
        </div>

        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 40px;"><i class="fas fa-grip-vertical" title="Arraste para reordenar"></i></th>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>Slug</th>
                        <th>Cor</th>
                        <th>Ícone</th>
                        <th>Descrição</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="categoriesTable">
                    <% if (categories && categories.length > 0) { %>
                        <% categories.forEach(category => { %>
                        <tr data-category-id="<%= category.id %>" class="sortable-row">
                            <td class="drag-handle" style="cursor: move;">
                                <i class="fas fa-grip-vertical" style="color: #CBD5E0;"></i>
                            </td>
                            <td><%= category.id %></td>
                            <td>
                                <div class="category-name">
                                    <span class="category-badge" style="background-color: <%= category.cor %>"></span>
                                    <%= category.nome %>
                                </div>
                            </td>
                            <td><code><%= category.slug %></code></td>
                            <td>
                                <div class="color-preview">
                                    <span class="color-box" style="background-color: <%= category.cor %>"></span>
                                    <%= category.cor %>
                                </div>
                            </td>
                            <td>
                                <% if (category.icone) { %>
                                    <i class="fas fa-<%= category.icone %>"></i> <%= category.icone %>
                                <% } else { %>
                                    <span class="text-muted">-</span>
                                <% } %>
                            </td>
                            <td class="description-cell"><%= category.descricao || '-' %></td>
                            <td>
                                <div class="action-buttons">
                                    <button onclick='editCategory(<%= JSON.stringify(category) %>)' class="btn-icon" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteCategory(<%= category.id %>, '<%= category.nome %>')" class="btn-icon btn-danger" title="Deletar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="8" class="text-center">Nenhuma categoria encontrada</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal para Adicionar/Editar Categoria -->
<div id="categoryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Nova Categoria</h2>
            <button onclick="closeModal()" class="modal-close">&times;</button>
        </div>
        <form id="categoryForm" onsubmit="saveCategory(event)">
            <input type="hidden" id="categoryId">
            
            <div class="form-group">
                <label for="nome">Nome *</label>
                <input type="text" id="nome" name="nome" required class="form-control" placeholder="Ex: Notícias">
            </div>

            <div class="form-group">
                <label for="slug">Slug *</label>
                <input type="text" id="slug" name="slug" required class="form-control" placeholder="Ex: noticias">
                <small>URL amigável (apenas letras minúsculas, números e hífens)</small>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="cor">Cor *</label>
                    <div class="color-input-group">
                        <input type="color" id="cor" name="cor" required class="form-control-color">
                        <input type="text" id="corText" class="form-control" placeholder="#3B82F6" pattern="^#[0-9A-Fa-f]{6}$">
                    </div>
                </div>

                <div class="form-group">
                    <label for="icone">Ícone (Font Awesome)</label>
                    <input type="text" id="icone" name="icone" class="form-control" placeholder="Ex: newspaper">
                    <small>Nome do ícone sem "fa-" (ex: newspaper, music, church)</small>
                </div>
            </div>

            <div class="form-group">
                <label for="descricao">Descrição</label>
                <textarea id="descricao" name="descricao" class="form-control" rows="3" placeholder="Breve descrição da categoria"></textarea>
            </div>

            <div class="modal-footer">
                <button type="button" onclick="closeModal()" class="btn btn-secondary">Cancelar</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    .content-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
        padding-bottom: 18px;
        border-bottom: 1px solid #E2E8F0;
    }

    .content-header h1 {
        font-size: 22px;
        font-weight: 600;
        margin-bottom: 5px;
        color: #1A202C;
        letter-spacing: -0.5px;
    }

    .content-header p {
        color: #718096;
        font-size: 13px;
        margin: 0;
    }

    .btn {
        padding: 9px 16px;
        border-radius: 8px;
        font-weight: 500;
        font-size: 13px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 7px;
        transition: all 0.15s;
        border: none;
        cursor: pointer;
        letter-spacing: 0.2px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #FF6B00 0%, #FF8533 100%);
        color: white;
        box-shadow: 0 2px 6px rgba(255, 107, 0, 0.2);
    }

    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(255, 107, 0, 0.3);
    }

    .btn-secondary {
        background: #EDF2F7;
        color: #2D3748;
    }

    .btn-secondary:hover {
        background: #E2E8F0;
    }

    .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.06);
        border: 1px solid #E8E8E8;
        overflow: hidden;
    }

    .card-header {
        padding: 16px 18px;
        border-bottom: 1px solid #E2E8F0;
        background: #FAFBFC;
    }

    .search-filter {
        display: flex;
        gap: 10px;
    }

    .search-input {
        padding: 8px 12px;
        border: 1px solid #E2E8F0;
        border-radius: 8px;
        font-size: 13px;
        flex: 1;
        transition: all 0.15s;
        background: white;
    }

    .search-input:focus {
        outline: none;
        border-color: #FF6B00;
        box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.06);
    }

    .table-responsive {
        overflow-x: auto;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th {
        padding: 12px 14px;
        text-align: left;
        font-weight: 500;
        font-size: 11px;
        color: #4A5568;
        text-transform: uppercase;
        letter-spacing: 0.6px;
        background: #F7FAFC;
        border-bottom: 1px solid #E2E8F0;
    }

    .data-table td {
        padding: 12px 14px;
        border-bottom: 1px solid #E2E8F0;
        font-size: 13px;
        color: #2D3748;
    }

    .data-table tr:hover {
        background: #F7FAFC;
    }

    .sortable-row {
        transition: background-color 0.2s;
    }

    .sortable-row.sortable-ghost {
        opacity: 0.4;
        background: #EDF2F7;
    }

    .sortable-row.sortable-drag {
        background: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .drag-handle {
        cursor: move !important;
        user-select: none;
    }

    .drag-handle:hover i {
        color: #FF6B00 !important;
    }

    .category-name {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        font-size: 13px;
    }

    .category-badge {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
    }

    .color-preview {
        display: flex;
        align-items: center;
        gap: 7px;
        font-size: 12px;
    }

    .color-box {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 1px solid #E2E8F0;
        display: inline-block;
    }

    .description-cell {
        max-width: 280px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 12px;
        color: #718096;
    }

    .action-buttons {
        display: flex;
        gap: 6px;
    }

    .btn-icon {
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        background: #F7FAFC;
        color: #718096;
        border: none;
        cursor: pointer;
        transition: all 0.15s;
        font-size: 13px;
    }

    .btn-icon:hover {
        background: #EDF2F7;
        color: #2D3748;
        transform: scale(1.05);
    }

    .btn-icon.btn-danger:hover {
        background: #FEE2E2;
        color: #DC2626;
    }

    .alert {
        padding: 12px 14px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 13px;
    }

    .alert-success {
        background: #D1FAE5;
        color: #065F46;
        border: 1px solid #A7F3D0;
    }

    .text-center {
        text-align: center;
        padding: 32px !important;
        color: #9CA3AF;
        font-size: 13px;
    }

    .text-muted {
        color: #9CA3AF;
        font-size: 12px;
    }

    code {
        background: #F7FAFC;
        padding: 3px 7px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        color: #2D3748;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        animation: fadeIn 0.2s;
    }

    .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        animation: slideUp 0.3s;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px;
        border-bottom: 1px solid #E0E0E0;
    }

    .modal-header h2 {
        font-size: 24px;
        font-weight: 700;
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 32px;
        color: #999;
        cursor: pointer;
        line-height: 1;
        padding: 0;
        width: 32px;
        height: 32px;
    }

    .modal-close:hover {
        color: #333;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding: 20px 24px;
        border-top: 1px solid #E0E0E0;
        background: #F9FAFB;
    }

    form {
        padding: 24px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .form-control {
        width: 100%;
        padding: 10px 14px;
        border: 2px solid #E0E0E0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.2s;
    }

    .form-control:focus {
        outline: none;
        border-color: #FF6B00;
    }

    .form-control-color {
        width: 60px;
        height: 42px;
        border: 2px solid #E0E0E0;
        border-radius: 8px;
        cursor: pointer;
    }

    .color-input-group {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .color-input-group .form-control {
        flex: 1;
    }

    textarea.form-control {
        resize: vertical;
        font-family: inherit;
    }

    small {
        display: block;
        margin-top: 4px;
        color: #718096;
        font-size: 11px;
    }

    @media (max-width: 1024px) {
        .content-header {
            flex-direction: column;
            gap: 14px;
        }
        .form-row {
            grid-template-columns: 1fr;
        }
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
</style>

<script>
    // Busca de categorias
    document.getElementById('searchCategories').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#categoriesTable tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    });

    // Abrir modal
    function openModal() {
        document.getElementById('categoryModal').classList.add('active');
        document.getElementById('modalTitle').textContent = 'Nova Categoria';
        document.getElementById('categoryForm').reset();
        document.getElementById('categoryId').value = '';
    }

    // Fechar modal
    function closeModal() {
        document.getElementById('categoryModal').classList.remove('active');
    }

    // Fechar modal ao clicar fora
    window.onclick = function(event) {
        const modal = document.getElementById('categoryModal');
        if (event.target === modal) {
            closeModal();
        }
    }

    // Sincronizar color picker com input de texto
    document.getElementById('cor').addEventListener('input', function(e) {
        document.getElementById('corText').value = e.target.value.toUpperCase();
    });

    document.getElementById('corText').addEventListener('input', function(e) {
        const color = e.target.value;
        if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
            document.getElementById('cor').value = color;
        }
    });

    // Auto-gerar slug a partir do nome
    document.getElementById('nome').addEventListener('input', function(e) {
        if (!document.getElementById('categoryId').value) {
            const slug = e.target.value
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/(^-|-$)/g, '');
            document.getElementById('slug').value = slug;
        }
    });

    // Editar categoria
    function editCategory(category) {
        document.getElementById('categoryModal').classList.add('active');
        document.getElementById('modalTitle').textContent = 'Editar Categoria';
        document.getElementById('categoryId').value = category.id;
        document.getElementById('nome').value = category.nome;
        document.getElementById('slug').value = category.slug;
        document.getElementById('cor').value = category.cor;
        document.getElementById('corText').value = category.cor;
        document.getElementById('icone').value = category.icone || '';
        document.getElementById('descricao').value = category.descricao || '';
    }

    // Salvar categoria
    async function saveCategory(event) {
        event.preventDefault();
        
        const id = document.getElementById('categoryId').value;
        const data = {
            nome: document.getElementById('nome').value,
            slug: document.getElementById('slug').value,
            cor: document.getElementById('cor').value,
            icone: document.getElementById('icone').value,
            descricao: document.getElementById('descricao').value
        };

        try {
            const url = id ? `/api/categorias/${id}` : '/api/categorias';
            const method = id ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                window.location.href = '/dashboard/categorias?success=' + encodeURIComponent(result.message);
            } else {
                alert('Erro: ' + result.message);
            }
        } catch (error) {
            console.error('Erro ao salvar categoria:', error);
            alert('Erro ao salvar categoria');
        }
    }

    // Deletar categoria
    async function deleteCategory(id, nome) {
        if (!confirm(`Tem certeza que deseja deletar a categoria "${nome}"?\n\nAtenção: Posts associados a esta categoria podem ser afetados.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/categorias/${id}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (result.success) {
                window.location.href = '/dashboard/categorias?success=' + encodeURIComponent(result.message);
            } else {
                alert('Erro: ' + result.message);
            }
        } catch (error) {
            console.error('Erro ao deletar categoria:', error);
            alert('Erro ao deletar categoria');
        }
    }
    // Inicializar SortableJS para drag and drop
    document.addEventListener('DOMContentLoaded', function() {
        const tbody = document.getElementById('categoriesTable');
        
        if (tbody && typeof Sortable !== 'undefined') {
            new Sortable(tbody, {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                onEnd: async function(evt) {
                    // Coletar nova ordem
                    const rows = tbody.querySelectorAll('tr[data-category-id]');
                    const categories = Array.from(rows).map(row => ({
                        id: parseInt(row.dataset.categoryId)
                    }));
                    
                    try {
                        const response = await fetch('/api/categorias/reorder', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ categories })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            // Mostrar feedback visual
                            const alert = document.createElement('div');
                            alert.className = 'alert alert-success';
                            alert.style.position = 'fixed';
                            alert.style.top = '20px';
                            alert.style.right = '20px';
                            alert.style.zIndex = '9999';
                            alert.textContent = '✓ Ordem atualizada com sucesso!';
                            document.body.appendChild(alert);
                            
                            setTimeout(() => {
                                alert.remove();
                            }, 3000);
                        } else {
                            alert('Erro ao atualizar ordem: ' + result.message);
                            location.reload();
                        }
                    } catch (error) {
                        console.error('Erro ao reordenar:', error);
                        alert('Erro ao atualizar ordem');
                        location.reload();
                    }
                }
            });
        }
    });
</script>

<!-- SortableJS CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<%- include('../partials/footer') %>
