<%- include('partials/header') %>

    <main class="main-content">
        <div class="container">
            <!-- Hero Section - Notícia em Destaque -->
            <% if (destaque) { %>
                <section class="hero-section">
                    <a href="/<%= destaque.categoria %>/<%= destaque.urlAmigavel %>" class="hero-card">
                        <div class="hero-image">
                            <img src="<%= destaque.imagem %>" alt="<%= destaque.titulo %>" fetchpriority="high"
                                width="1200" height="630">
                            <div class="hero-overlay">
                                <% // Criar mapa de nomes de categorias a partir das categorias carregadas const
                                    categoryNames={}; if (typeof categories !=='undefined' && categories) {
                                    categories.forEach(cat=> {
                                    categoryNames[cat.slug] = cat.nome;
                                    });
                                    }
                                    %>
                                    <span class="hero-category <%= destaque.categoria %>">
                                        <%= categoryNames[destaque.categoria] || destaque.categoria %>
                                    </span>
                                    <h1 class="hero-title">
                                        <%= destaque.titulo %>
                                    </h1>
                                    <p class="hero-description">
                                        <%= destaque.descricao %>
                                    </p>
                            </div>
                        </div>
                    </a>
                </section>
                <% } %>

                    <!-- Layout com Sidebar -->
                    <div class="content-with-sidebar">
                        <!-- Coluna Principal de Notícias -->
                        <div class="main-news-column">
                            <!-- Todas as Notícias -->
                            <section class="news-section all-news-section">
                                <div class="news-list" id="newsList">
                                    <% 
                                    // Criar mapa de categorias para lookup rápido
                                    const catMap = {};
                                    if (typeof categories !== 'undefined' && categories) {
                                        categories.forEach(cat => {
                                            catMap[cat.slug] = { nome: cat.nome, cor: cat.cor };
                                        });
                                    }
                                    
                                    // Combinar todos os artigos de TODAS as categorias do banco
                                    let allArticles = [];
                                    
                                    if (typeof articlesByCategory !== 'undefined' && articlesByCategory) {
                                        // Usar articlesByCategory que vem do banco
                                        Object.keys(articlesByCategory).forEach(slug => {
                                            const articles = articlesByCategory[slug];
                                            if (articles && articles.length > 0) {
                                                articles.forEach(a => {
                                                    a.categoryName = catMap[slug] ? catMap[slug].nome : slug;
                                                    a.categoryColor = catMap[slug] ? catMap[slug].cor : '#3b82f6';
                                                    a.categoryClass = slug;
                                                    allArticles.push(a);
                                                });
                                            }
                                        });
                                    }

                                    // Filtrar notícia em destaque para não duplicar
                                    if (destaque) {
                                        allArticles = allArticles.filter(a => a.id !== destaque.id);
                                    }

                                    // Ordenar por data (mais recentes primeiro)
                                    allArticles.sort((a, b) => new Date(b.dataPublicacao) - new Date(a.dataPublicacao));

                                    // Mostrar apenas os primeiros 10
                                    const displayArticles = allArticles.slice(0, 10);

                                    if (displayArticles.length === 0) { %>
                                        <div style="padding: 40px; text-align: center; color: #666;">
                                            <i class="fas fa-newspaper"
                                                style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;"></i>
                                            <p style="font-size: 18px;">Nenhuma notícia disponível no momento.</p>
                                            <p style="font-size: 14px; margin-top: 10px;">Em breve teremos novidades!
                                            </p>
                                        </div>
                                        <% } else { displayArticles.forEach(article=> { %>
                                            <article class="news-item-horizontal">
                                                <a href="/<%= article.categoria %>/<%= article.urlAmigavel %>">
                                                    <div class="news-item-image">
                                                        <img src="<%= article.imagem %>" alt="<%= article.titulo %>"
                                                            loading="lazy" width="280" height="180">
                                                    </div>
                                                    <div class="news-item-content">
                                                        <span class="news-item-category <%= article.categoryClass %>">
                                                            <%= article.subcategoria || article.categoryName %>
                                                        </span>
                                                        <h3 class="news-item-title">
                                                            <%= article.titulo %>
                                                        </h3>
                                                        <p class="news-item-description">
                                                            <%= article.descricao %>
                                                        </p>
                                                        <div class="news-item-meta">
                                                            <span class="news-date">
                                                                <%= new
                                                                    Date(article.dataPublicacao).toLocaleDateString('pt-BR')
                                                                    %>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </a>
                                            </article>
                                            <% }); } %>
                                </div>
                                <div id="loadingIndicator" style="display: none; text-align: center; padding: 20px;">
                                    <i class="fas fa-spinner fa-spin"
                                        style="font-size: 24px; color: var(--color-primary);"></i>
                                    <p style="margin-top: 10px; color: var(--color-text-light);">Carregando mais
                                        notícias...</p>
                                </div>
                            </section>

                            <!-- Script para scroll infinito -->
                            <script>
                                let allArticlesData = <%- JSON.stringify(allArticles) %>;
                                let currentIndex = 10;
                                let isLoading = false;

                                window.addEventListener('scroll', function () {
                                    if (isLoading || currentIndex >= allArticlesData.length) return;

                                    const scrollPosition = window.innerHeight + window.scrollY;
                                    const threshold = document.documentElement.scrollHeight - 500;

                                    if (scrollPosition >= threshold) {
                                        isLoading = true;
                                        document.getElementById('loadingIndicator').style.display = 'block';

                                        setTimeout(() => {
                                            const newsList = document.getElementById('newsList');
                                            const nextArticles = allArticlesData.slice(currentIndex, currentIndex + 10);

                                            nextArticles.forEach(article => {
                                                const articleHTML = `
                                        <article class="news-item-horizontal">
                                            <a href="/${article.categoria}/${article.urlAmigavel}">
                                                <div class="news-item-image">
                                                    <img src="${article.imagem}" alt="${article.titulo}">
                                                </div>
                                                <div class="news-item-content">
                                                    <span class="news-item-category ${article.categoryClass}">${article.subcategoria || article.categoryName}</span>
                                                    <h3 class="news-item-title">${article.titulo}</h3>
                                                    <p class="news-item-description">${article.descricao}</p>
                                                    <div class="news-item-meta">
                                                        <span class="news-date">${new Date(article.dataPublicacao).toLocaleDateString('pt-BR')}</span>
                                                    </div>
                                                </div>
                                            </a>
                                        </article>
                                    `;
                                                newsList.insertAdjacentHTML('beforeend', articleHTML);
                                            });

                                            currentIndex += 10;
                                            isLoading = false;
                                            document.getElementById('loadingIndicator').style.display = 'none';
                                        }, 500);
                                    }
                                });
                            </script>
                        </div>

                        <!-- Sidebar -->
                        <aside class="sidebar">
                            <!-- Mais Lidas da Semana -->
                            <section class="sidebar-section most-read-section">
                                <div class="section-header">
                                    <h2 class="section-title most-read-title">
                                        <i class="fas fa-fire"></i> Mais Lidas da Semana
                                    </h2>
                                </div>
                                <div class="most-read-list">
                                    <% 
                                    // Usar allArticles que já foi montado acima
                                    // Ordenar por visualizações e pegar top 5
                                    const mostRead = [...allArticles].sort((a, b) => (b.visualizacoes || 0) - (a.visualizacoes || 0)).slice(0, 5);

                                    mostRead.forEach((article, index) => { %>
                                        <article class="most-read-item">
                                            <a href="/<%= article.categoria %>/<%= article.urlAmigavel %>">
                                                <span class="most-read-number">
                                                    <%= index + 1 %>
                                                </span>
                                                <div class="most-read-content">
                                                    <h3 class="most-read-title">
                                                        <%= article.titulo %>
                                                    </h3>
                                                    <div class="most-read-meta">
                                                        <span class="most-read-category <%= article.categoria %>">
                                                            <%= article.categoryName || article.categoria %>
                                                        </span>
                                                        <span class="most-read-views">
                                                            <i class="fas fa-eye"></i>
                                                            <%= article.visualizacoes || 0 %>
                                                        </span>
                                                    </div>
                                                </div>
                                            </a>
                                        </article>
                                        <% }); %>
                                </div>
                            </section>
                        </aside>
                    </div>
        </div>
    </main>

    <%- include('partials/footer') %>